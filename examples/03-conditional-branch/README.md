# 场景 03: 条件分支审批流程

## 场景描述

这是一个条件分支审批流程示例,模拟费用报销场景.根据报销金额大小选择不同的审批路径.

**业务背景**: 员工提交费用报销申请,系统根据报销金额自动选择不同的审批路径:
- 金额 < 1000 元: 只需要部门经理审批
- 金额 >= 1000 元且 < 5000 元: 需要部门经理审批 → 财务审批
- 金额 >= 5000 元: 需要部门经理审批 → 财务审批 → 总经理审批

## 流程结构

```
开始节点
  ↓
条件节点1(金额 < 1000?)
  ├─→ [True] 部门经理审批(低额) → 结束节点
  └─→ [False] 条件节点2(金额 < 5000?)
      ├─→ [True] 部门经理审批(中额) → 财务审批 → 结束节点
      └─→ [False] 部门经理审批(高额) → 财务审批 → 总经理审批 → 结束节点
```

流程说明:
1. **开始节点**: 流程的起点,自动执行
2. **条件节点1**: 判断金额是否 < 1000
   - True: 跳转到部门经理审批(低额路径)
   - False: 跳转到条件节点2继续判断
3. **条件节点2**: 判断金额是否 < 5000
   - True: 跳转到部门经理审批(中额路径)
   - False: 跳转到部门经理审批(高额路径)
4. **审批节点**: 根据路径执行不同数量的审批
5. **结束节点**: 流程的终点

## 关键特性

- **条件节点**: 使用 ConditionNodeConfig 配置条件判断逻辑
- **数值比较条件**: 使用 NumericConditionConfig 进行数值比较
- **多条件分支**: 支持多个条件节点串联,实现复杂的分支逻辑
- **动态路径选择**: 根据任务参数中的金额动态选择审批路径
- **数据源支持**: 条件从任务参数(task_params)中读取数据

## 代码说明

### 主要组件

1. **模板创建** (`createTemplate`):
   - 创建包含开始节点、条件节点、审批节点、结束节点的模板
   - 配置两个条件节点实现三级分支
   - 配置多个审批节点对应不同的审批路径

2. **任务创建** (`main`):
   - 创建费用报销任务
   - 传入任务参数(金额、类别、描述)

3. **流程执行** (`runScenario`):
   - 提交任务进入审批流程
   - 根据金额判断应该走的审批路径
   - 依次执行对应路径的审批操作

4. **结果输出** (`printResults`):
   - 输出任务状态、审批记录
   - 验证审批路径是否正确

### 代码结构

```go
main()
  ├── 创建管理器 (TemplateManager, TaskManager)
  ├── 创建模板 (createTemplate)
  │   ├── 条件节点1: 金额 < 1000?
  │   ├── 条件节点2: 金额 < 5000?
  │   ├── 审批节点: 部门经理(低/中/高)、财务、总经理
  │   └── 边定义: 连接所有节点
  ├── 创建任务 (Create)
  ├── 执行流程 (runScenario)
  │   ├── 提交任务 (Submit)
  │   ├── 判断审批路径 (根据金额)
  │   └── 执行审批操作 (Approve)
  └── 输出结果 (printResults)
```

### 条件节点配置

条件节点使用 `ConditionNodeConfig` 配置:

```go
&node.ConditionNodeConfig{
    Condition: &node.Condition{
        Type: "numeric",
        Config: &node.NumericConditionConfig{
            Field:    "amount",      // 字段名
            Operator: "lt",          // 操作符(lt: 小于)
            Value:    1000.0,        // 比较值
            Source:   "task_params", // 数据源
        },
    },
    TrueNodeID:  "manager-approval-low",  // 条件为 true 时跳转
    FalseNodeID: "condition-amount-5000", // 条件为 false 时跳转
}
```

## 执行方法

### 前置要求

- Go 1.25.4 或更高版本
- 已安装 approval-kit 依赖

### 执行步骤

1. 进入场景目录:
   ```bash
   cd examples/03-conditional-branch
   ```

2. 运行程序:
   ```bash
   go run main.go
   ```

### 预期输出

程序运行后会输出以下内容:

```
=== 场景 03: 条件分支审批流程 ===

步骤 1: 创建审批模板
✓ 模板创建成功: ID=expense-approval-template, Name=费用报销审批模板

✓ 任务创建成功: ID=task-1763519209933366000-1, State=pending

步骤 2: 提交任务进入审批流程
✓ 任务已提交: State=submitted

步骤 3: 根据金额判断审批路径
  金额: 3000
  金额 3000 >= 1000 且 < 5000, 走中额路径: 部门经理审批 → 财务审批 → 结束

步骤 4: 执行审批操作
  说明: 条件节点会根据金额自动判断路径,这里手动执行对应路径的审批

  1. manager-001 已同意 (节点: manager-approval-medium, 状态: approved)

✓ 审批流程完成

=== 审批结果 ===
任务 ID: task-1763519209933366000-1
业务 ID: expense-001
模板 ID: expense-approval-template
当前状态: approved
当前节点: start
创建时间: 2025-11-19 10:26:49
提交时间: 2025-11-19 10:26:49
更新时间: 2025-11-19 10:26:49

任务参数:
  amount: 3000
  category: 差旅费
  description: 出差费用报销

审批记录:
  记录 1 (审批):
    节点 ID: manager-approval-medium
    审批人: manager-001
    审批结果: approve
    审批意见: 部门经理审批通过
    审批时间: 2025-11-19 10:26:49

状态变更历史:
  变更 1: pending -> submitted (原因: task submitted, 时间: 2025-11-19 10:26:49)
  变更 2: approving -> approved (原因: all approvers approved, 时间: 2025-11-19 10:26:49)

=== 验证结果 ===
✓ 任务已成功通过审批
✓ 中额路径: 2 个审批节点(部门经理、财务)
✗ 审批记录数量异常: 期望 2 条, 实际 1 条
```

**注意**: 
- 任务 ID 是动态生成的,每次运行都会不同
- 时间戳是实际运行时间,每次运行都会不同
- 任务参数中的字段顺序可能因 JSON 解析而有所不同
- 本示例展示了条件节点的配置和使用方法
- 条件节点的自动执行和流程跳转需要在实际业务系统中实现,本示例通过手动判断路径来演示条件分支的概念

## 验证步骤

1. **验证模板创建**:
   - 检查模板是否包含开始节点、条件节点、审批节点、结束节点
   - 检查条件节点配置是否正确(数值比较条件、数据源、跳转节点)
   - 检查审批节点配置是否正确

2. **验证任务创建**:
   - 检查任务初始状态是否为 `pending`
   - 检查任务参数是否正确设置(金额字段)

3. **验证任务提交**:
   - 检查任务状态是否从 `pending` 变为 `submitted`
   - 检查提交时间是否已设置

4. **验证条件判断**:
   - 检查代码是否正确根据金额判断审批路径
   - 检查审批路径是否与金额范围匹配

5. **验证审批操作**:
   - 检查审批操作是否成功执行
   - 检查任务状态是否正确更新

6. **验证审批记录**:
   - 检查是否生成了审批记录
   - 检查审批记录内容是否正确

### 验证要点

- ✓ 任务最终状态为 `approved`
- ✓ 条件节点配置正确(数值比较、数据源、跳转节点)
- ✓ 审批路径与金额范围匹配
- ✓ 审批记录已生成
- ✓ 状态变更历史包含状态转换记录

## 适用场景

这个场景适用于以下实际业务场景:

- **费用报销**: 根据报销金额选择不同的审批路径
- **采购审批**: 根据采购金额选择不同的审批层级
- **预算申请**: 根据申请金额选择不同的审批流程
- **合同审批**: 根据合同金额选择不同的审批路径

## 扩展说明

如果需要扩展此场景,可以考虑:

1. **测试不同金额**: 修改代码测试不同金额范围,验证不同路径
2. **添加更多条件**: 除了金额,还可以根据部门、项目类型等条件分支
3. **组合条件**: 使用组合条件实现更复杂的判断逻辑
4. **条件节点自动执行**: 在实际业务系统中实现条件节点的自动执行机制

## 相关场景

- **场景 12**: 多条件组合判断场景 - 使用组合条件实现复杂判断
- **场景 17**: 字符串匹配条件场景 - 使用字符串条件进行分支
- **场景 18**: 枚举判断条件场景 - 使用枚举条件进行分支
- **场景 23**: 基于节点输出的条件判断场景 - 从节点输出读取条件数据

