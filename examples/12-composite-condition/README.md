# 场景 12: 多条件组合判断场景

## 场景描述

这是一个多条件组合判断场景示例,演示根据多个条件组合判断审批路径,如金额和部门组合.

**业务背景**: 在实际业务中,审批路径可能需要根据多个维度进行判断.例如,技术部的大额申请(金额>=50000)需要走高级审批路径,而其他情况走普通审批路径.这种模式适用于需要根据多个维度判断审批路径的场景.

## 流程结构

```
开始节点
  ↓
条件节点(组合条件)
  ├─→ [金额>=50000 AND 部门=技术部] → 高级审批(会签) → 结束
  └─→ [其他情况]                    → 普通审批(单人) → 结束
```

流程说明:
1. **开始节点**: 流程的起点,自动执行
2. **条件节点**: 组合条件判断节点
   - 条件类型: 组合条件 (composite)
   - 操作符: AND (所有条件都必须满足)
   - 子条件1: 金额 >= 50000 (数值比较)
   - 子条件2: 部门 = 技术部 (字符串匹配)
   - True: 跳转到高级审批节点
   - False: 跳转到普通审批节点
3. **高级审批节点**: 金额>=50000 且 部门=技术部时使用
   - 审批模式: 多人会签 (ApprovalModeUnanimous)
   - 审批人: CTO、财务、CEO
   - 需要所有审批人全部同意
4. **普通审批节点**: 其他情况使用
   - 审批模式: 单人审批 (ApprovalModeSingle)
   - 审批人: 经理
5. **结束节点**: 流程的终点

## 关键特性

- **组合条件**: 使用 CompositeConditionConfig 实现多条件组合
- **AND/OR 逻辑**: 支持 AND(与) 和 OR(或) 逻辑组合
- **多条件类型**: 支持数值、字符串、枚举等多种条件类型组合
- **嵌套组合**: 支持条件嵌套,实现复杂的业务逻辑判断

## 代码说明

### 主要组件

1. **模板创建** (`createTemplate`):
   - 创建包含条件节点、高级审批节点、普通审批节点的模板
   - 配置条件节点使用组合条件(AND 逻辑)
   - 配置不同审批节点使用不同的审批模式

2. **条件组合演示** (`demonstrateCompositeConditions`):
   - 演示不同条件组合的场景
   - 展示条件判断逻辑和预期路径

3. **结果输出**:
   - 输出不同场景的任务参数和条件判断结果
   - 说明组合条件的配置和使用方法

### 代码结构

```go
main()
  ├── 创建管理器 (TemplateManager, TaskManager)
  ├── 创建模板 (createTemplate)
  │   └── 配置条件节点 (组合条件: AND 逻辑)
  └── 演示条件组合 (demonstrateCompositeConditions)
      ├── 场景1: 金额>=50000 且 部门=技术部
      ├── 场景2: 金额>=50000 但 部门!=技术部
      └── 场景3: 金额<50000 且 部门=技术部
```

### 组合条件配置示例

```go
Condition: &node.Condition{
    Type: "composite",
    Config: &node.CompositeConditionConfig{
        Operator: "and", // AND 逻辑: 所有条件都必须满足
        Conditions: []*node.Condition{
            {
                Type: "numeric",
                Config: &node.NumericConditionConfig{
                    Field:    "amount",
                    Operator: ">=",
                    Value:    50000,
                    Source:   "task_params",
                },
            },
            {
                Type: "string",
                Config: &node.StringConditionConfig{
                    Field:    "department",
                    Operator: "eq",
                    Value:    "技术部",
                    Source:   "task_params",
                },
            },
        },
    },
}
```

## 执行方法

### 前置要求

- Go 1.25.4 或更高版本
- 已安装 approval-kit 依赖

### 执行步骤

1. 进入场景目录:
   ```bash
   cd examples/12-composite-condition
   ```

2. 运行程序:
   ```bash
   go run main.go
   ```

### 预期输出

程序运行后会输出以下内容:

```
=== 场景 12: 多条件组合判断场景 ===

步骤 1: 创建审批模板
✓ 模板创建成功: ID=composite-condition-template, Name=组合条件审批模板

=== 场景 1: 金额>=50000 且 部门=技术部 ===

✓ 任务创建成功: ID=task-1763521550508236000-1
  任务参数:
    requester: 申请人-001
    amount: 100000
    department: 技术部
    description: 金额>=50000 且 部门=技术部,应该走高级审批路径
    requestNo: REQ-2025-001
    requestType: 组合条件测试
  条件判断: 金额>=50000 AND 部门=技术部
  预期路径: 高级审批路径(多人会签)

=== 场景 2: 金额>=50000 但 部门!=技术部 ===

✓ 任务创建成功: ID=task-1763521550508523000-2
  任务参数:
    requestNo: REQ-2025-002
    requestType: 组合条件测试
    requester: 申请人-001
    amount: 100000
    department: 市场部
    description: 金额>=50000 但 部门!=技术部,应该走普通审批路径
  条件判断: 金额>=50000 AND 部门=技术部
  实际结果: 金额>=50000 但 部门!=技术部,条件不满足
  预期路径: 普通审批路径(单人审批)

=== 场景 3: 金额<50000 且 部门=技术部 ===

✓ 任务创建成功: ID=task-1763521550508537000-3
  任务参数:
    department: 技术部
    description: 金额<50000 且 部门=技术部,应该走普通审批路径
    requestNo: REQ-2025-003
    requestType: 组合条件测试
    requester: 申请人-001
    amount: 30000
  条件判断: 金额>=50000 AND 部门=技术部
  实际结果: 金额<50000 但 部门=技术部,条件不满足
  预期路径: 普通审批路径(单人审批)

=== 组合条件说明 ===
  组合条件配置:
    - 操作符: AND (所有条件都必须满足)
    - 条件1: 金额 >= 50000
    - 条件2: 部门 = 技术部

  审批路径:
    - True (所有条件满足): 高级审批路径(多人会签)
    - False (任一条件不满足): 普通审批路径(单人审批)

  注意: 本示例仅展示组合条件的配置方法
  实际执行需要在实际业务系统中实现条件评估和流程跳转
```

**注意**: 
- 任务 ID 是动态生成的,每次运行都会不同
- 时间戳是实际运行时间,每次运行都会不同
- 任务参数中的字段顺序可能因 JSON 解析而有所不同
- 本示例仅展示组合条件的配置方法,实际执行需要在实际业务系统中实现条件评估和流程跳转

## 验证步骤

1. **验证模板创建**:
   - 检查模板是否包含开始节点、条件节点、高级审批节点、普通审批节点、结束节点
   - 检查条件节点是否配置了组合条件
   - 检查组合条件的操作符是否正确(AND)
   - 检查子条件是否正确配置

2. **验证条件组合**:
   - 检查组合条件是否包含数值条件和字符串条件
   - 检查条件的数据源是否正确(task_params)
   - 检查条件的操作符和值是否正确

3. **验证不同场景**:
   - 场景1: 金额>=50000 且 部门=技术部 → 应该走高级审批路径
   - 场景2: 金额>=50000 但 部门!=技术部 → 应该走普通审批路径
   - 场景3: 金额<50000 且 部门=技术部 → 应该走普通审批路径

### 验证要点

- ✓ 组合条件节点已正确配置
- ✓ AND 逻辑正确实现(所有条件都必须满足)
- ✓ 数值条件正确配置(金额 >= 50000)
- ✓ 字符串条件正确配置(部门 = 技术部)
- ✓ 不同场景的条件判断结果正确

## 组合条件说明

### AND 逻辑

- **操作符**: `and`
- **逻辑**: 所有子条件都必须满足,结果才为 true
- **示例**: `金额>=50000 AND 部门=技术部`
  - 只有当金额>=50000 **且** 部门=技术部时,条件才为 true
  - 如果任一条件不满足,条件为 false

### OR 逻辑

- **操作符**: `or`
- **逻辑**: 任意一个子条件满足,结果就为 true
- **示例**: `金额>=50000 OR 部门=技术部`
  - 当金额>=50000 **或** 部门=技术部时,条件就为 true
  - 只有当所有条件都不满足时,条件才为 false

### 嵌套组合

组合条件支持嵌套,可以实现更复杂的业务逻辑:

```go
// 示例: (金额>=50000 AND 部门=技术部) OR (金额>=100000)
Config: &node.CompositeConditionConfig{
    Operator: "or",
    Conditions: []*node.Condition{
        {
            Type: "composite",
            Config: &node.CompositeConditionConfig{
                Operator: "and",
                Conditions: []*node.Condition{
                    // 金额>=50000
                    // 部门=技术部
                },
            },
        },
        {
            Type: "numeric",
            Config: &node.NumericConditionConfig{
                Field:    "amount",
                Operator: ">=",
                Value:    100000,
            },
        },
    },
}
```

## 适用场景

这个场景适用于以下实际业务场景:

- **多维度判断**: 需要根据多个维度(金额、部门、类型等)判断审批路径
- **复杂业务规则**: 需要实现复杂的业务逻辑判断
- **灵活审批路径**: 需要根据多种条件组合选择不同的审批路径

## 扩展说明

如果需要扩展此场景,可以考虑:

1. **测试 OR 逻辑**: 配置 OR 逻辑的组合条件,测试条件判断
2. **测试嵌套组合**: 配置嵌套的组合条件,测试复杂业务逻辑
3. **测试枚举条件**: 添加枚举条件,测试多种条件类型组合
4. **测试节点输出数据**: 使用节点输出数据作为条件数据源
5. **动态条件配置**: 根据任务参数动态配置条件

## 相关场景

- **场景 03**: 条件分支审批流程 - 单个条件判断
- **场景 10**: 复杂综合审批流程 - 可以结合组合条件实现更复杂的流程

