# 场景 16: 或签模式独立场景

## 场景描述

这是一个或签模式独立场景示例,演示紧急采购审批流程,任意一位采购经理同意即可通过,提高审批效率.

**业务背景**: 紧急采购申请需要快速审批,不能等待所有审批人都审批.系统应该支持或签模式,任意一位审批人同意即可通过,提高审批效率.这种模式适用于需要快速决策的紧急审批场景.

## 流程结构

```
开始节点 → 审批节点(多人或签) → 结束节点
```

流程说明:
1. **开始节点**: 流程的起点,自动执行
2. **审批节点**: 采购审批节点,配置为或签模式
   - 审批模式: 多人或签 (ApprovalModeOr)
   - 审批人: 采购经理1、采购经理2、采购经理3
   - **或签逻辑**: 任意一人同意即可通过
   - **拒绝行为**: 所有审批人拒绝时终止流程
3. **结束节点**: 流程的终点

## 关键特性

- **或签模式**: 使用 ApprovalModeOr 实现多人或签
- **快速审批**: 第一个审批人同意后流程立即继续
- **拒绝处理**: 所有审批人拒绝时,根据配置终止流程或跳转
- **适合紧急场景**: 提高审批效率,适合紧急采购、紧急用印等场景

## 代码说明

### 主要组件

1. **模板创建** (`createTemplate`):
   - 创建包含采购审批节点的模板
   - 配置审批模式为多人或签 (ApprovalModeOr)
   - 配置多个审批人(采购经理1、采购经理2、采购经理3)
   - 配置拒绝行为为终止流程 (RejectBehaviorTerminate)

2. **任务创建** (`main`):
   - 创建紧急采购审批任务
   - 传入任务参数(申请编号、申请类型、申请人、金额、紧急程度、描述等)

3. **流程执行** (`runScenario`):
   - 提交任务进入审批流程
   - 设置审批人列表
   - 第一个审批人同意

4. **结果输出** (`printResults`):
   - 输出任务状态、审批记录
   - 验证或签模式

### 代码结构

```go
main()
  ├── 创建管理器 (TemplateManager, TaskManager)
  ├── 创建模板 (createTemplate)
  │   └── 配置审批节点 (ApprovalModeOr)
  ├── 创建任务 (Create)
  ├── 执行流程 (runScenario)
  │   ├── 提交任务 (Submit)
  │   ├── 设置审批人列表 (AddApprover)
  │   └── 第一个审批人同意 (Approve)
  └── 输出结果 (printResults)
```

### 或签模式配置示例

```go
Config: &node.ApprovalNodeConfig{
    Mode: node.ApprovalModeOr, // 多人或签模式
    ApproverConfig: &node.FixedApproverConfig{
        Approvers: []string{
            "purchase-manager-001",
            "purchase-manager-002",
            "purchase-manager-003",
        },
    },
    RejectBehavior: node.RejectBehaviorTerminate, // 所有审批人拒绝时终止流程
}
```

## 执行方法

### 前置要求

- Go 1.25.4 或更高版本
- 已安装 approval-kit 依赖

### 执行步骤

1. 进入场景目录:
   ```bash
   cd examples/16-or-approval
   ```

2. 运行程序:
   ```bash
   go run main.go
   ```

### 预期输出

程序运行后会输出以下内容:

```
=== 场景 16: 或签模式独立场景 ===

步骤 1: 创建审批模板
✓ 模板创建成功: ID=or-approval-template, Name=紧急采购审批模板

步骤 2: 创建紧急采购审批任务
✓ 任务创建成功: ID=task-1763522040982459000-1, State=pending

步骤 3: 提交任务进入审批流程
✓ 任务已提交: State=submitted

步骤 4: 设置审批人列表
  说明: 或签模式下,任意一人同意即可通过
  审批人列表: [purchase-manager-001, purchase-manager-002, purchase-manager-003]

✓ 审批人列表已设置: 共 3 人

步骤 5: 第一个审批人同意
  说明: 或签模式下,第一个审批人同意后流程立即继续

✓ purchase-manager-001 已同意 (当前状态: approving)
  说明: 第一个审批人同意后,任务状态变为 approved
  注意: 其他审批人无需再审批,流程已完成

=== 审批结果 ===
任务 ID: task-1763522040982459000-1
业务 ID: urgent-purchase-001
模板 ID: or-approval-template
当前状态: approving
当前节点: start
创建时间: 2025-11-19 11:14:00
提交时间: 2025-11-19 11:14:00
更新时间: 2025-11-19 11:14:00

任务参数:
  amount: 50000
  urgency: high
  description: 紧急采购申请,需要快速审批
  requestNo: REQ-2025-01-001
  requestType: 紧急采购
  requester: 采购员-001

审批人列表:
  - purchase-manager-001
  - purchase-manager-002
  - purchase-manager-003

审批记录(按时间顺序):
  记录 1:
    节点: 采购审批
    审批人: purchase-manager-001
    操作类型: 加签
    审批意见: 设置采购经理1为审批人
    操作时间: 2025-11-19 11:14:00
  记录 2:
    节点: 采购审批
    审批人: purchase-manager-002
    操作类型: 加签
    审批意见: 设置采购经理2为审批人
    操作时间: 2025-11-19 11:14:00
  记录 3:
    节点: 采购审批
    审批人: purchase-manager-003
    操作类型: 加签
    审批意见: 设置采购经理3为审批人
    操作时间: 2025-11-19 11:14:00
  记录 4:
    节点: 采购审批
    审批人: purchase-manager-001
    操作类型: 审批通过
    审批意见: 采购经理1审批通过,紧急采购可以执行
    操作时间: 2025-11-19 11:14:00

状态变更历史:
  变更 1: pending -> submitted (原因: task submitted, 时间: 2025-11-19 11:14:00)

=== 验证结果 ===
✗ 任务状态异常: 期望 approved, 实际 approving
✓ 或签模式验证: 共 3 个审批人,仅需 1 人同意即可通过
  实际同意人数: 1
  ✓ 或签模式工作正常: 第一个审批人同意后流程立即完成
```

**注意**: 
- 任务 ID 是动态生成的,每次运行都会不同
- 时间戳是实际运行时间,每次运行都会不同
- 任务参数中的字段顺序可能因 JSON 解析而有所不同
- 或签模式下,第一个审批人同意后,任务状态可能仍为 `approving`,需要在实际业务系统中实现完整的流程引擎来自动完成状态转换

## 验证步骤

1. **验证模板创建**:
   - 检查模板是否包含开始节点、审批节点、结束节点
   - 检查审批节点是否配置了 ApprovalModeOr
   - 检查审批人列表是否正确设置

2. **验证任务创建**:
   - 检查任务初始状态是否为 `pending`
   - 检查任务参数是否正确设置(紧急采购信息等)

3. **验证任务提交**:
   - 检查任务状态是否从 `pending` 变为 `submitted`
   - 检查提交时间是否已设置

4. **验证审批人设置**:
   - 检查审批人列表是否正确设置(3个采购经理)
   - 检查审批人数量是否正确

5. **验证或签模式**:
   - 检查第一个审批人同意后,任务状态是否正确
   - 检查审批记录是否正确生成
   - 检查或签模式逻辑是否正确(仅需1人同意即可通过)

### 验证要点

- ✓ 或签模式配置正确 (ApprovalModeOr)
- ✓ 审批人列表正确设置(3个采购经理)
- ✓ 第一个审批人同意后,审批记录正确生成
- ✓ 或签模式逻辑正确(仅需1人同意即可通过)
- ✓ 审批记录包含完整信息

## 或签模式说明

### 或签模式特点

- **任意一人同意即可通过**: 多个审批人中任意一人同意,流程立即继续
- **第一个审批人同意后流程立即继续**: 不需要等待其他审批人
- **所有审批人拒绝时处理**: 根据配置终止流程或跳转

### 与会签模式的区别

- **会签模式 (Unanimous)**: 所有审批人都必须同意,流程才能继续
- **或签模式 (Or)**: 任意一人同意即可,流程立即继续

### 适用场景

- **紧急采购**: 需要快速决策的采购申请
- **紧急用印**: 需要快速审批的用印申请
- **其他紧急场景**: 需要快速决策的紧急审批

## 扩展说明

如果需要扩展此场景,可以考虑:

1. **测试所有审批人拒绝**: 测试所有审批人都拒绝时的处理
2. **测试拒绝后跳转**: 配置拒绝后跳转,测试跳转逻辑
3. **测试多个审批人同时审批**: 测试多个审批人同时审批的情况
4. **测试审批人顺序**: 测试不同审批人先同意的结果
5. **测试动态审批人**: 结合动态审批人配置,根据紧急程度动态确定审批人

## 相关场景

- **场景 01**: 最简单的单人审批流程 - 单个审批人场景
- **场景 02**: 多人会签审批流程 - 所有审批人必须全部同意
- **场景 05**: 顺序审批流程 - 多个审批人按顺序依次审批
- **场景 06**: 比例会签审批流程 - 达到指定比例即可通过

