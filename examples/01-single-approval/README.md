# 场景 01: 最简单的单人审批流程

## 场景描述

这是一个最简单的审批流程示例,模拟请假申请场景.员工提交请假申请后,只需要直接主管审批即可完成流程.

**业务背景**: 员工需要请假 3 天,提交请假申请后等待主管审批.主管同意后,请假申请即通过.

## 流程结构

```
开始节点 → 审批节点(单人审批) → 结束节点
```

流程说明:

1. **开始节点**: 流程的起点,自动执行
2. **审批节点**: 主管审批节点,使用单人审批模式
   - 审批人: manager-001 (固定审批人)
   - 审批模式: 单人审批 (ApprovalModeSingle)
   - 审批人同意后流程立即继续
3. **结束节点**: 流程的终点,任务状态变为已通过

## 关键特性

- **固定审批人配置**: 使用 FixedApproverConfig 配置固定的审批人
- **单人审批模式**: 使用 ApprovalModeSingle,单个审批人审批后流程继续
- **基础状态流转**:
  - `pending` (待审批) → `submitted` (已提交) → `approving` (审批中) → `approved` (已通过)
- **审批记录自动生成**: 每次审批操作自动生成审批记录
- **状态变更历史**: 记录每次状态变更的详细信息

## 代码说明

### 主要组件

1. **模板创建** (`createTemplate`):

   - 创建包含开始节点、审批节点、结束节点的模板
   - 配置审批节点为单人审批模式
   - 设置固定审批人为 "manager-001"

2. **任务创建** (`main`):

   - 创建请假审批任务
   - 传入任务参数(请假类型、天数、原因)

3. **流程执行** (`runScenario`):

   - 提交任务进入审批流程
   - 主管执行审批操作(同意)

4. **结果输出** (`printResults`):
   - 输出任务状态、审批记录、状态变更历史
   - 验证最终状态是否正确

### 代码结构

```go
main()
  ├── 创建管理器 (TemplateManager, TaskManager)
  ├── 创建模板 (createTemplate)
  ├── 创建任务 (Create)
  ├── 执行流程 (runScenario)
  │   ├── 提交任务 (Submit)
  │   └── 执行审批 (Approve)
  └── 输出结果 (printResults)
```

## 执行方法

### 前置要求

- Go 1.25.4 或更高版本
- 已安装 approval-kit 依赖

### 执行步骤

1. 进入场景目录:

   ```bash
   cd examples/01-single-approval
   ```

2. 运行程序:
   ```bash
   go run main.go
   ```

### 预期输出

程序运行后会输出以下内容:

```
=== 场景 01: 最简单的单人审批流程 ===

步骤 1: 创建审批模板
✓ 模板创建成功: ID=leave-approval-template, Name=请假审批模板

步骤 2: 创建审批任务
✓ 任务创建成功: ID=task-1763518309388832000-1, State=pending

步骤 3: 提交任务进入审批流程
✓ 任务已提交: State=submitted, CurrentNode=start

步骤 4: 主管执行审批操作
✓ 审批操作完成: 主管已同意

=== 审批结果 ===
任务 ID: task-1763518309388832000-1
业务 ID: leave-001
模板 ID: leave-approval-template
当前状态: approved
当前节点: start
创建时间: 2025-11-19 10:11:49
提交时间: 2025-11-19 10:11:49
更新时间: 2025-11-19 10:11:49

任务参数:
  reason: 个人事务
  leaveType: 年假
  days: 3

审批记录:
  记录 1:
    节点 ID: manager-approval
    审批人: manager-001
    审批结果: approve
    审批意见: 同意请假申请
    审批时间: 2025-11-19 10:11:49

状态变更历史:
  变更 1: pending -> submitted (原因: task submitted, 时间: 2025-11-19 10:11:49)
  变更 2: approving -> approved (原因: all approvers approved, 时间: 2025-11-19 10:11:49)

=== 验证结果 ===
✓ 任务已成功通过审批
✓ 已生成 1 条审批记录
```

**注意**:

- 任务 ID 是动态生成的,每次运行都会不同
- 时间戳是实际运行时间,每次运行都会不同
- 任务参数中的字段顺序可能因 JSON 解析而有所不同

## 验证步骤

1. **验证模板创建**:

   - 检查模板是否包含开始节点、审批节点、结束节点
   - 检查审批节点配置是否正确(单人审批模式、固定审批人)

2. **验证任务创建**:

   - 检查任务初始状态是否为 `pending`
   - 检查任务参数是否正确设置

3. **验证任务提交**:

   - 检查任务状态是否从 `pending` 变为 `submitted`
   - 检查提交时间是否已设置

4. **验证审批操作**:

   - 检查审批操作是否成功执行
   - 检查任务状态是否从 `submitted` 变为 `approving`,最终变为 `approved`

5. **验证审批记录**:

   - 检查是否生成了审批记录
   - 检查审批记录内容是否正确(节点 ID、审批人、审批结果、审批意见)

6. **验证状态变更历史**:
   - 检查状态变更历史是否记录了所有状态转换
   - 检查状态转换路径: `pending` → `submitted` → `approving` → `approved`
   - 注意: 实际输出中可能只显示关键的状态转换(如 `pending` → `submitted` 和 `approving` → `approved`)

### 验证要点

- ✓ 任务最终状态为 `approved`
- ✓ 至少生成 1 条审批记录
- ✓ 审批记录中的审批结果为 `approve`
- ✓ 审批记录中的节点 ID 为 `manager-approval`
- ✓ 审批记录中的审批人为 `manager-001`
- ✓ 状态变更历史包含状态转换记录
- ✓ 所有时间字段都已正确设置

## 适用场景

这个场景适用于以下实际业务场景:

- **请假审批**: 员工请假,只需要直接主管审批
- **简单报销**: 小额报销,只需要部门经理审批
- **日常申请**: 简单的日常申请流程,单级审批即可
- **快速审批**: 需要快速决策的简单审批流程

## 扩展说明

如果需要扩展此场景,可以考虑:

1. **添加拒绝处理**: 演示主管拒绝请假申请的场景
2. **添加审批意见必填**: 配置 RequireComment 要求必须填写审批意见
3. **添加附件要求**: 配置 RequireAttachments 要求必须上传附件
4. **添加超时处理**: 配置超时时间,演示超时处理机制

## 相关场景

- **场景 02**: 多人会签审批流程 - 需要多人全部同意的场景
- **场景 05**: 顺序审批流程 - 需要按顺序多级审批的场景
- **场景 20**: 审批意见和附件必填场景 - 要求审批意见和附件的场景
