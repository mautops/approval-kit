# 场景 23: 基于节点输出的条件判断场景

## 场景描述

这是一个基于节点输出的条件判断场景示例,演示如何根据前面节点的输出结果决定后续审批路径.

**业务背景**: 技术方案评审流程中,技术评审节点会输出评分,后续的条件节点根据这个评分决定审批路径:
- 评分 >= 80: 直接进入最终审批
- 评分 < 80 且 >= 60: 需要修改后重新评审
- 评分 < 60: 直接拒绝

## 流程结构

```
开始节点
  ↓
技术评审节点(输出评分)
  ↓
条件节点1(评分 >= 80?)
  ├─→ [是] 最终审批节点 → 正常结束
  └─→ [否] 条件节点2(评分 >= 60?)
      ├─→ [是] 重新评审节点 → 正常结束
      └─→ [否] 拒绝结束节点
```

流程说明:
1. **开始节点**: 流程的起点,自动执行
2. **技术评审节点**: 技术评审,输出评分
   - 审批模式: 单人审批 (ApprovalModeSingle)
   - 审批人: tech-lead-001
   - 输出数据: `{"score": 85, "comment": "...", "reviewer": "...", "reviewTime": "..."}`
3. **条件节点1**: 判断评分是否 >= 80
   - 数据源: `node_outputs` (从技术评审节点的输出中读取)
   - 字段: `score`
   - 条件满足: 跳转到最终审批节点
   - 条件不满足: 进入条件节点2
4. **条件节点2**: 判断评分是否 >= 60
   - 数据源: `node_outputs` (从技术评审节点的输出中读取)
   - 字段: `score`
   - 条件满足: 跳转到重新评审节点
   - 条件不满足: 跳转到拒绝结束节点
5. **最终审批节点**: 最终审批(评分 >= 80 时)
   - 审批模式: 单人审批 (ApprovalModeSingle)
   - 审批人: manager-001
6. **重新评审节点**: 重新评审(评分 60-80 时)
   - 审批模式: 单人审批 (ApprovalModeSingle)
   - 审批人: tech-lead-001
7. **拒绝结束节点**: 拒绝结束(评分 < 60 时)
8. **正常结束节点**: 正常结束

## 关键特性

- **节点输出作为条件**: 条件节点可以从前面节点的输出中读取数据
- **多条件节点组合**: 使用两个条件节点实现三个分支路径
- **动态路径选择**: 根据前面节点的执行结果动态选择后续路径
- **数据流转**: 实现节点间的数据流转和依赖

## 代码说明

### 主要组件

1. **模板创建** (`createTemplate`):
   - 创建技术评审节点,配置为单人审批模式
   - 创建两个条件节点,实现三个分支路径
   - 配置条件节点从技术评审节点的输出中读取评分

2. **场景执行** (`runScenario`):
   - 创建任务
   - 提交任务
   - 手动设置技术评审节点的输出数据(模拟节点执行)
   - 手动判断条件节点结果(模拟条件节点执行)
   - 验证节点输出数据

3. **结果输出**:
   - 输出条件节点判断结果
   - 输出预期路径和实际路径
   - 输出完整流程说明

### 代码结构

```go
main()
  ├── 创建管理器 (TemplateManager, TaskManager)
  ├── 创建模板 (createTemplate)
  │   ├── 技术评审节点 (tech-review)
  │   ├── 条件节点1 (score-condition-1: 评分 >= 80)
  │   ├── 条件节点2 (score-condition-2: 评分 >= 60)
  │   ├── 最终审批节点 (final-approval)
  │   ├── 重新评审节点 (re-review)
  │   └── 拒绝结束节点 (reject-end)
  └── 运行多个场景 (runScenario)
      ├── 高分场景 (评分=85)
      ├── 中分场景 (评分=70)
      └── 低分场景 (评分=45)
```

### 条件节点配置示例

```go
conditionNode1 := &template.Node{
    ID:   "score-condition-1",
    Name: "评分条件判断1(>=80)",
    Type: template.NodeTypeCondition,
    Config: &node.ConditionNodeConfig{
        Condition: &node.Condition{
            Type: "numeric",
            Config: &node.NumericConditionConfig{
                Field:    "score",
                Operator: "gte",
                Value:    80,
                Source:   "node_outputs",  // 从节点输出中读取
                NodeID:   "tech-review",    // 指定节点 ID
            },
        },
        TrueNodeID:  "final-approval",      // 条件满足时跳转
        FalseNodeID: "score-condition-2",  // 条件不满足时跳转
    },
}
```

### 节点输出数据设置示例

```go
// 手动设置节点输出数据(模拟节点执行)
tsk.Update(func(t *task.Task) error {
    outputData := map[string]interface{}{
        "score":      score,
        "comment":    fmt.Sprintf("技术评审评分: %d", score),
        "reviewer":   "tech-lead-001",
        "reviewTime": time.Now().Format("2006-01-02 15:04:05"),
    }
    outputJSON, _ := json.Marshal(outputData)
    if t.NodeOutputs == nil {
        t.NodeOutputs = make(map[string]json.RawMessage)
    }
    t.NodeOutputs["tech-review"] = outputJSON
    return nil
})
```

## 执行方法

### 前置要求

- Go 1.25.4 或更高版本
- 已安装 approval-kit 依赖

### 执行步骤

1. 进入场景目录:
   ```bash
   cd examples/23-node-output-condition
   ```

2. 运行程序:
   ```bash
   go run main.go
   ```

### 预期输出

程序运行后会输出以下内容:

```
=== 场景 23: 基于节点输出的条件判断场景 ===

✓ 模板创建成功: ID=tech-review-template, Name=技术方案评审模板

--- 高分场景(>=80) ---
✓ 任务创建成功: ID=task-1763523274267447000-1, 评分=85
✓ 任务已提交
✓ 技术评审节点输出已设置: score=85
✓ 条件节点判断结果: 评分 >= 80, 进入最终审批
  预期路径: 直接进入最终审批
  实际路径: 评分 >= 80, 进入最终审批

完整流程说明:
  1. 技术评审节点(tech-review)执行,输出评分: 85
  2. 条件节点1(score-condition-1)读取 tech-review 的输出,判断评分是否 >= 80
  3. 条件满足,跳转到最终审批节点(final-approval)
  4. 最终审批通过后,流程结束

注意: 此示例主要展示节点输出数据作为条件判断的配置方式.
在实际业务系统中,条件节点会自动执行并跳转到下一个节点.

--- 中分场景(60-80) ---
✓ 任务创建成功: ID=task-1763523274267686000-2, 评分=70
✓ 任务已提交
✓ 技术评审节点输出已设置: score=70
✓ 条件节点判断结果: 评分 < 80 且 >= 60, 需要修改后重新评审
  预期路径: 需要修改后重新评审
  实际路径: 评分 < 80 且 >= 60, 需要修改后重新评审

完整流程说明:
  1. 技术评审节点(tech-review)执行,输出评分: 70
  2. 条件节点1(score-condition-1)读取 tech-review 的输出,判断评分是否 >= 80
  3. 条件不满足,进入条件节点2(score-condition-2),判断评分是否 >= 60
  4. 条件满足,跳转到重新评审节点(re-review)
  5. 重新评审通过后,流程结束

注意: 此示例主要展示节点输出数据作为条件判断的配置方式.
在实际业务系统中,条件节点会自动执行并跳转到下一个节点.

--- 低分场景(<60) ---
✓ 任务创建成功: ID=task-1763523274267706000-3, 评分=45
✓ 任务已提交
✓ 技术评审节点输出已设置: score=45
✓ 条件节点判断结果: 评分 < 60, 直接拒绝
  预期路径: 直接拒绝
  实际路径: 评分 < 60, 直接拒绝

完整流程说明:
  1. 技术评审节点(tech-review)执行,输出评分: 45
  2. 条件节点1(score-condition-1)读取 tech-review 的输出,判断评分是否 >= 80
  3. 条件不满足,进入条件节点2(score-condition-2),判断评分是否 >= 60
  4. 条件不满足,跳转到拒绝结束节点(reject-end)
  5. 流程结束,任务被拒绝

注意: 此示例主要展示节点输出数据作为条件判断的配置方式.
在实际业务系统中,条件节点会自动执行并跳转到下一个节点.
```

**注意**: 
- 任务 ID 是动态生成的,每次运行都会不同
- 此示例主要展示节点输出数据作为条件判断的配置方式
- 在实际业务系统中,条件节点会自动执行并跳转到下一个节点
- 节点输出数据的设置和条件节点的执行需要在实际业务系统中实现

## 验证步骤

1. **验证模板创建**:
   - 检查模板是否包含技术评审节点、条件节点、审批节点、结束节点
   - 检查条件节点配置是否正确(数据源、字段、操作符、值)

2. **验证任务创建**:
   - 检查任务初始状态是否为 `pending`
   - 检查任务参数是否正确设置

3. **验证节点输出数据设置**:
   - 检查技术评审节点的输出数据是否正确设置
   - 检查输出数据格式是否符合预期(JSON 格式)

4. **验证条件节点判断**:
   - 检查条件节点判断结果是否符合预期
   - 检查不同评分场景下的路径选择是否正确

### 验证要点

- ✓ 条件节点可以从节点输出中读取数据
- ✓ 条件节点判断逻辑正确
- ✓ 多条件节点组合实现三个分支路径
- ✓ 节点输出数据格式正确

## 节点输出数据说明

### 节点输出数据结构

节点输出数据以 JSON 格式存储在 `Task.NodeOutputs` 中:

```json
{
  "tech-review": {
    "score": 85,
    "comment": "技术评审评分: 85",
    "reviewer": "tech-lead-001",
    "reviewTime": "2025-11-19 11:34:34"
  }
}
```

### 条件节点读取节点输出

条件节点通过 `NumericConditionConfig` 配置从节点输出中读取数据:

- **Source**: `"node_outputs"` (指定数据源为节点输出)
- **NodeID**: `"tech-review"` (指定要读取的节点 ID)
- **Field**: `"score"` (指定要读取的字段名)
- **Operator**: `"gte"` (指定比较操作符)
- **Value**: `80` (指定比较值)

### 多条件节点组合

由于条件节点只支持 true/false 两个分支,要实现三个分支路径,需要使用两个条件节点:

1. **条件节点1**: 判断评分是否 >= 80
   - 条件满足: 跳转到最终审批节点
   - 条件不满足: 进入条件节点2

2. **条件节点2**: 判断评分是否 >= 60
   - 条件满足: 跳转到重新评审节点
   - 条件不满足: 跳转到拒绝结束节点

## 适用场景

这个场景适用于以下实际业务场景:

- **多阶段评审流程**: 后续阶段依赖前面阶段结果的场景
- **动态路径选择**: 根据前面节点的执行结果动态选择后续路径
- **数据流转**: 需要实现节点间的数据流转和依赖的场景
- **条件分支**: 需要根据节点输出数据进行条件分支的场景

## 扩展说明

如果需要扩展此场景,可以考虑:

1. **测试更多条件类型**: 测试字符串条件、枚举条件等从节点输出中读取数据
2. **测试组合条件**: 测试组合条件从节点输出中读取数据
3. **测试多个节点输出**: 测试条件节点从多个节点的输出中读取数据
4. **测试节点输出数据格式**: 测试不同格式的节点输出数据
5. **测试节点输出数据验证**: 测试节点输出数据的验证和错误处理

## 相关场景

- **场景 03**: 条件分支审批流程 - 可以结合节点输出数据实现更复杂的条件分支
- **场景 12**: 多条件组合判断场景 - 可以结合节点输出数据实现更复杂的条件组合
- **场景 19**: 节点输出数据传递场景 - 展示了节点输出数据的基本使用方式
- **场景 17**: 字符串匹配条件场景 - 展示了字符串条件的使用方式
- **场景 18**: 枚举判断条件场景 - 展示了枚举条件的使用方式

