# 场景 08: 高级操作场景(转交、加签、减签)

## 场景描述

这是一个高级操作场景示例,模拟项目审批过程中,审批人可以转交、加签或减签.

**业务背景**: 项目审批流程需要经过多个审批人审批.在实际业务中,可能需要灵活调整审批人:
- **转交**: 审批人因出差、请假等原因无法审批时,可以将任务转交给其他审批人
- **加签**: 在审批过程中,发现需要额外的审批人参与审批
- **减签**: 在审批过程中,发现某些审批人无需参与审批,可以移除

这种模式适用于需要灵活调整审批人的场景.

## 流程结构

```
开始节点 → 审批节点(支持高级操作) → 结束节点
```

流程说明:
1. **开始节点**: 流程的起点,自动执行
2. **审批节点**: 项目审批节点,支持高级操作
   - 审批模式: 多人会签 (ApprovalModeUnanimous)
   - 初始审批人: 项目经理、财务审批人
   - **操作权限**: 允许转交、加签、减签
3. **结束节点**: 流程的终点

## 关键特性

- **转交审批**: 使用 Transfer 方法实现审批人转交
- **加签**: 使用 AddApprover 方法在审批过程中添加审批人
- **减签**: 使用 RemoveApprover 方法移除审批人
- **权限控制**: 节点级别控制是否允许这些操作
- **操作记录**: 所有高级操作都会生成审批记录

## 代码说明

### 主要组件

1. **模板创建** (`createTemplate`):
   - 创建包含项目审批节点的模板
   - 配置审批模式为多人会签 (ApprovalModeUnanimous)
   - 配置操作权限(AllowTransfer、AllowAddApprover、AllowRemoveApprover)

2. **任务创建** (`main`):
   - 创建项目审批任务
   - 传入任务参数(项目编号、项目名称、项目经理、预算、描述等)

3. **流程执行** (`runScenario`):
   - 提交任务进入审批流程
   - 设置初始审批人列表
   - 执行加签操作
   - 执行转交操作
   - 执行减签操作
   - 执行审批操作

4. **结果输出** (`printResults`):
   - 输出任务状态、审批记录
   - 验证高级操作统计

### 代码结构

```go
main()
  ├── 创建管理器 (TemplateManager, TaskManager)
  ├── 创建模板 (createTemplate)
  │   └── 配置审批节点 (支持转交、加签、减签)
  ├── 创建任务 (Create)
  ├── 执行流程 (runScenario)
  │   ├── 提交任务 (Submit)
  │   ├── 设置初始审批人列表 (AddApprover)
  │   ├── 加签操作 (AddApprover)
  │   ├── 转交操作 (Transfer)
  │   ├── 减签操作 (RemoveApprover)
  │   └── 执行审批操作 (Approve)
  └── 输出结果 (printResults)
```

### 操作权限配置示例

```go
Permissions: node.OperationPermissions{
    AllowTransfer:      true, // 允许转交
    AllowAddApprover:   true, // 允许加签
    AllowRemoveApprover: true, // 允许减签
}
```

### 高级操作示例

**转交操作**:
```go
err = taskMgr.Transfer(tsk.ID, nodeID, "manager-001", "manager-002", "项目经理出差,转交给副经理审批")
```

**加签操作**:
```go
err = taskMgr.AddApprover(tsk.ID, nodeID, "tech-lead-001", "加签: 添加技术负责人参与审批")
```

**减签操作**:
```go
err = taskMgr.RemoveApprover(tsk.ID, nodeID, "tech-lead-001", "减签: 技术负责人无需参与审批")
```

## 执行方法

### 前置要求

- Go 1.25.4 或更高版本
- 已安装 approval-kit 依赖

### 执行步骤

1. 进入场景目录:
   ```bash
   cd examples/08-advanced-operations
   ```

2. 运行程序:
   ```bash
   go run main.go
   ```

### 预期输出

程序运行后会输出以下内容:

```
=== 场景 08: 高级操作场景(转交、加签、减签) ===

步骤 1: 创建审批模板
✓ 模板创建成功: ID=project-approval-template, Name=项目审批模板

步骤 2: 创建项目审批任务
✓ 任务创建成功: ID=task-1763521078684048000-1, State=pending

步骤 3: 提交任务进入审批流程
✓ 任务已提交: State=submitted

步骤 4: 设置初始审批人列表
✓ 初始审批人列表已设置: [manager-001, finance-001]

步骤 5: 加签操作
  说明: 在审批过程中添加额外的审批人
✓ 加签成功: 已添加 tech-lead-001
  当前审批人列表: [manager-001 finance-001 tech-lead-001] (共 3 人)

步骤 6: 转交操作
  说明: 审批人可以将任务转交给其他审批人
✓ 转交成功: manager-001 已转交给 manager-002
  当前审批人列表: [finance-001 tech-lead-001 manager-002] (共 3 人)

步骤 7: 减签操作
  说明: 移除部分审批人(需权限控制)
✓ 减签成功: 已移除 tech-lead-001
  当前审批人列表: [finance-001 manager-002] (共 2 人)

步骤 8: 执行审批操作
  说明: 当前审批人列表为 [manager-002, finance-001],需要全部同意

  1. manager-002 审批
    ✓ manager-002 已同意 (当前状态: approving)

  2. finance-001 审批
    ✓ finance-001 已同意 (当前状态: approved)

✓ 所有审批人已同意,审批流程完成

=== 审批结果 ===
任务 ID: task-1763521078684048000-1
业务 ID: project-001
模板 ID: project-approval-template
当前状态: approved
当前节点: start
创建时间: 2025-11-19 10:57:58
提交时间: 2025-11-19 10:57:58
更新时间: 2025-11-19 10:57:58

任务参数:
  projectNo: PRJ-2025-001
  projectName: 新产品开发项目
  projectManager: pm-001
  budget: 2e+06
  description: 新产品开发项目审批

审批人列表:
  - finance-001
  - manager-002

审批记录(按时间顺序):
  记录 1:
    节点: 项目审批
    审批人: manager-001
    操作类型: 加签
    操作说明: 设置项目经理为审批人
    操作时间: 2025-11-19 10:57:58
  记录 2:
    节点: 项目审批
    审批人: finance-001
    操作类型: 加签
    操作说明: 设置财务审批人
    操作时间: 2025-11-19 10:57:58
  记录 3:
    节点: 项目审批
    审批人: tech-lead-001
    操作类型: 加签
    操作说明: 加签: 添加技术负责人参与审批
    操作时间: 2025-11-19 10:57:58
  记录 4:
    节点: 项目审批
    审批人: manager-001
    操作类型: 转交审批
    操作说明: 项目经理出差,转交给副经理审批
    操作时间: 2025-11-19 10:57:58
  记录 5:
    节点: 项目审批
    审批人: tech-lead-001
    操作类型: 减签
    操作说明: 减签: 技术负责人无需参与审批
    操作时间: 2025-11-19 10:57:58
  记录 6:
    节点: 项目审批
    审批人: manager-002
    操作类型: 审批通过
    操作说明: 副经理审批通过,项目方案可行
    操作时间: 2025-11-19 10:57:58
  记录 7:
    节点: 项目审批
    审批人: finance-001
    操作类型: 审批通过
    操作说明: 财务审批通过,预算合理
    操作时间: 2025-11-19 10:57:58

状态变更历史:
  变更 1: pending -> submitted (原因: task submitted, 时间: 2025-11-19 10:57:58)
  变更 2: approving -> approved (原因: all approvers approved, 时间: 2025-11-19 10:57:58)

=== 验证结果 ===
✓ 任务已成功通过审批
✓ 高级操作统计:
  - 转交操作: 1 次
  - 加签操作: 3 次
  - 减签操作: 1 次
  - 审批操作: 2 次
✓ 最终审批人列表正确: [finance-001 manager-002]
```

**注意**: 
- 任务 ID 是动态生成的,每次运行都会不同
- 时间戳是实际运行时间,每次运行都会不同
- 任务参数中的字段顺序可能因 JSON 解析而有所不同
- 所有高级操作都会生成审批记录,便于追溯和审计

## 验证步骤

1. **验证模板创建**:
   - 检查模板是否包含开始节点、审批节点、结束节点
   - 检查审批节点配置是否正确(操作权限配置)
   - 检查审批模式是否正确(多人会签)

2. **验证任务创建**:
   - 检查任务初始状态是否为 `pending`
   - 检查任务参数是否正确设置(项目信息等)

3. **验证任务提交**:
   - 检查任务状态是否从 `pending` 变为 `submitted`
   - 检查提交时间是否已设置

4. **验证初始审批人设置**:
   - 检查初始审批人列表是否正确设置
   - 检查审批人数量是否正确

5. **验证加签操作**:
   - 检查加签后审批人列表是否正确更新
   - 检查加签记录是否正确生成

6. **验证转交操作**:
   - 检查转交后审批人列表是否正确更新(原审批人被替换为新审批人)
   - 检查转交记录是否正确生成

7. **验证减签操作**:
   - 检查减签后审批人列表是否正确更新(审批人被移除)
   - 检查减签记录是否正确生成

8. **验证审批操作**:
   - 检查审批后任务状态是否正确
   - 检查审批记录是否正确生成

### 验证要点

- ✓ 转交操作成功执行,审批人列表正确更新
- ✓ 加签操作成功执行,审批人列表正确更新
- ✓ 减签操作成功执行,审批人列表正确更新
- ✓ 所有高级操作都生成了审批记录
- ✓ 最终审批人列表正确
- ✓ 任务最终状态为 `approved`
- ✓ 所有审批人都已同意

## 适用场景

这个场景适用于以下实际业务场景:

- **项目审批**: 需要灵活调整审批人的项目审批流程
- **重要决策**: 需要根据情况动态调整审批人的重要决策流程
- **复杂审批**: 审批过程中需要根据实际情况调整审批人的复杂审批流程

## 操作权限说明

操作权限在节点级别配置,可以控制是否允许转交、加签、减签:

- **AllowTransfer**: 是否允许转交审批
- **AllowAddApprover**: 是否允许加签
- **AllowRemoveApprover**: 是否允许减签

如果节点未配置相应的权限,执行对应操作时会返回错误.

## 扩展说明

如果需要扩展此场景,可以考虑:

1. **测试权限控制**: 测试未配置权限时操作是否被拒绝
2. **测试转交后的审批**: 测试转交后新审批人是否可以正常审批
3. **测试加签后的审批**: 测试加签后新审批人是否可以正常审批
4. **测试减签后的审批**: 测试减签后剩余审批人是否可以正常审批
5. **动态审批人**: 结合动态审批人配置,根据项目信息动态确定审批人

## 相关场景

- **场景 01**: 最简单的单人审批流程 - 单个审批人场景
- **场景 02**: 多人会签审批流程 - 所有审批人必须全部同意
- **场景 04**: 动态审批人获取场景 - 可以结合动态审批人实现高级操作

