# 场景 19: 节点输出数据传递场景

## 场景描述

这是一个节点输出数据传递场景示例,演示多阶段审批流程,前一阶段的审批结果作为后一阶段的判断依据.

**业务背景**: 项目评审流程需要多个阶段,前一阶段的审批结果作为后一阶段的判断依据:
- 第一阶段: 技术评审,输出评审结果和评分
- 第二阶段: 根据评分决定是否需要财务审批
- 第三阶段: 根据财务审批结果决定最终审批路径

系统应该支持节点输出数据,后续节点可以读取前面节点的输出数据进行条件判断或动态审批人获取.这种模式适用于多阶段审批流程,阶段间需要数据传递的场景.

## 流程结构

```
开始节点
  ↓
技术评审(输出评分)
  ↓
条件节点1(读取技术评审输出)
  ├─→ [评分>=80] → 财务审批(输出金额评估)
  └─→ [评分<80]  → 直接结束
  ↓
条件节点2(读取财务审批输出)
  ├─→ [金额>=100万] → 总经理审批 → 结束
  └─→ [金额<100万]  → 直接结束
```

流程说明:
1. **开始节点**: 流程的起点,自动执行
2. **技术评审节点**: 第一阶段,技术评审节点
   - 审批模式: 单人审批 (ApprovalModeSingle)
   - 审批人: 技术负责人
   - **输出数据**: 评审结果和评分(JSON 格式)
     - `result`: 评审结果
     - `score`: 评分
     - `comment`: 评审意见
     - `reviewer`: 评审人
3. **条件节点1**: 第二阶段,根据技术评审的评分判断
   - 条件类型: 数值比较 (numeric)
   - 数据源: node_outputs (节点输出数据)
   - 节点ID: tech-review (技术评审节点)
   - 字段: score (评分)
   - 操作符: >= (大于等于)
   - 值: 80
   - True: 跳转到财务审批节点
   - False: 跳转到结束节点
4. **财务审批节点**: 评分>=80时使用
   - 审批模式: 单人审批 (ApprovalModeSingle)
   - 审批人: 财务审批人
   - **输出数据**: 审批结果和金额评估(JSON 格式)
     - `result`: 审批结果
     - `amount`: 金额评估
     - `comment`: 审批意见
     - `reviewer`: 审批人
5. **条件节点2**: 第三阶段,根据财务审批的金额判断
   - 条件类型: 数值比较 (numeric)
   - 数据源: node_outputs (节点输出数据)
   - 节点ID: finance-approval (财务审批节点)
   - 字段: amount (金额)
   - 操作符: >= (大于等于)
   - 值: 1000000 (100万)
   - True: 跳转到总经理审批节点
   - False: 跳转到结束节点
6. **总经理审批节点**: 金额>=100万时使用
   - 审批模式: 单人审批 (ApprovalModeSingle)
   - 审批人: 总经理
7. **结束节点**: 流程的终点

## 关键特性

- **节点输出数据**: 每个节点可以输出 JSON 格式的数据
- **数据传递**: 后续节点可以读取前面节点的输出数据
- **条件判断**: 条件节点可以从节点输出中读取数据进行判断
- **上下文缓存**: 避免重复查询,提高性能

## 代码说明

### 主要组件

1. **模板创建** (`createTemplate`):
   - 创建包含技术评审节点、条件节点、财务审批节点的模板
   - 配置条件节点使用 node_outputs 数据源
   - 配置条件节点从技术评审节点的输出中读取评分

2. **任务创建** (`main`):
   - 创建项目评审任务
   - 传入任务参数(项目编号、项目名称、项目经理、预算、描述等)

3. **流程执行** (`runScenario`):
   - 提交任务进入审批流程
   - 设置技术评审审批人
   - 技术评审(模拟输出评分)
   - 说明条件节点使用节点输出数据

4. **结果输出** (`printResults`):
   - 输出任务状态、审批记录
   - 说明节点输出数据的配置和使用方法

### 代码结构

```go
main()
  ├── 创建管理器 (TemplateManager, TaskManager)
  ├── 创建模板 (createTemplate)
  │   ├── 配置技术评审节点
  │   └── 配置条件节点 (使用 node_outputs 数据源)
  ├── 创建任务 (Create)
  ├── 执行流程 (runScenario)
  │   ├── 提交任务 (Submit)
  │   ├── 设置审批人 (AddApprover)
  │   ├── 技术评审 (Approve)
  │   └── 说明节点输出数据使用
  └── 输出结果 (printResults)
```

### 节点输出数据配置示例

```go
Condition: &node.Condition{
    Type: "numeric",
    Config: &node.NumericConditionConfig{
        Field:    "score",
        Operator: ">=",
        Value:    80,
        Source:   "node_outputs", // 从节点输出中读取
        NodeID:   "tech-review",   // 技术评审节点
    },
}
```

## 执行方法

### 前置要求

- Go 1.25.4 或更高版本
- 已安装 approval-kit 依赖

### 执行步骤

1. 进入场景目录:
   ```bash
   cd examples/19-node-output
   ```

2. 运行程序:
   ```bash
   go run main.go
   ```

### 预期输出

程序运行后会输出以下内容:

```
=== 场景 19: 节点输出数据传递场景 ===

步骤 1: 创建审批模板
✓ 模板创建成功: ID=node-output-template, Name=项目评审审批模板

步骤 2: 创建项目评审任务
✓ 任务创建成功: ID=task-1763522435870588000-1, State=pending

步骤 3: 提交任务进入审批流程
✓ 任务已提交: State=submitted

步骤 4: 设置技术评审审批人
✓ 技术评审人已设置: tech-lead-001

步骤 5: 技术评审(模拟输出评分)
  说明: 技术评审完成后,输出评审结果和评分
  本示例手动设置节点输出数据,模拟技术评审的输出

✓ 技术评审已完成: 评分=85
  节点输出数据(模拟): {
		"result": "approved",
		"score": 85,
		"comment": "技术方案可行,评分85分",
		"reviewer": "tech-lead-001"
	}
  说明: 在实际业务系统中,节点执行器会自动生成并保存节点输出数据
  节点输出数据会保存在任务的 NodeOutputs 字段中

步骤 6: 条件节点1使用节点输出数据(第二阶段)
  说明: 条件节点1配置为从技术评审节点的输出中读取评分
  条件: 评分 >= 80
  结果: 评分=85 >= 80,条件满足
  预期路径: 财务审批路径

步骤 7: 财务审批和第三阶段说明
  说明: 在实际业务系统中,工作流引擎会:
    1. 根据条件节点1的判断结果,将任务推进到财务审批节点
    2. 财务审批完成后,输出审批结果和金额评估
    3. 根据条件节点2的判断结果,决定是否需要总经理审批

  财务审批节点输出数据(模拟):
    {
		"result": "approved",
		"amount": 1500000,
		"comment": "财务审批通过,金额评估150万",
		"reviewer": "finance-001"
	}
  说明: 在实际业务系统中,节点执行器会自动生成并保存节点输出数据

步骤 8: 条件节点2使用节点输出数据(第三阶段)
  说明: 条件节点2配置为从财务审批节点的输出中读取金额
  条件: 金额 >= 100万
  结果: 金额=150万 >= 100万,条件满足
  预期路径: 总经理审批路径

  注意: 本示例仅展示节点输出数据的配置和使用方法
  实际执行需要在实际业务系统中实现条件评估和流程跳转

=== 审批结果 ===
任务 ID: task-1763522435870588000-1
业务 ID: project-review-001
模板 ID: node-output-template
当前状态: approved
当前节点: start
创建时间: 2025-11-19 11:20:35
提交时间: 2025-11-19 11:20:35
更新时间: 2025-11-19 11:20:35

任务参数:
  projectNo: PRJ-2025-001
  projectName: 新产品开发项目
  projectManager: pm-001
  budget: 2e+06
  description: 新产品开发项目评审

节点输出数据:
  无节点输出数据

审批记录:
  记录 1:
    节点: 技术评审
    审批人: tech-lead-001
    操作类型: 加签
    审批意见: 设置技术负责人为评审人
    操作时间: 2025-11-19 11:20:35
  记录 2:
    节点: 技术评审
    审批人: tech-lead-001
    操作类型: 审批通过
    审批意见: 技术评审通过,评分85分
    操作时间: 2025-11-19 11:20:35

状态变更历史:
  变更 1: pending -> submitted (原因: task submitted, 时间: 2025-11-19 11:20:35)
  变更 2: approving -> approved (原因: all approvers approved, 时间: 2025-11-19 11:20:35)

=== 验证结果 ===
✓ 节点输出数据传递功能配置和使用方法已展示(三阶段流程):

  第一阶段: 技术评审节点输出评审结果和评分
    - 技术评审节点可以输出评审结果和评分
    - 输出数据: {result, score, comment, reviewer}

  第二阶段: 条件节点1从技术评审节点的输出中读取评分
    - 条件节点1配置为从技术评审节点的输出中读取评分
    - 条件: 评分 >= 80
    - 根据评分决定是否需要财务审批

  第三阶段: 条件节点2从财务审批节点的输出中读取金额
    - 财务审批节点可以输出审批结果和金额评估
    - 输出数据: {result, amount, comment, reviewer}
    - 条件节点2配置为从财务审批节点的输出中读取金额
    - 条件: 金额 >= 100万
    - 根据金额决定是否需要总经理审批

  节点输出数据配置示例:
    条件节点1:
      Source: node_outputs
      NodeID: tech-review
      Field: score
      Operator: >=
      Value: 80

    条件节点2:
      Source: node_outputs
      NodeID: finance-approval
      Field: amount
      Operator: >=
      Value: 1000000

  说明: 在实际业务系统中,节点执行器会自动生成并保存节点输出数据
  后续节点可以通过 node_outputs 数据源读取前面节点的输出数据
  条件节点、动态审批人等都可以使用节点输出数据
  这种多阶段数据传递模式适用于复杂的审批流程
```

**注意**: 
- 任务 ID 是动态生成的,每次运行都会不同
- 时间戳是实际运行时间,每次运行都会不同
- 任务参数中的字段顺序可能因 JSON 解析而有所不同
- 本示例仅展示节点输出数据的配置和使用方法,实际执行需要在实际业务系统中实现节点执行器自动生成输出数据

## 验证步骤

1. **验证模板创建**:
   - 检查模板是否包含开始节点、技术评审节点、条件节点1、财务审批节点、条件节点2、总经理审批节点、结束节点
   - 检查条件节点1是否配置了 node_outputs 数据源和 NodeID (tech-review)
   - 检查条件节点2是否配置了 node_outputs 数据源和 NodeID (finance-approval)

2. **验证任务创建**:
   - 检查任务初始状态是否为 `pending`
   - 检查任务参数是否正确设置(项目信息等)

3. **验证任务提交**:
   - 检查任务状态是否从 `pending` 变为 `submitted`
   - 检查提交时间是否已设置

4. **验证技术评审**:
   - 检查技术评审是否完成
   - 检查审批记录是否正确生成

5. **验证节点输出数据配置**:
   - 检查条件节点是否配置了 node_outputs 数据源
   - 检查条件节点是否配置了 NodeID 参数(tech-review)
   - 检查条件节点是否配置了正确的字段名(score)

### 验证要点

- ✓ 节点输出数据配置正确 (Source: node_outputs, NodeID: tech-review)
- ✓ 条件节点正确配置从节点输出中读取数据
- ✓ 条件判断逻辑正确(评分 >= 80)
- ✓ 节点输出数据传递功能配置和使用方法已展示

## 节点输出数据说明

### 数据源类型

系统支持以下数据源类型:

- **task_params**: 从任务参数中读取数据
- **node_outputs**: 从节点输出中读取数据(需要指定 NodeID)
- **context**: 从上下文中读取数据(使用缓存)

### 节点输出数据格式

节点输出数据为 JSON 格式,例如:

```json
{
  "result": "approved",
  "score": 85,
  "comment": "技术方案可行,评分85分",
  "reviewer": "tech-lead-001"
}
```

### 使用节点输出数据

**在条件节点中使用**:
```go
Config: &node.NumericConditionConfig{
    Field:    "score",
    Operator: ">=",
    Value:    80,
    Source:   "node_outputs",
    NodeID:   "tech-review",
}
```

**在动态审批人中使用**:
```go
ParamMapping: &node.ParamMapping{
    Source: "node_outputs",
    Path:   "tech-review.score", // 节点ID.字段名
    Target: "score",
}
```

## 适用场景

这个场景适用于以下实际业务场景:

- **多阶段审批**: 多阶段审批流程,阶段间需要数据传递
- **项目评审**: 项目评审流程,评审结果作为后续判断依据
- **方案评估**: 方案评估流程,评估结果影响后续审批路径
- **其他数据传递场景**: 需要节点间数据传递的场景

## 扩展说明

如果需要扩展此场景,可以考虑:

1. **测试多个节点输出**: 测试多个节点都输出数据的情况
2. **测试嵌套字段**: 测试从节点输出的嵌套字段中读取数据
3. **测试动态审批人**: 结合动态审批人配置,使用节点输出数据获取审批人
4. **测试字符串条件**: 使用节点输出数据进行字符串匹配条件判断
5. **测试枚举条件**: 使用节点输出数据进行枚举判断条件判断

## 相关场景

- **场景 03**: 条件分支审批流程 - 可以结合节点输出数据实现更复杂的条件判断
- **场景 04**: 动态审批人获取场景 - 可以使用节点输出数据获取审批人
- **场景 12**: 多条件组合判断场景 - 可以结合节点输出数据实现更复杂的条件判断

