# Approval Kit 使用场景

本文档展示了 Approval Kit 审批流核心库的典型使用场景,从简单到复杂,帮助开发者理解如何使用本库构建审批流程.

## 场景 1: 最简单的单人审批流程

**场景描述**: 请假申请,只需要直接主管审批即可.

**流程结构**:

- 开始节点 → 审批节点(单人审批) → 结束节点

**关键特性**:

- 固定审批人配置
- 单人审批模式
- 基础状态流转: pending → submitted → approving → approved/rejected

**适用场景**: 简单的单级审批,如请假、报销等日常审批.

---

## 场景 2: 多人会签审批流程

**场景描述**: 采购申请,需要财务、采购、总经理全部同意才能通过.

**流程结构**:

- 开始节点 → 审批节点(多人会签) → 结束节点

**关键特性**:

- 多人会签模式: 所有审批人必须全部同意
- 任一审批人拒绝,流程终止
- 支持审批意见和附件

**适用场景**: 需要多个部门共同决策的重要事项,如大额采购、合同审批等.

---

## 场景 3: 条件分支审批流程

**场景描述**: 费用报销,根据金额大小选择不同的审批路径.

- 金额 < 1000: 部门经理审批
- 金额 >= 1000 且 < 5000: 部门经理 → 财务审批
- 金额 >= 5000: 部门经理 → 财务 → 总经理审批

**流程结构**:

- 开始节点 → 条件节点(金额判断) → [审批节点 A/审批节点 B/审批节点 C] → 结束节点

**关键特性**:

- 条件节点: 数值比较条件
- 根据条件结果选择不同的审批路径
- 支持从任务参数中读取条件数据

**适用场景**: 根据业务数据动态选择审批路径的场景,如费用报销、采购审批等.

---

## 场景 4: 动态审批人获取

**场景描述**: 项目立项审批,审批人需要根据项目类型和部门动态获取.

**流程结构**:

- 开始节点 → 审批节点(动态审批人) → 结束节点

**关键特性**:

- 动态审批人配置: 通过 HTTP API 获取审批人列表
- 支持任务创建时或节点激活时获取
- 支持参数映射和响应解析
- API 调用失败自动重试

**适用场景**: 审批人不固定,需要根据业务规则动态确定的场景.

---

## 场景 5: 顺序审批流程

**场景描述**: 员工转正审批,需要按顺序经过直属主管、部门经理、HR、总经理审批.

**流程结构**:

- 开始节点 → 审批节点 1(直属主管) → 审批节点 2(部门经理) → 审批节点 3(HR) → 审批节点 4(总经理) → 结束节点

**关键特性**:

- 顺序审批模式: 前一个审批人同意后,下一个审批人才能审批
- 支持多级审批链
- 每个节点可以配置不同的审批人

**适用场景**: 需要按层级顺序审批的场景,如转正、晋升、离职等 HR 流程.

---

## 场景 6: 比例会签审批流程

**场景描述**: 技术方案评审,5 位技术专家中至少 3 位同意即可通过.

**流程结构**:

- 开始节点 → 审批节点(比例会签) → 结束节点

**关键特性**:

- 比例会签模式: 达到指定比例(3/5)即可通过
- 支持灵活的阈值配置
- 所有审批人拒绝时,流程终止

**适用场景**: 需要多人评审但不需要全部同意的场景,如技术评审、方案评审等.

---

## 场景 7: 拒绝后跳转流程

**场景描述**: 合同审批,如果财务拒绝,可以回退到业务部门重新修改.

**流程结构**:

- 开始节点 → 审批节点 1(业务部门) → 审批节点 2(财务) → 结束节点

**关键特性**:

- 拒绝后行为配置: 回退到上一节点或跳转到指定节点
- 支持拒绝后继续审批流程
- 记录拒绝原因和跳转历史

**适用场景**: 需要支持驳回修改的场景,如合同审批、方案审批等.

---

## 场景 8: 高级操作场景(转交、加签、减签)

**场景描述**: 项目审批过程中,审批人可以转交、加签或减签.

**流程结构**:

- 开始节点 → 审批节点(支持高级操作) → 结束节点

**关键特性**:

- 转交审批: 审批人可以将任务转交给其他审批人
- 加签: 在审批过程中添加额外的审批人
- 减签: 移除部分审批人(需权限控制)
- 操作权限配置: 节点级别控制是否允许这些操作

**适用场景**: 需要灵活调整审批人的场景,如项目审批、重要决策等.

---

## 场景 9: 超时处理场景

**场景描述**: 紧急审批流程,如果审批人在 24 小时内未审批,自动通过或通知.

**流程结构**:

- 开始节点 → 审批节点(配置超时) → 结束节点

**关键特性**:

- 节点超时配置: 支持设置超时时间
- 超时检测机制: 自动检测超时任务
- 超时处理: 自动处理或触发超时事件通知

**适用场景**: 有时间要求的审批流程,如紧急采购、紧急审批等.

---

## 场景 10: 复杂综合审批流程

**场景描述**: 大型项目立项审批,包含多种审批模式、条件分支、动态审批人、超时处理等.

**流程结构**:

```
开始节点
  ↓
条件节点(项目类型判断)
  ├─→ [研发项目] → 审批节点1(技术负责人,动态获取) → 审批节点2(CTO,顺序审批)
  ├─→ [市场项目] → 审批节点3(市场总监,单人审批) → 审批节点4(财务,会签)
  └─→ [其他项目] → 审批节点5(部门经理,或签) → 审批节点6(总经理,比例会签)
  ↓
结束节点
```

**关键特性**:

- 条件节点: 根据项目类型选择不同路径
- 动态审批人: 技术负责人根据项目领域动态获取
- 顺序审批: CTO 审批必须等技术负责人同意后
- 会签模式: 财务审批需要多人全部同意
- 或签模式: 部门经理审批任意一人同意即可
- 比例会签: 总经理审批达到比例即可
- 超时处理: 关键节点配置超时
- 拒绝后跳转: 支持拒绝后回退修改
- 事件通知: 所有关键节点配置 Webhook 通知

**适用场景**: 复杂的企业级审批流程,需要多种审批模式组合使用的场景.

---

## 场景 11: 任务撤回和取消场景

**场景描述**: 提交审批后,在特定条件下可以撤回或取消任务.

**流程结构**:

- 开始节点 → 审批节点 → 结束节点

**关键特性**:

- 任务撤回: 在未产生审批记录前可以撤回
- 任务取消: 随时可以取消任务
- 状态回退: 撤回后状态回退到 pending

**适用场景**: 提交后发现错误需要修改的场景.

---

## 场景 12: 多条件组合判断场景

**场景描述**: 根据多个条件组合判断审批路径,如金额和部门组合.

**流程结构**:

- 开始节点 → 条件节点(组合条件) → [审批路径 A/审批路径 B] → 结束节点

**关键特性**:

- 组合条件: AND/OR 逻辑组合
- 多条件判断: 支持数值、字符串、枚举等多种条件类型
- 复杂业务规则: 支持复杂的业务逻辑判断

**适用场景**: 需要根据多个维度判断审批路径的场景.

---

## 场景 13: 事件通知集成场景

**场景描述**: 审批流程中的关键事件通过 Webhook 推送到业务系统.

**关键特性**:

- 多种事件类型: 任务创建、提交、节点激活、审批操作、任务完成等
- Webhook 配置: 支持多个 Webhook 地址
- 异步推送: 不阻塞主流程
- 重试机制: 推送失败自动重试
- 幂等性保证: 确保事件不重复处理

**适用场景**: 需要与外部系统集成的场景,如通知系统、日志系统、数据分析系统等.

---

## 场景 14: 审批记录查询和分析场景

**场景描述**: 查询任务的审批记录,进行审批效率分析和统计.

**关键特性**:

- 审批记录自动生成: 每次审批操作自动生成记录
- 记录包含完整信息: 审批人、审批结果、审批意见、审批时间、附件等
- 多维度查询: 按状态、模板、业务 ID、审批人、时间范围等查询
- 审批历史追溯: 完整记录审批过程

**适用场景**: 审批数据分析、审批效率统计、审批历史追溯等场景.

---

## 场景 15: 模板版本管理场景

**场景描述**: 审批模板支持版本管理,历史任务使用历史版本模板.

**关键特性**:

- 模板版本控制: 每次更新创建新版本
- 历史版本保留: 已创建的任务使用创建时的模板版本
- 版本查询: 支持查询所有版本
- 版本对比: 支持查看不同版本的差异

**适用场景**: 需要持续优化审批流程,同时保证历史任务可追溯的场景.

---

## 场景 16: 或签模式独立场景

**场景描述**: 紧急采购审批,任意一位采购经理同意即可通过,提高审批效率.

**流程结构**:

- 开始节点 → 审批节点(多人或签) → 结束节点

**关键特性**:

- 或签模式: 多个审批人中任意一人同意即可通过
- 第一个审批人同意后流程立即继续
- 所有审批人拒绝时,流程终止或根据配置跳转
- 适合紧急场景,提高审批效率

**适用场景**: 需要快速决策的紧急审批,如紧急采购、紧急用印等.

---

## 场景 17: 字符串匹配条件场景

**场景描述**: 合同审批,根据合同类型(字符串匹配)选择不同的审批路径.

- 合同类型包含"采购": 需要采购部门审批
- 合同类型以"服务"开头: 需要法务部门审批
- 其他类型: 标准审批流程

**流程结构**:

- 开始节点 → 条件节点(字符串匹配) → [审批路径 A/审批路径 B/审批路径 C] → 结束节点

**关键特性**:

- 字符串匹配条件: 支持等于、包含、以...开始、以...结束等操作符
- 从任务参数中读取字符串字段进行匹配
- 支持复杂的字符串判断逻辑

**适用场景**: 需要根据文本内容进行条件判断的场景,如合同类型、项目名称、部门名称等.

---

## 场景 18: 枚举判断条件场景

**场景描述**: 请假审批,根据请假类型(枚举值)选择不同的审批路径.

- 请假类型为"年假"或"调休": 部门经理审批
- 请假类型为"病假"或"事假": 部门经理 → HR 审批
- 其他类型: 部门经理 → HR → 总经理审批

**流程结构**:

- 开始节点 → 条件节点(枚举判断) → [审批路径 A/审批路径 B/审批路径 C] → 结束节点

**关键特性**:

- 枚举判断条件: 支持 in(在列表中)、not_in(不在列表中)操作符
- 支持多值枚举判断
- 从任务参数中读取枚举字段进行判断

**适用场景**: 需要根据预定义枚举值进行条件判断的场景,如请假类型、项目状态、优先级等.

---

## 场景 19: 节点输出数据传递场景

**场景描述**: 多阶段审批流程,前一阶段的审批结果作为后一阶段的判断依据.

- 第一阶段: 技术评审,输出评审结果和评分
- 第二阶段: 根据评分决定是否需要财务审批
- 第三阶段: 根据评审结果决定最终审批路径

**流程结构**:

- 开始节点 → 审批节点 1(技术评审,输出评分) → 条件节点(读取节点 1 输出) → [审批节点 2/审批节点 3] → 结束节点

**关键特性**:

- 节点输出数据: 每个节点可以输出 JSON 格式的数据
- 数据传递: 后续节点可以读取前面节点的输出数据
- 条件判断: 条件节点可以从节点输出中读取数据进行判断
- 上下文缓存: 避免重复查询,提高性能

**适用场景**: 多阶段审批流程,阶段间需要数据传递的场景,如项目评审、方案评估等.

---

## 场景 20: 审批意见和附件必填场景

**场景描述**: 重要合同审批,要求审批人必须填写审批意见并上传相关附件.

**流程结构**:

- 开始节点 → 审批节点(配置必填) → 结束节点

**关键特性**:

- 审批意见必填: RequireComment 配置,强制要求填写审批意见
- 附件要求必填: RequireAttachments 配置,强制要求上传附件
- 验证机制: 审批操作时自动验证,不符合要求拒绝操作
- 提高审批质量: 确保审批过程有据可查

**适用场景**: 重要审批流程,需要完整审批记录的场景,如合同审批、重大决策等.

---

## 场景 21: 任务创建时获取动态审批人场景

**场景描述**: 项目立项审批,在任务创建时就需要确定所有审批人,便于提前通知.

**流程结构**:

- 开始节点 → 审批节点(任务创建时获取审批人) → 结束节点

**关键特性**:

- 获取时机配置: ApproverTimingOnCreate,任务创建时立即获取审批人
- 提前准备: 在任务提交前就确定审批人列表
- 与节点激活时获取的区别: 创建时获取适合需要提前通知的场景
- 支持参数传递: 从任务参数中获取审批人信息

**适用场景**: 需要提前确定审批人并通知的场景,如项目立项、预算申请等.

---

## 场景 22: 状态变更历史查询场景

**场景描述**: 审计场景,需要查询任务的所有状态变更历史,了解完整的审批过程.

**关键特性**:

- 状态变更历史: StateHistory 记录每次状态变更的详细信息
- 完整追溯: 记录源状态、目标状态、变更原因、变更时间
- 审计支持: 支持审计和合规要求
- 状态回放: 可以完整还原任务的状态流转过程

**适用场景**: 审计、合规、问题排查等需要完整状态追溯的场景.

---

## 场景 23: 基于节点输出的条件判断场景

**场景描述**: 技术方案评审,根据评审节点的输出结果(如评分、建议)决定后续审批路径.

- 评审节点输出评分 >= 80: 直接进入最终审批
- 评审节点输出评分 < 80 且 >= 60: 需要修改后重新评审
- 评审节点输出评分 < 60: 直接拒绝

**流程结构**:

- 开始节点 → 审批节点 1(技术评审,输出评分) → 条件节点(读取节点 1 输出) → [审批节点 2/审批节点 3/结束节点] → 结束节点

**关键特性**:

- 节点输出作为条件: 条件节点可以从前面节点的输出中读取数据
- 动态路径选择: 根据前面节点的执行结果动态选择后续路径
- 数据流转: 实现节点间的数据流转和依赖

**适用场景**: 多阶段评审流程,后续阶段依赖前面阶段结果的场景.

---

## 场景 24: 并发安全场景

**场景描述**: 多个审批人同时审批同一个任务,系统保证并发安全.

**关键特性**:

- 并发安全: 使用读写锁保证并发访问安全
- 状态一致性: 并发状态下保证状态转换的正确性
- 版本控制: 使用版本号机制防止并发修改冲突
- 原子操作: 状态转换是原子操作,不会出现中间状态

**适用场景**: 高并发审批场景,多个审批人同时操作的场景.

---

## 场景 25: 多路径并行审批后汇聚场景

**场景描述**: 项目审批,技术评审和财务评审并行进行,都完成后进入最终审批.

**流程结构**:

```
开始节点
  ↓
条件节点(分支)
  ├─→ 审批节点1(技术评审)
  └─→ 审批节点2(财务评审)
  ↓ (汇聚)
审批节点3(最终审批)
  ↓
结束节点
```

**关键特性**:

- 并行审批: 多个审批路径可以并行执行
- 路径汇聚: 所有路径完成后汇聚到下一个节点
- 灵活组合: 支持复杂的审批流程设计

**适用场景**: 需要多个部门并行审批的场景,如项目审批、合同审批等.

---

## 总结

以上 25 个场景全面展示了 Approval Kit 的核心能力:

1. **基础功能**: 模板管理、任务管理、状态流转
2. **审批模式**: 单人、会签、或签、比例会签、顺序审批
3. **审批人配置**:
   - 固定审批人配置
   - 动态审批人配置(HTTP API)
   - 获取时机控制(任务创建时/节点激活时)
4. **条件分支**:
   - 数值比较条件
   - 字符串匹配条件(等于、包含、以...开始、以...结束)
   - 枚举判断条件(in、not_in)
   - 组合条件(AND/OR)
   - 基于节点输出的条件判断
5. **节点数据传递**: 节点输出数据、节点间数据流转、上下文缓存
6. **高级操作**: 转交、加签、减签、撤回、取消
7. **拒绝处理**: 终止、回退到上一节点、跳转到指定节点
8. **审批配置**:
   - 审批意见必填
   - 附件要求必填
   - 操作权限控制
9. **超时处理**: 节点超时配置、超时检测、超时处理
10. **事件通知**:
    - 多种事件类型(任务创建、提交、节点激活、审批操作、任务完成等)
    - Webhook 推送
    - 异步处理、重试机制、幂等性保证
11. **查询功能**:
    - 多维度任务查询(状态、模板、业务 ID、审批人、时间范围)
    - 审批记录查询
    - 状态变更历史查询
12. **版本管理**: 模板版本控制、历史版本保留、版本查询
13. **并发安全**: 读写锁、版本号机制、原子操作
14. **流程设计**: 顺序审批、并行审批、路径汇聚、条件分支

这些场景可以单独使用,也可以组合使用,满足从简单到复杂的各种审批需求.无论是日常的请假报销,还是复杂的企业级项目审批,Approval Kit 都能提供强大的支持.
