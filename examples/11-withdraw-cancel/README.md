# 场景 11: 任务撤回和取消场景

## 场景描述

这是一个任务撤回和取消场景示例,演示提交审批后,在特定条件下可以撤回或取消任务.

**业务背景**: 在实际业务中,提交审批后可能会发现错误需要修改,或者决定不再需要此申请.系统应该支持任务撤回和取消功能,提供灵活的流程控制.

## 流程结构

```
开始节点 → 审批节点 → 结束节点
```

流程说明:
1. **开始节点**: 流程的起点,自动执行
2. **审批节点**: 审批节点
   - 审批模式: 单人审批 (ApprovalModeSingle)
   - 审批人: 审批人
3. **结束节点**: 流程的终点

## 关键特性

- **任务撤回**: 在未产生审批记录前可以撤回任务
- **任务取消**: 随时可以取消任务(在 pending、submitted 或 approving 状态)
- **状态回退**: 撤回后状态回退到 pending,SubmittedAt 被清空
- **状态终止**: 取消后状态变为 cancelled,无法继续审批

## 代码说明

### 主要组件

1. **模板创建** (`createTemplate`):
   - 创建包含审批节点的模板
   - 配置审批模式为单人审批 (ApprovalModeSingle)

2. **任务撤回演示** (`demonstrateWithdraw`):
   - 创建任务并提交
   - 演示撤回任务
   - 验证撤回后状态回退到 pending

3. **任务取消演示** (`demonstrateCancel`):
   - 创建任务并提交
   - 设置审批人
   - 演示取消任务
   - 验证取消后无法继续审批

4. **结果输出** (`printTaskInfo`):
   - 输出任务状态、审批记录
   - 验证撤回和取消功能

### 代码结构

```go
main()
  ├── 创建管理器 (TemplateManager, TaskManager)
  ├── 创建模板 (createTemplate)
  ├── 演示任务撤回 (demonstrateWithdraw)
  │   ├── 创建任务 (Create)
  │   ├── 提交任务 (Submit)
  │   └── 撤回任务 (Withdraw)
  └── 演示任务取消 (demonstrateCancel)
      ├── 创建任务 (Create)
      ├── 提交任务 (Submit)
      ├── 设置审批人 (AddApprover)
      ├── 取消任务 (Cancel)
      └── 验证取消后无法继续操作
```

### 撤回和取消操作示例

**撤回任务**:
```go
err = taskMgr.Withdraw(tsk.ID, "提交后发现错误,需要修改后重新提交")
```

**取消任务**:
```go
err = taskMgr.Cancel(tsk.ID, "申请人决定取消此申请")
```

## 执行方法

### 前置要求

- Go 1.25.4 或更高版本
- 已安装 approval-kit 依赖

### 执行步骤

1. 进入场景目录:
   ```bash
   cd examples/11-withdraw-cancel
   ```

2. 运行程序:
   ```bash
   go run main.go
   ```

### 预期输出

程序运行后会输出以下内容:

```
=== 场景 11: 任务撤回和取消场景 ===

步骤 1: 创建审批模板
✓ 模板创建成功: ID=withdraw-cancel-template, Name=撤回和取消模板

=== 演示 1: 任务撤回 ===

步骤 1: 创建任务
✓ 任务创建成功: ID=task-1763521461632560000-1, State=pending

步骤 2: 提交任务
✓ 任务已提交: State=submitted

步骤 3: 撤回任务
  说明: 在未产生审批记录前可以撤回任务
  撤回后任务状态回退到 pending,SubmittedAt 被清空

✓ 任务已撤回: State=pending
  SubmittedAt 已清空

=== 撤回后的任务信息 ===
任务 ID: task-1763521461632560000-1
业务 ID: withdraw-001
模板 ID: withdraw-cancel-template
当前状态: pending
当前节点: start
创建时间: 2025-11-19 11:04:21
提交时间: 未提交
更新时间: 2025-11-19 11:04:21

状态变更历史:
  变更 1: pending -> submitted (原因: task submitted, 时间: 2025-11-19 11:04:21)
  变更 2: submitted -> pending (原因: 提交后发现错误,需要修改后重新提交, 时间: 2025-11-19 11:04:21)

审批记录:
  无审批记录

=== 演示 2: 任务取消 ===

步骤 1: 创建任务
✓ 任务创建成功: ID=task-1763521461632824000-2, State=pending

步骤 2: 提交任务
✓ 任务已提交: State=submitted

步骤 3: 设置审批人
✓ 审批人已设置: manager-001

步骤 4: 取消任务
  说明: 任务可以随时取消(在 pending、submitted 或 approving 状态)
  取消后任务状态变为 cancelled,无法继续审批

✓ 任务已取消: State=cancelled

=== 取消后的任务信息 ===
任务 ID: task-1763521461632824000-2
业务 ID: cancel-001
模板 ID: withdraw-cancel-template
当前状态: cancelled
当前节点: start
创建时间: 2025-11-19 11:04:21
提交时间: 2025-11-19 11:04:21
更新时间: 2025-11-19 11:04:21

状态变更历史:
  变更 1: pending -> submitted (原因: task submitted, 时间: 2025-11-19 11:04:21)
  变更 2: submitted -> cancelled (原因: 申请人决定取消此申请, 时间: 2025-11-19 11:04:21)

审批记录:
  记录 1:
    节点: approval
    审批人: manager-001
    操作类型: 加签
    操作说明: 设置审批人
    操作时间: 2025-11-19 11:04:21

步骤 5: 验证取消后无法继续操作
  说明: 取消后的任务无法继续审批
  ✓ 验证通过: 已取消的任务无法继续审批 (错误: invalid state transition: task state "cancelled" cannot be approved)
```

**注意**: 
- 任务 ID 是动态生成的,每次运行都会不同
- 时间戳是实际运行时间,每次运行都会不同
- 任务参数中的字段顺序可能因 JSON 解析而有所不同

## 验证步骤

1. **验证模板创建**:
   - 检查模板是否包含开始节点、审批节点、结束节点
   - 检查审批节点配置是否正确

2. **验证任务撤回**:
   - 检查任务提交后状态是否为 `submitted`
   - 检查撤回后任务状态是否回退到 `pending`
   - 检查撤回后 `SubmittedAt` 是否被清空
   - 检查状态变更历史是否记录了撤回操作

3. **验证任务取消**:
   - 检查任务提交后状态是否为 `submitted`
   - 检查取消后任务状态是否变为 `cancelled`
   - 检查状态变更历史是否记录了取消操作
   - 检查取消后是否无法继续审批

### 验证要点

- ✓ 撤回功能正常工作,状态回退到 pending
- ✓ 撤回后 SubmittedAt 被清空
- ✓ 取消功能正常工作,状态变为 cancelled
- ✓ 取消后无法继续审批
- ✓ 状态变更历史正确记录
- ✓ 审批记录正确生成

## 撤回和取消的区别

### 任务撤回 (Withdraw)

- **适用状态**: `submitted` 或 `approving`
- **前提条件**: 未产生审批记录
- **结果**: 状态回退到 `pending`,`SubmittedAt` 被清空
- **用途**: 提交后发现错误,需要修改后重新提交

### 任务取消 (Cancel)

- **适用状态**: `pending`、`submitted` 或 `approving`
- **前提条件**: 无特殊限制(只要状态允许)
- **结果**: 状态变为 `cancelled`,无法继续审批
- **用途**: 决定不再需要此申请,终止流程

## 适用场景

这个场景适用于以下实际业务场景:

- **任务撤回**: 提交后发现错误需要修改的场景
- **任务取消**: 决定不再需要此申请的场景
- **流程控制**: 需要灵活控制审批流程的场景

## 扩展说明

如果需要扩展此场景,可以考虑:

1. **测试撤回限制**: 测试有审批记录时撤回是否被拒绝
2. **测试取消限制**: 测试已通过、已拒绝、已取消的任务是否无法取消
3. **测试撤回后重新提交**: 撤回后修改任务参数,重新提交
4. **测试取消后查询**: 测试取消后的任务是否可以在查询中正确显示
5. **事件通知**: 配置事件通知器,验证撤回和取消事件是否正确生成

## 相关场景

- **场景 01**: 最简单的单人审批流程 - 单个审批人场景
- **场景 08**: 高级操作场景 - 可以结合转交、加签、减签实现更灵活的流程控制

