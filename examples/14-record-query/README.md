# 场景 14: 审批记录查询和分析场景

## 场景描述

这是一个审批记录查询和分析场景示例,演示查询任务的审批记录,进行审批效率分析和统计.

**业务背景**: 在实际业务中,需要查询和分析审批记录,了解审批效率、审批历史等信息.系统应该支持多维度查询,包括按状态、模板、业务 ID、审批人、时间范围等查询,并提供完整的审批历史追溯.

## 流程结构

```
开始节点 → 审批节点(多人会签) → 结束节点
```

流程说明:
1. **开始节点**: 流程的起点,自动执行
2. **审批节点**: 审批节点
   - 审批模式: 多人会签 (ApprovalModeUnanimous)
   - 审批人: 经理、财务
   - 需要所有审批人全部同意
3. **结束节点**: 流程的终点

## 关键特性

- **审批记录自动生成**: 每次审批操作自动生成记录
- **记录包含完整信息**: 审批人、审批结果、审批意见、审批时间、附件等
- **多维度查询**: 按状态、模板、业务 ID、审批人、时间范围等查询
- **审批历史追溯**: 完整记录审批过程
- **统计分析**: 支持审批效率分析和统计

## 代码说明

### 主要组件

1. **模板创建** (`createTemplate`):
   - 创建包含审批节点的模板
   - 配置审批模式为多人会签 (ApprovalModeUnanimous)

2. **任务创建和处理** (`createAndProcessTasks`):
   - 创建多个任务(已通过、审批中、已拒绝、待审批)
   - 执行不同的审批操作,生成审批记录

3. **多维度查询演示** (`demonstrateQuery`):
   - 按状态查询
   - 按模板查询
   - 按业务 ID 查询
   - 按审批人查询
   - 按时间范围查询
   - 综合查询(多条件组合)

4. **审批记录分析**:
   - 输出每个任务的审批记录详情
   - 统计审批效率信息

### 代码结构

```go
main()
  ├── 创建管理器 (TemplateManager, TaskManager)
  ├── 创建模板 (createTemplate)
  ├── 创建多个任务并执行审批 (createAndProcessTasks)
  │   ├── 任务1: 已通过
  │   ├── 任务2: 审批中
  │   ├── 任务3: 已拒绝
  │   └── 任务4: 待审批
  └── 演示多维度查询 (demonstrateQuery)
      ├── 按状态查询
      ├── 按模板查询
      ├── 按业务ID查询
      ├── 按审批人查询
      ├── 按时间范围查询
      ├── 综合查询
      └── 审批记录分析
```

### 查询示例

**按状态查询**:
```go
filter := &task.TaskFilter{
    State: types.TaskStateApproved,
}
results, err := taskMgr.Query(filter)
```

**按业务ID查询**:
```go
filter := &task.TaskFilter{
    BusinessID: "biz-001",
}
results, err := taskMgr.Query(filter)
```

**按审批人查询**:
```go
filter := &task.TaskFilter{
    Approver: "manager-001",
}
results, err := taskMgr.Query(filter)
```

**综合查询**:
```go
filter := &task.TaskFilter{
    TemplateID: "record-query-template",
    State:      types.TaskStateApproving,
}
results, err := taskMgr.Query(filter)
```

## 执行方法

### 前置要求

- Go 1.25.4 或更高版本
- 已安装 approval-kit 依赖

### 执行步骤

1. 进入场景目录:
   ```bash
   cd examples/14-record-query
   ```

2. 运行程序:
   ```bash
   go run main.go
   ```

### 预期输出

程序运行后会输出以下内容:

```
=== 场景 14: 审批记录查询和分析场景 ===

步骤 1: 创建审批模板
✓ 模板创建成功: ID=record-query-template, Name=审批记录查询模板

步骤 2: 创建多个任务并执行审批
  创建任务1: 已通过
    ✓ 任务1已创建并审批通过: ID=task-1763521836290034000-1, State=approved
  创建任务2: 审批中
    ✓ 任务2已创建并部分审批: ID=task-1763521836290059000-2, State=approving
  创建任务3: 已拒绝
    ✓ 任务3已创建并拒绝: ID=task-1763521836290067000-3, State=rejected
  创建任务4: 待审批
    ✓ 任务4已创建: ID=task-1763521836290073000-4, State=submitted

=== 多维度查询演示 ===

查询1: 按状态查询(已通过)
  结果: 找到 1 个已通过的任务
    - 任务 ID: task-1763521836290034000-1, 业务 ID: biz-001

查询2: 按模板查询
  结果: 找到 4 个任务

查询3: 按业务ID查询(biz-001)
  结果: 找到 1 个任务
    - 任务 ID: task-1763521836290034000-1, 状态: approved
    - 审批记录数: 4

查询4: 按审批人查询(manager-001)
  结果: 找到 3 个任务
    - 任务 ID: task-1763521836290034000-1, 状态: approved
    - 任务 ID: task-1763521836290059000-2, 状态: approving
    - 任务 ID: task-1763521836290067000-3, 状态: rejected

查询5: 按时间范围查询(最近1小时)
  结果: 找到 4 个任务

查询6: 综合查询(模板+状态)
  结果: 找到 1 个审批中的任务

=== 审批记录分析 ===

任务 1: ID=task-1763521836290034000-1, 状态=approved
  审批记录数: 4
  审批记录详情:
    记录 1:
      节点: approval
      审批人: manager-001
      操作类型: 加签
      审批意见: 设置审批人
      操作时间: 2025-11-19 11:10:36
    记录 2:
      节点: approval
      审批人: finance-001
      操作类型: 加签
      审批意见: 设置审批人
      操作时间: 2025-11-19 11:10:36
    记录 3:
      节点: approval
      审批人: manager-001
      操作类型: 审批通过
      审批意见: 经理审批通过
      操作时间: 2025-11-19 11:10:36
    记录 4:
      节点: approval
      审批人: finance-001
      操作类型: 审批通过
      审批意见: 财务审批通过
      操作时间: 2025-11-19 11:10:36

任务 2: ID=task-1763521836290059000-2, 状态=approving
  审批记录数: 3
  审批记录详情:
    记录 1:
      节点: approval
      审批人: manager-001
      操作类型: 加签
      审批意见: 设置审批人
      操作时间: 2025-11-19 11:10:36
    记录 2:
      节点: approval
      审批人: finance-001
      操作类型: 加签
      审批意见: 设置审批人
      操作时间: 2025-11-19 11:10:36
    记录 3:
      节点: approval
      审批人: manager-001
      操作类型: 审批通过
      审批意见: 经理审批通过
      操作时间: 2025-11-19 11:10:36

任务 3: ID=task-1763521836290067000-3, 状态=rejected
  审批记录数: 2
  审批记录详情:
    记录 1:
      节点: approval
      审批人: manager-001
      操作类型: 加签
      审批意见: 设置审批人
      操作时间: 2025-11-19 11:10:36
    记录 2:
      节点: approval
      审批人: manager-001
      操作类型: 审批拒绝
      审批意见: 经理拒绝
      操作时间: 2025-11-19 11:10:36

任务 4: ID=task-1763521836290073000-4, 状态=submitted
  审批记录数: 0

=== 统计信息 ===

  总任务数: 4
  已通过: 1
  审批中: 1
  已拒绝: 1
  待审批: 1
  总审批记录数: 9
  平均审批记录数: 2.25
```

**注意**: 
- 任务 ID 是动态生成的,每次运行都会不同
- 时间戳是实际运行时间,每次运行都会不同
- 任务参数中的字段顺序可能因 JSON 解析而有所不同

## 验证步骤

1. **验证任务创建**:
   - 检查是否创建了4个任务(已通过、审批中、已拒绝、待审批)
   - 检查每个任务的状态是否正确

2. **验证审批记录生成**:
   - 检查每个任务的审批记录是否正确生成
   - 检查审批记录是否包含完整信息(节点、审批人、操作类型、审批意见、操作时间)

3. **验证多维度查询**:
   - 检查按状态查询是否正确
   - 检查按模板查询是否正确
   - 检查按业务ID查询是否正确
   - 检查按审批人查询是否正确
   - 检查按时间范围查询是否正确
   - 检查综合查询是否正确

4. **验证统计分析**:
   - 检查统计信息是否正确(总任务数、各状态任务数、总审批记录数、平均审批记录数)

### 验证要点

- ✓ 审批记录自动生成
- ✓ 审批记录包含完整信息
- ✓ 多维度查询功能正常
- ✓ 综合查询功能正常
- ✓ 统计分析功能正常

## 查询维度说明

系统支持以下查询维度:

- **按状态查询**: 查询指定状态的任务
- **按模板查询**: 查询指定模板的任务
- **按业务ID查询**: 查询指定业务ID的任务
- **按审批人查询**: 查询指定审批人参与的任务
- **按时间范围查询**: 查询指定时间范围内创建的任务
- **综合查询**: 支持多条件组合查询

## 审批记录信息

每个审批记录包含以下信息:

- **ID**: 记录 ID
- **TaskID**: 任务 ID
- **NodeID**: 节点 ID
- **Approver**: 审批人
- **Result**: 审批结果(approve、reject、transfer、add_approver、remove_approver)
- **Comment**: 审批意见
- **CreatedAt**: 审批时间
- **Attachments**: 附件列表

## 适用场景

这个场景适用于以下实际业务场景:

- **审批数据分析**: 分析审批效率、审批时长等
- **审批效率统计**: 统计各审批人的审批效率
- **审批历史追溯**: 查询历史审批记录,了解审批过程
- **审批报表生成**: 基于审批记录生成各种报表

## 扩展说明

如果需要扩展此场景,可以考虑:

1. **测试更多查询条件**: 测试更多查询条件的组合
2. **测试审批记录过滤**: 根据审批记录内容过滤任务
3. **测试审批时长统计**: 统计每个任务的审批时长
4. **测试审批人效率分析**: 分析每个审批人的审批效率
5. **测试审批记录导出**: 导出审批记录到文件或数据库

## 相关场景

- **场景 01**: 最简单的单人审批流程 - 可以结合查询功能实现完整的审批流程
- **场景 02**: 多人会签审批流程 - 会签流程会产生多条审批记录
- **场景 08**: 高级操作场景 - 高级操作也会生成审批记录

