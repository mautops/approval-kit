# 场景 02: 多人会签审批流程

## 场景描述

这是一个多人会签审批流程示例,模拟采购申请场景.采购申请需要财务、采购、总经理三个部门全部同意才能通过.

**业务背景**: 部门需要采购办公设备,金额 50000 元.提交采购申请后,需要依次经过财务部门(审核预算)、采购部门(审核供应商)、总经理(最终审批)三个部门的审批.只有所有部门都同意,采购申请才能通过.

## 流程结构

```
开始节点 → 审批节点(多人会签) → 结束节点
```

流程说明:

1. **开始节点**: 流程的起点,自动执行
2. **审批节点**: 多人会签审批节点
   - 审批模式: 多人会签 (ApprovalModeUnanimous)
   - 审批人: finance-001(财务)、purchase-001(采购)、manager-001(总经理)
   - 审批规则: 所有审批人必须全部同意才能通过
   - 拒绝行为: 任一审批人拒绝,流程立即终止
3. **结束节点**: 流程的终点,任务状态变为已通过或已拒绝

## 关键特性

- **多人会签模式**: 使用 ApprovalModeUnanimous,所有审批人必须全部同意
- **固定审批人配置**: 使用 FixedApproverConfig 配置多个固定审批人
- **全部同意规则**: 只有所有审批人都同意,流程才能继续
- **拒绝即终止**: 任一审批人拒绝,流程立即终止(RejectBehaviorTerminate)
- **审批记录生成**: 每个审批人的操作都会生成独立的审批记录
- **状态流转**: `pending` → `submitted` → `approving` → `approved`(全部同意) 或 `rejected`(有人拒绝)

## 代码说明

### 主要组件

1. **模板创建** (`createTemplate`):

   - 创建包含开始节点、审批节点、结束节点的模板
   - 配置审批节点为多人会签模式
   - 设置三个固定审批人: 财务、采购、总经理
   - 配置拒绝行为为终止流程

2. **任务创建** (`main`):

   - 创建采购申请任务
   - 传入任务参数(物品、金额、原因、供应商)

3. **流程执行** (`runScenario`):

   - 提交任务进入审批流程
   - 依次执行三个审批人的审批操作
   - 展示会签过程(已审批人数/总人数)

4. **结果输出** (`printResults`):
   - 输出任务状态、审批记录、审批人状态
   - 验证所有审批人都已同意

### 代码结构

```go
main()
  ├── 创建管理器 (TemplateManager, TaskManager)
  ├── 创建模板 (createTemplate)
  ├── 创建任务 (Create)
  ├── 执行流程 (runScenario)
  │   ├── 提交任务 (Submit)
  │   └── 执行多人会签审批 (Approve × 3)
  └── 输出结果 (printResults)
```

## 执行方法

### 前置要求

- Go 1.25.4 或更高版本
- 已安装 approval-kit 依赖

### 执行步骤

1. 进入场景目录:

   ```bash
   cd examples/02-unanimous-approval
   ```

2. 运行程序:
   ```bash
   go run main.go
   ```

### 预期输出

程序运行后会输出以下内容:

```
=== 场景 02: 多人会签审批流程 ===

步骤 1: 创建审批模板
✓ 模板创建成功: ID=purchase-approval-template, Name=采购审批模板

步骤 2: 创建采购申请任务
✓ 任务创建成功: ID=task-1763518851511810000-1, State=pending

步骤 3: 提交任务进入审批流程
✓ 任务已提交: State=submitted, CurrentNode=start

步骤 3.5: 设置审批人列表
✓ 审批人列表已设置: finance-001, purchase-001, manager-001

步骤 4: 执行多人会签审批
  说明: 需要财务、采购、总经理全部同意才能通过

  4.1 财务审批
  ✓ 财务已同意 (当前状态: approving, 已审批: 1/3)
  4.2 采购审批
  ✓ 采购已同意 (当前状态: approving, 已审批: 2/3)
  4.3 总经理审批
  ✓ 总经理已同意 (当前状态: approved, 已审批: 3/3)

✓ 所有审批人已同意,审批流程完成

=== 审批结果 ===
任务 ID: task-1763518851511810000-1
业务 ID: purchase-001
模板 ID: purchase-approval-template
当前状态: approved
当前节点: start
创建时间: 2025-11-19 10:20:51
提交时间: 2025-11-19 10:20:51
更新时间: 2025-11-19 10:20:51

任务参数:
  item: 办公设备
  amount: 50000
  reason: 部门办公设备采购
  supplier: XX供应商

审批记录:
  记录 1:
    节点 ID: unanimous-approval
    审批人: finance-001
    审批结果: add_approver
    审批意见: 设置财务审批人
    审批时间: 2025-11-19 10:20:51
  记录 2:
    节点 ID: unanimous-approval
    审批人: purchase-001
    审批结果: add_approver
    审批意见: 设置采购审批人
    审批时间: 2025-11-19 10:20:51
  记录 3:
    节点 ID: unanimous-approval
    审批人: manager-001
    审批结果: add_approver
    审批意见: 设置总经理审批人
    审批时间: 2025-11-19 10:20:51
  记录 4:
    节点 ID: unanimous-approval
    审批人: finance-001
    审批结果: approve
    审批意见: 财务审核通过,预算充足
    审批时间: 2025-11-19 10:20:51
  记录 5:
    节点 ID: unanimous-approval
    审批人: purchase-001
    审批结果: approve
    审批意见: 采购审核通过,供应商资质合格
    审批时间: 2025-11-19 10:20:51
  记录 6:
    节点 ID: unanimous-approval
    审批人: manager-001
    审批结果: approve
    审批意见: 总经理审批通过
    审批时间: 2025-11-19 10:20:51

审批人列表和审批状态:
  finance-001: approve (财务审核通过,预算充足)
  purchase-001: approve (采购审核通过,供应商资质合格)
  manager-001: approve (总经理审批通过)

状态变更历史:
  变更 1: pending -> submitted (原因: task submitted, 时间: 2025-11-19 10:20:51)
  变更 2: approving -> approved (原因: all approvers approved, 时间: 2025-11-19 10:20:51)

=== 验证结果 ===
✓ 任务已成功通过审批
✓ 已生成 6 条审批记录(财务、采购、总经理)
✓ 所有审批人都已同意(会签完成)
```

**注意**:

- 任务 ID 是动态生成的,每次运行都会不同
- 时间戳是实际运行时间,每次运行都会不同
- 任务参数中的字段顺序可能因 JSON 解析而有所不同
- 审批记录包含 3 条 `add_approver` 记录(设置审批人)和 3 条 `approve` 记录(审批操作),这是正常的,因为需要先设置审批人列表才能进行审批

## 验证步骤

1. **验证模板创建**:

   - 检查模板是否包含开始节点、审批节点、结束节点
   - 检查审批节点配置是否正确(多人会签模式、三个审批人)
   - 检查拒绝行为配置为终止流程

2. **验证任务创建**:

   - 检查任务初始状态是否为 `pending`
   - 检查任务参数是否正确设置

3. **验证任务提交**:

   - 检查任务状态是否从 `pending` 变为 `submitted`
   - 检查提交时间是否已设置

4. **验证会签审批过程**:

   - 检查第一个审批人审批后,任务状态是否为 `approving`
   - 检查第二个审批人审批后,任务状态仍为 `approving`(未完成)
   - 检查第三个审批人审批后,任务状态是否变为 `approved`(完成)

5. **验证审批记录**:

   - 检查是否生成了 3 条审批记录
   - 检查每条审批记录内容是否正确(节点 ID、审批人、审批结果、审批意见)
   - 检查审批记录中的审批人是否分别为财务、采购、总经理

6. **验证审批人状态**:

   - 检查所有审批人都已同意
   - 检查审批人列表和审批状态输出是否正确

7. **验证状态变更历史**:
   - 检查状态变更历史是否记录了状态转换
   - 检查状态转换路径: `pending` → `submitted` → `approving` → `approved`

### 验证要点

- ✓ 任务最终状态为 `approved`
- ✓ 至少生成 6 条审批记录(3 条 add_approver + 3 条 approve)
- ✓ 有 3 条审批记录的审批结果为 `approve`(财务、采购、总经理的审批操作)
- ✓ 审批记录中的审批人分别为 `finance-001`、`purchase-001`、`manager-001`
- ✓ 所有审批人都已同意(会签完成)
- ✓ 状态变更历史包含状态转换记录
- ✓ 所有时间字段都已正确设置

## 适用场景

这个场景适用于以下实际业务场景:

- **大额采购审批**: 需要多个部门共同决策的采购申请
- **合同审批**: 需要财务、法务、业务部门全部同意的合同审批
- **重要决策**: 需要多个部门共同决策的重要事项
- **预算审批**: 需要财务、业务、管理层全部同意的预算申请

## 扩展说明

如果需要扩展此场景,可以考虑:

1. **演示拒绝场景**: 展示任一审批人拒绝后流程终止的情况
2. **添加审批意见必填**: 配置 RequireComment 要求必须填写审批意见
3. **添加附件要求**: 配置 RequireAttachments 要求必须上传附件
4. **拒绝后跳转**: 配置 RejectBehaviorJump,演示拒绝后跳转到指定节点
5. **拒绝后回退**: 配置 RejectBehaviorRollback,演示拒绝后回退到上一节点

## 相关场景

- **场景 01**: 最简单的单人审批流程 - 单级审批场景
- **场景 06**: 比例会签审批流程 - 达到比例即可通过的场景
- **场景 16**: 或签模式独立场景 - 任意一人同意即可通过的场景
- **场景 25**: 多路径并行审批后汇聚场景 - 多个部门并行审批的场景
