# 场景 25: 多路径并行审批后汇聚场景

## 场景描述

这是一个多路径并行审批后汇聚场景示例,演示如何配置多个审批路径并行执行,并在所有路径完成后汇聚到下一个节点.

**业务背景**: 项目审批流程中,技术评审和财务评审可以并行进行,两个评审都完成后才能进入最终审批.这种并行审批模式可以提高审批效率,缩短审批周期.

## 流程结构

```
开始节点
  ↓
├─→ 技术评审节点 (tech-review)
└─→ 财务评审节点 (finance-review)
  ↓ (汇聚)
最终审批节点 (final-approval)
  ↓
结束节点
```

流程说明:
1. **开始节点**: 流程的起点,自动执行
2. **技术评审节点**: 技术评审,并行执行
   - 审批模式: 单人审批 (ApprovalModeSingle)
   - 审批人: tech-lead-001
3. **财务评审节点**: 财务评审,并行执行
   - 审批模式: 单人审批 (ApprovalModeSingle)
   - 审批人: finance-001
4. **最终审批节点**: 最终审批(汇聚后)
   - 审批模式: 单人审批 (ApprovalModeSingle)
   - 审批人: manager-001
   - 前置条件: 技术评审和财务评审都完成
5. **结束节点**: 流程的终点

## 关键特性

- **并行审批**: 多个审批路径可以并行执行
- **路径汇聚**: 所有路径完成后汇聚到下一个节点
- **灵活组合**: 支持复杂的审批流程设计
- **效率提升**: 并行审批可以缩短审批周期

## 代码说明

### 主要组件

1. **模板创建** (`createTemplate`):
   - 创建技术评审节点和财务评审节点(并行路径)
   - 创建最终审批节点(汇聚节点)
   - 配置节点间的连接关系(Edges)

2. **场景执行** (`runScenario`):
   - 创建任务
   - 提交任务
   - 说明并行审批流程
   - 说明汇聚逻辑
   - 输出审批结果

3. **结果输出**:
   - 输出任务基本信息
   - 输出审批记录
   - 验证并行审批流程

### 代码结构

```go
main()
  ├── 创建管理器 (TemplateManager, TaskManager)
  ├── 创建模板 (createTemplate)
  │   ├── 技术评审节点 (tech-review)
  │   ├── 财务评审节点 (finance-review)
  │   ├── 最终审批节点 (final-approval)
  │   └── 节点连接关系 (Edges)
  └── 运行场景 (runScenario)
      ├── 创建任务
      ├── 提交任务
      ├── 说明并行审批流程
      ├── 说明汇聚逻辑
      └── 输出结果 (printResults)
```

### 模板配置示例

```go
Edges: []*template.Edge{
    // 开始节点分支到两个并行审批节点
    {From: "start", To: "tech-review"},
    {From: "start", To: "finance-review"},
    // 两个并行审批节点汇聚到最终审批节点
    {From: "tech-review", To: "final-approval"},
    {From: "finance-review", To: "final-approval"},
    // 最终审批节点到结束节点
    {From: "final-approval", To: "end"},
}
```

### 并行分支和汇聚说明

**并行分支**:
- 开始节点可以连接到多个审批节点
- 这些审批节点可以并行执行
- 每个审批节点独立完成自己的审批流程

**汇聚逻辑**:
- 最终审批节点有多个前置节点
- 只有当所有前置节点都完成时,才能进入最终审批节点
- 这需要工作流引擎监控节点完成状态并触发汇聚

## 执行方法

### 前置要求

- Go 1.25.4 或更高版本
- 已安装 approval-kit 依赖

### 执行步骤

1. 进入场景目录:
   ```bash
   cd examples/25-parallel-merge
   ```

2. 运行程序:
   ```bash
   go run main.go
   ```

### 预期输出

程序运行后会输出以下内容:

```
=== 场景 25: 多路径并行审批后汇聚场景 ===

✓ 模板创建成功: ID=parallel-merge-template, Name=多路径并行审批模板

✓ 任务创建成功: ID=task-1763523812915465000-1
✓ 任务已提交

=== 并行审批流程说明 ===
流程结构:
  开始节点
    ↓
  ├─→ 技术评审节点 (tech-review)
  └─→ 财务评审节点 (finance-review)
    ↓ (汇聚)
  最终审批节点 (final-approval)
    ↓
  结束节点

并行审批说明:
  1. 任务提交后,技术评审和财务评审可以并行进行
  2. 两个评审节点都完成后,才能进入最终审批
  3. 最终审批通过后,流程结束

=== 模拟并行审批 ===
注意: 当前示例主要展示多路径并行审批的配置方式.
由于当前库不包含工作流引擎,无法自动处理并行分支和汇聚逻辑.
在实际业务系统中,需要工作流引擎来:
  1. 监控并行节点的完成状态
  2. 等待所有并行节点完成后触发汇聚
  3. 将任务推进到下一个节点

步骤 1: 设置审批人
✓ 技术评审人已设置: tech-lead-001
✓ 财务评审人已设置: finance-001

步骤 2: 并行审批说明
  在实际业务系统中:
    - 技术评审和财务评审可以同时进行
    - 两个评审节点都完成后,才能进入最终审批
    - 工作流引擎会监控节点完成状态并触发汇聚

  在当前示例中:
    - 由于缺少工作流引擎,无法实现真正的并行分支和汇聚
    - 第一个节点审批完成后,任务状态会立即变为 approved
    - 这导致第二个节点无法继续审批
    - 此示例主要展示模板配置和节点结构

=== 汇聚逻辑说明 ===
在实际业务系统中,工作流引擎会:
  1. 监控两个并行审批节点的完成状态
  2. 当两个节点都完成时,自动触发汇聚逻辑
  3. 将任务推进到最终审批节点
  4. 最终审批节点激活,等待审批

汇聚逻辑的关键点:
  - 需要等待所有并行路径都完成
  - 只有当所有前置节点都完成时,才能进入下一个节点
  - 这需要工作流引擎的状态管理和节点依赖跟踪

=== 审批结果 ===
任务 ID: task-1763523812915465000-1
业务 ID: project-001
模板 ID: parallel-merge-template
当前状态: submitted
当前节点: start

审批记录 (共 2 条):
  1. 节点: tech-review, 审批人: tech-lead-001, 结果: add_approver, 意见: 设置技术评审人
  2. 节点: finance-review, 审批人: finance-001, 结果: add_approver, 意见: 设置财务评审人

=== 验证并行审批 ===
技术评审通过数: 0 (期望: 1)
财务评审通过数: 0 (期望: 1)
最终审批通过数: 0 (期望: 1)
⚠ 并行审批流程验证未完全通过

注意: 此示例主要展示多路径并行审批的配置方式.
在实际业务系统中,并行分支和汇聚逻辑需要工作流引擎的支持.
```

**注意**: 
- 任务 ID 是动态生成的,每次运行都会不同
- 此示例主要展示多路径并行审批的配置方式
- 在实际业务系统中,并行分支和汇聚逻辑需要工作流引擎的支持
- 当前库不包含工作流引擎,无法自动处理并行分支和汇聚

## 验证步骤

1. **验证模板创建**:
   - 检查模板是否包含技术评审节点、财务评审节点、最终审批节点
   - 检查节点连接关系是否正确(并行分支和汇聚)

2. **验证任务创建**:
   - 检查任务初始状态是否为 `pending`
   - 检查任务参数是否正确设置

3. **验证并行审批配置**:
   - 检查两个并行审批节点的配置是否正确
   - 检查汇聚节点的配置是否正确

### 验证要点

- ✓ 模板配置正确: 包含并行分支和汇聚节点
- ✓ 节点连接关系正确: 开始节点分支到两个并行节点,两个并行节点汇聚到最终审批节点
- ✓ 节点配置正确: 每个审批节点都有正确的审批模式和审批人配置

## 并行分支和汇聚说明

### 并行分支

并行分支是指从同一个节点可以同时进入多个后续节点:

- **配置方式**: 在 `Edges` 中配置多个 `From` 相同的边
- **执行方式**: 工作流引擎会同时激活所有后续节点
- **适用场景**: 需要多个部门并行审批的场景

### 汇聚逻辑

汇聚是指多个节点完成后才能进入下一个节点:

- **配置方式**: 在 `Edges` 中配置多个 `To` 相同的边
- **执行方式**: 工作流引擎会监控所有前置节点的完成状态
- **触发条件**: 只有当所有前置节点都完成时,才触发汇聚
- **适用场景**: 需要等待所有并行路径完成的场景

### 工作流引擎支持

并行分支和汇聚需要工作流引擎的支持:

1. **节点状态管理**: 跟踪每个节点的完成状态
2. **依赖关系跟踪**: 跟踪节点间的依赖关系
3. **汇聚触发**: 当所有前置节点完成时,触发汇聚逻辑
4. **任务推进**: 将任务推进到下一个节点

## 适用场景

这个场景适用于以下实际业务场景:

- **项目审批**: 技术评审和财务评审并行进行
- **合同审批**: 法务评审和财务评审并行进行
- **采购审批**: 技术评审、财务评审、采购评审并行进行
- **多部门协同**: 需要多个部门并行审批的场景

## 扩展说明

如果需要扩展此场景,可以考虑:

1. **测试更多并行路径**: 测试三个或更多并行路径的场景
2. **测试复杂汇聚**: 测试多个汇聚点的场景
3. **测试条件汇聚**: 测试基于条件的汇聚逻辑
4. **测试部分汇聚**: 测试部分路径完成即可汇聚的场景
5. **测试嵌套并行**: 测试并行路径中嵌套并行路径的场景

## 相关场景

- **场景 02**: 多人会签审批流程 - 展示了多人审批的基本使用方式
- **场景 03**: 条件分支审批流程 - 展示了条件分支的使用方式
- **场景 10**: 复杂综合审批流程 - 展示了复杂流程的组合使用方式

## 工作流引擎集成说明

要实现完整的并行分支和汇聚功能,需要集成工作流引擎:

1. **节点执行引擎**: 负责执行节点逻辑,管理节点状态
2. **流程控制引擎**: 负责流程推进,处理分支和汇聚
3. **状态管理**: 跟踪任务和节点的状态
4. **依赖管理**: 管理节点间的依赖关系

当前库提供了:
- 审批模板和节点的数据结构
- 审批任务的状态管理
- 审批操作的基本接口

工作流引擎需要在此基础上实现:
- 节点自动执行
- 流程自动推进
- 并行分支和汇聚逻辑
- 条件判断和路径选择

## 最佳实践

1. **合理设计并行路径**: 确保并行路径之间没有依赖关系
2. **明确汇聚条件**: 明确汇聚的触发条件和完成标准
3. **监控节点状态**: 实时监控并行节点的完成状态
4. **处理异常情况**: 处理节点失败、超时等异常情况
5. **优化审批效率**: 通过并行审批提高审批效率

