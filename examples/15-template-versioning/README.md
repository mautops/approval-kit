# 场景 15: 模板版本管理场景

## 场景描述

这是一个模板版本管理场景示例,演示审批模板支持版本管理,历史任务使用历史版本模板.

**业务背景**: 在实际业务中,审批流程需要持续优化和改进.系统应该支持模板版本管理,每次更新创建新版本,同时保留历史版本,确保历史任务使用创建时的模板版本,保证审批流程的可追溯性.

## 流程结构

**版本1**: 开始节点 → 审批节点(单人审批) → 结束节点

**版本2**: 开始节点 → 审批节点(多人会签) → 结束节点

**版本3**: 开始节点 → 条件节点 → [高级审批/普通审批] → 结束节点

流程说明:
- **版本1**: 单人审批模式
- **版本2**: 改为多人会签模式
- **版本3**: 添加条件节点,根据金额选择不同审批路径

## 关键特性

- **模板版本控制**: 每次更新创建新版本,原版本保持不变
- **历史版本保留**: 已创建的任务使用创建时的模板版本
- **版本查询**: 支持查询所有版本
- **版本对比**: 支持查看不同版本的差异

## 代码说明

### 主要组件

1. **模板版本1创建** (`createTemplateV1`):
   - 创建初始模板版本1
   - 配置为单人审批模式

2. **模板版本2创建** (`createTemplateV2`):
   - 使用 Update 方法更新模板
   - 自动递增版本号到版本2
   - 改为多人会签模式

3. **模板版本3创建** (`createTemplateV3`):
   - 使用 Update 方法更新模板
   - 自动递增版本号到版本3
   - 添加条件节点,实现条件分支

4. **版本管理演示**:
   - 使用不同版本创建任务
   - 查询所有版本
   - 获取不同版本的模板
   - 验证历史任务使用历史版本
   - 对比不同版本的差异

### 代码结构

```go
main()
  ├── 创建管理器 (TemplateManager, TaskManager)
  ├── 创建模板版本1 (createTemplateV1)
  ├── 使用版本1创建任务
  ├── 更新模板到版本2 (createTemplateV2)
  ├── 使用版本2创建任务
  ├── 更新模板到版本3 (createTemplateV3)
  ├── 使用版本3创建任务
  ├── 查询所有版本 (ListVersions)
  ├── 获取不同版本的模板 (Get)
  ├── 验证历史任务使用历史版本 (verifyTaskTemplate)
  └── 版本对比 (compareVersions)
```

### 版本管理示例

**创建模板**:
```go
tpl := createTemplateV1()
err := templateMgr.Create(tpl)
```

**更新模板**:
```go
tpl2 := createTemplateV2()
err := templateMgr.Update(tpl1.ID, tpl2) // 自动递增版本号
```

**查询所有版本**:
```go
versions, err := templateMgr.ListVersions(templateID)
```

**获取指定版本**:
```go
tpl, err := templateMgr.Get(templateID, version) // version=0 表示最新版本
```

## 执行方法

### 前置要求

- Go 1.25.4 或更高版本
- 已安装 approval-kit 依赖

### 执行步骤

1. 进入场景目录:
   ```bash
   cd examples/15-template-versioning
   ```

2. 运行程序:
   ```bash
   go run main.go
   ```

### 预期输出

程序运行后会输出以下内容:

```
=== 场景 15: 模板版本管理场景 ===

步骤 1: 创建模板版本1
✓ 模板版本1创建成功: ID=versioning-template, Version=1, Name=版本管理模板 V1

步骤 2: 使用版本1创建任务
✓ 任务1创建成功: ID=task-1763521952402228000-1, TemplateVersion=1

步骤 3: 更新模板到版本2
✓ 模板已更新到版本2: ID=versioning-template, Version=0, Name=版本管理模板 V2

步骤 4: 使用版本2创建任务
✓ 任务2创建成功: ID=task-1763521952402236000-2, TemplateVersion=2

步骤 5: 更新模板到版本3
✓ 模板已更新到版本3: ID=versioning-template, Version=0, Name=版本管理模板 V3

步骤 6: 使用版本3创建任务
✓ 任务3创建成功: ID=task-1763521952402241000-3, TemplateVersion=3

步骤 7: 查询所有版本
✓ 模板共有 3 个版本: [1 2 3]

步骤 8: 获取不同版本的模板
  版本 1: Name=版本管理模板 V1, CreatedAt=2025-11-19 11:12:32, UpdatedAt=2025-11-19 11:12:32
  版本 2: Name=版本管理模板 V2, CreatedAt=2025-11-19 11:12:32, UpdatedAt=2025-11-19 11:12:32
  版本 3: Name=版本管理模板 V3, CreatedAt=2025-11-19 11:12:32, UpdatedAt=2025-11-19 11:12:32

步骤 9: 验证历史任务使用历史版本
  任务1使用模板版本1:
    任务 ID: task-1763521952402228000-1
    模板 ID: versioning-template
    模板版本: 1 (期望: 1)
    模板名称: 版本管理模板 V1
    ✓ 版本匹配正确

  任务2使用模板版本2:
    任务 ID: task-1763521952402236000-2
    模板 ID: versioning-template
    模板版本: 2 (期望: 2)
    模板名称: 版本管理模板 V2
    ✓ 版本匹配正确

  任务3使用模板版本3:
    任务 ID: task-1763521952402241000-3
    模板 ID: versioning-template
    模板版本: 3 (期望: 3)
    模板名称: 版本管理模板 V3
    ✓ 版本匹配正确

步骤 10: 版本对比
  版本对比:

  版本 1: 版本管理模板 V1
    描述: 版本1: 单人审批
    节点数: 3
    边数: 2
    节点类型分布: end:1 start:1 approval:1

  版本 2: 版本管理模板 V2
    描述: 版本2: 多人会签
    节点数: 3
    边数: 2
    节点类型分布: end:1 start:1 approval:1

  版本 3: 版本管理模板 V3
    描述: 版本3: 添加条件节点
    节点数: 5
    边数: 5
    节点类型分布: condition:1 approval:2 end:1 start:1
```

**注意**: 
- 任务 ID 是动态生成的,每次运行都会不同
- 时间戳是实际运行时间,每次运行都会不同
- 模板更新时,Update 方法会自动递增版本号

## 验证步骤

1. **验证模板版本创建**:
   - 检查版本1是否正确创建
   - 检查版本2是否正确创建(自动递增版本号)
   - 检查版本3是否正确创建(自动递增版本号)

2. **验证任务版本关联**:
   - 检查任务1是否使用模板版本1
   - 检查任务2是否使用模板版本2
   - 检查任务3是否使用模板版本3

3. **验证版本查询**:
   - 检查 ListVersions 是否正确返回所有版本
   - 检查 Get 方法是否正确获取指定版本的模板

4. **验证版本对比**:
   - 检查版本对比是否正确显示各版本的差异

### 验证要点

- ✓ 模板版本控制正常工作
- ✓ 历史版本正确保留
- ✓ 任务正确关联到创建时的模板版本
- ✓ 版本查询功能正常
- ✓ 版本对比功能正常

## 版本管理机制说明

### 版本创建

- **Create**: 创建新模板时,需要指定版本号(通常为1)
- **Update**: 更新模板时,系统自动递增版本号,原版本保持不变

### 版本查询

- **Get(id, 0)**: 获取最新版本
- **Get(id, version)**: 获取指定版本
- **ListVersions(id)**: 列出所有版本号

### 任务版本关联

- 任务创建时,自动记录当前模板的版本号
- 任务查询时,使用任务记录的版本号获取对应的模板版本
- 确保历史任务始终使用创建时的模板版本

## 适用场景

这个场景适用于以下实际业务场景:

- **流程优化**: 需要持续优化审批流程,同时保证历史任务可追溯
- **版本追溯**: 需要查看历史版本的审批流程
- **A/B测试**: 需要测试不同版本的审批流程
- **合规要求**: 需要保留历史版本的审批流程,满足合规要求

## 扩展说明

如果需要扩展此场景,可以考虑:

1. **测试版本回退**: 测试是否可以回退到历史版本
2. **测试版本差异对比**: 详细对比不同版本的节点和边
3. **测试版本删除**: 测试删除模板时是否删除所有版本
4. **测试版本迁移**: 测试将任务迁移到新版本模板
5. **测试版本统计**: 统计各版本的使用情况

## 相关场景

- **场景 01**: 最简单的单人审批流程 - 可以结合版本管理实现流程优化
- **场景 03**: 条件分支审批流程 - 版本3添加了条件节点
- **场景 10**: 复杂综合审批流程 - 可以结合版本管理实现流程演进

