# 场景 22: 状态变更历史查询场景

## 场景描述

这是一个状态变更历史查询场景示例,演示审计场景,需要查询任务的所有状态变更历史,了解完整的审批过程.

**业务背景**: 在实际业务中,需要查询和分析任务的状态变更历史,了解完整的审批过程,支持审计和合规要求.系统应该自动记录每次状态变更的详细信息,包括源状态、目标状态、变更原因、变更时间等,支持完整的状态追溯.

## 流程结构

```
开始节点 → 审批节点 → 结束节点
```

流程说明:
1. **开始节点**: 流程的起点,自动执行
2. **审批节点**: 审批节点
   - 审批模式: 单人审批 (ApprovalModeSingle)
   - 审批人: 审批人
3. **结束节点**: 流程的终点

## 关键特性

- **状态变更历史**: StateHistory 记录每次状态变更的详细信息
- **完整追溯**: 记录源状态、目标状态、变更原因、变更时间
- **审计支持**: 支持审计和合规要求
- **状态回放**: 可以完整还原任务的状态流转过程

## 代码说明

### 主要组件

1. **模板创建** (`createTemplate`):
   - 创建包含审批节点的模板
   - 配置审批模式为单人审批 (ApprovalModeSingle)

2. **任务创建和处理** (`createAndProcessTask`):
   - 创建任务
   - 提交任务
   - 设置审批人
   - 审批操作
   - 每个操作都会触发状态变更,自动记录到 StateHistory

3. **状态变更历史分析** (`analyzeStateHistory`):
   - 查询状态变更历史
   - 分析状态流转路径
   - 统计状态变更次数
   - 分析状态变更时长
   - 分析状态变更原因

4. **结果输出**:
   - 输出任务基本信息
   - 输出完整的状态变更历史
   - 输出状态变更分析结果

### 代码结构

```go
main()
  ├── 创建管理器 (TemplateManager, TaskManager)
  ├── 创建模板 (createTemplate)
  ├── 创建任务并执行完整流程 (createAndProcessTask)
  │   ├── 创建任务 (Create)
  │   ├── 提交任务 (Submit) → 状态变更: pending → submitted
  │   ├── 设置审批人 (AddApprover)
  │   └── 审批操作 (Approve) → 状态变更: approving → approved
  └── 查询和分析状态变更历史 (analyzeStateHistory)
      ├── 查询状态变更历史
      ├── 分析状态流转路径
      ├── 统计状态变更次数
      ├── 分析状态变更时长
      └── 分析状态变更原因
```

### 状态变更历史查询示例

```go
history := tsk.GetStateHistory()
for i, change := range history {
    fmt.Printf("变更 %d: %s -> %s (原因: %s, 时间: %s)\n",
        i+1,
        change.From,
        change.To,
        change.Reason,
        change.Time.Format("2006-01-02 15:04:05"),
    )
}
```

## 执行方法

### 前置要求

- Go 1.25.4 或更高版本
- 已安装 approval-kit 依赖

### 执行步骤

1. 进入场景目录:
   ```bash
   cd examples/22-state-history
   ```

2. 运行程序:
   ```bash
   go run main.go
   ```

### 预期输出

程序运行后会输出以下内容:

```
=== 场景 22: 状态变更历史查询场景 ===

步骤 1: 创建审批模板
✓ 模板创建成功: ID=state-history-template, Name=状态变更历史模板

步骤 2: 创建任务并执行完整流程
  1. 创建任务
    ✓ 任务创建成功: ID=task-1763523109162350000-1, State=pending
  2. 提交任务
    ✓ 任务已提交: State=submitted
  3. 设置审批人
    ✓ 审批人已设置: manager-001
  4. 审批操作
    ✓ 审批已通过: State=approved

=== 状态变更历史查询和分析 ===

任务基本信息:
  任务 ID: task-1763523109162350000-1
  业务 ID: state-history-001
  模板 ID: state-history-template
  当前状态: approved
  创建时间: 2025-11-19 11:31:49

状态变更历史:
  共 2 条状态变更记录:

  变更 1:
    源状态: pending
    目标状态: submitted
    变更原因: task submitted
    变更时间: 2025-11-19 11:31:49
    状态流转: pending → submitted

  变更 2:
    源状态: approving
    目标状态: approved
    变更原因: all approvers approved
    变更时间: 2025-11-19 11:31:49
    状态流转: approving → approved

=== 状态变更分析 ===

状态流转路径:
  pending → submitted → approved

状态变更统计:
  - submitted: 1 次
  - approved: 1 次

状态变更时长分析:
  首次状态变更: 2025-11-19 11:31:49
  最后状态变更: 2025-11-19 11:31:49
  总时长: 0秒

  各状态停留时长:
    submitted: 0秒

状态变更原因分析:
  - task submitted: 1 次
  - all approvers approved: 1 次

=== 审计信息 ===

✓ 状态变更历史完整记录:
  - 每次状态变更都记录了源状态、目标状态、变更原因、变更时间
  - 可以完整追溯任务的状态流转过程
  - 支持审计和合规要求

✓ 状态变更历史查询功能已展示
  说明: 在实际业务系统中,可以通过 StateHistory 字段查询完整的状态变更历史
```

**注意**: 
- 任务 ID 是动态生成的,每次运行都会不同
- 时间戳是实际运行时间,每次运行都会不同
- 状态变更历史自动记录,无需手动配置

## 验证步骤

1. **验证模板创建**:
   - 检查模板是否包含开始节点、审批节点、结束节点
   - 检查审批节点配置是否正确

2. **验证任务创建**:
   - 检查任务初始状态是否为 `pending`
   - 检查任务参数是否正确设置

3. **验证状态变更历史记录**:
   - 检查提交任务时是否记录了状态变更(pending → submitted)
   - 检查审批操作时是否记录了状态变更(approving → approved)
   - 检查状态变更记录是否包含完整信息(源状态、目标状态、变更原因、变更时间)

4. **验证状态变更历史查询**:
   - 检查 GetStateHistory 是否正确返回状态变更历史
   - 检查状态变更历史分析是否正确

### 验证要点

- ✓ 状态变更历史自动记录
- ✓ 状态变更记录包含完整信息
- ✓ 状态变更历史查询功能正常
- ✓ 状态变更分析功能正常

## 状态变更历史说明

### 状态变更记录结构

每个状态变更记录包含以下信息:

- **From**: 源状态
- **To**: 目标状态
- **Reason**: 变更原因
- **Time**: 变更时间

### 状态变更自动记录

系统在以下操作时会自动记录状态变更:

- **任务提交**: pending → submitted
- **审批操作**: submitted → approving → approved
- **拒绝操作**: approving → rejected
- **任务取消**: pending/submitted/approving → cancelled
- **任务撤回**: submitted/approving → pending
- **任务超时**: submitted/approving → timeout

### 状态变更历史查询

通过 `GetStateHistory()` 方法可以获取完整的状态变更历史:

```go
history := tsk.GetStateHistory()
```

## 适用场景

这个场景适用于以下实际业务场景:

- **审计**: 需要完整的状态变更历史,支持审计要求
- **合规**: 需要完整的状态变更历史,满足合规要求
- **问题排查**: 需要查询状态变更历史,排查问题
- **状态追溯**: 需要完整追溯任务的状态流转过程

## 扩展说明

如果需要扩展此场景,可以考虑:

1. **测试更多状态变更**: 测试取消、撤回、超时等操作的状态变更记录
2. **测试状态变更过滤**: 根据状态类型、时间范围等过滤状态变更历史
3. **测试状态变更统计**: 统计各状态变更的次数和时长
4. **测试状态变更导出**: 导出状态变更历史到文件或数据库
5. **测试状态变更可视化**: 可视化状态变更历史,生成状态流转图

## 相关场景

- **场景 01**: 最简单的单人审批流程 - 可以结合状态变更历史查询实现完整的审批流程
- **场景 11**: 任务撤回和取消场景 - 撤回和取消操作也会记录状态变更历史
- **场景 14**: 审批记录查询和分析场景 - 可以结合状态变更历史进行更全面的分析

