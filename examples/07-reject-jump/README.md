# 场景 07-Jump: 拒绝后跳转到指定节点

## 场景描述

这是一个拒绝后跳转到指定节点的流程示例,模拟方案审批场景.当财务审批拒绝时,可以跳转到指定的部门审批节点重新修改.

**业务背景**: 方案审批流程需要经过部门、财务、总经理审批.如果财务审批拒绝,根据业务规则,应该跳转到部门审批节点重新修改方案,而不是回退到上一节点或终止流程.这种模式适用于需要跳转到特定节点重新处理的场景.

## 流程结构

```
开始节点 → 部门审批 → 财务审批 → 总经理审批 → 结束节点
```

流程说明:
1. **开始节点**: 流程的起点,自动执行
2. **部门审批节点**: 部门审批方案
   - 审批模式: 单人审批 (ApprovalModeSingle)
   - 审批人: 部门审批人
3. **财务审批节点**: 财务审批方案
   - 审批模式: 单人审批 (ApprovalModeSingle)
   - 审批人: 财务审批人
   - **拒绝后行为**: 跳转到指定节点 (RejectBehaviorJump)
   - **跳转目标节点**: 部门审批节点 (dept-approval)
4. **总经理审批节点**: 总经理审批方案
   - 审批模式: 单人审批 (ApprovalModeSingle)
   - 审批人: 总经理审批人
5. **结束节点**: 流程的终点

## 关键特性

- **拒绝后跳转**: 使用 RejectBehaviorJump 实现拒绝后跳转到指定节点
- **灵活跳转**: 可以跳转到流程中的任意节点,不限于上一节点
- **流程继续**: 拒绝后流程继续,而不是终止
- **重新审批**: 支持部门根据财务意见修改后重新审批
- **配置灵活**: 支持配置拒绝后行为(终止/回退/跳转)和目标节点

## 代码说明

### 主要组件

1. **模板创建** (`createTemplate`):
   - 创建包含部门、财务、总经理审批节点的模板
   - 配置财务审批节点的拒绝后行为为跳转 (RejectBehaviorJump)
   - 配置跳转目标节点为部门审批节点 (RejectTargetNode: "dept-approval")
   - 配置节点间的连接关系

2. **任务创建** (`main`):
   - 创建方案审批任务
   - 传入任务参数(方案编号、方案名称、提案人、预算、描述等)

3. **流程执行** (`runScenario`):
   - 提交任务进入审批流程
   - 设置审批人列表
   - 部门审批
   - 说明拒绝后跳转的完整流程

4. **结果输出** (`printResults`):
   - 输出任务状态、审批记录
   - 验证拒绝后跳转配置

### 代码结构

```go
main()
  ├── 创建管理器 (TemplateManager, TaskManager)
  ├── 创建模板 (createTemplate)
  │   └── 配置财务审批节点 (RejectBehaviorJump + RejectTargetNode)
  ├── 创建任务 (Create)
  ├── 执行流程 (runScenario)
  │   ├── 提交任务 (Submit)
  │   ├── 设置审批人列表 (AddApprover)
  │   ├── 部门审批 (Approve)
  │   └── 说明拒绝后跳转流程
  └── 输出结果 (printResults)
```

### 拒绝后跳转配置示例

```go
Config: &node.ApprovalNodeConfig{
    Mode: node.ApprovalModeSingle,
    ApproverConfig: &node.FixedApproverConfig{
        Approvers: []string{"finance-001"},
    },
    RejectBehavior:  node.RejectBehaviorJump,      // 拒绝后跳转到指定节点
    RejectTargetNode: "dept-approval",              // 跳转目标节点
}
```

## 执行方法

### 前置要求

- Go 1.25.4 或更高版本
- 已安装 approval-kit 依赖

### 执行步骤

1. 进入场景目录:
   ```bash
   cd examples/07-reject-jump
   ```

2. 运行程序:
   ```bash
   go run main.go
   ```

### 预期输出

程序运行后会输出以下内容:

```
=== 场景 07-Jump: 拒绝后跳转到指定节点 ===

步骤 1: 创建审批模板
✓ 模板创建成功: ID=proposal-approval-template, Name=方案审批模板

步骤 2: 创建方案审批任务
✓ 任务创建成功: ID=task-1763520825485765000-1, State=pending

步骤 3: 提交任务进入审批流程
✓ 任务已提交: State=submitted

步骤 4: 设置审批人列表
✓ 部门审批人已设置: dept-manager-001

步骤 5: 部门审批
✓ 部门已同意 (当前状态: approved, 当前节点: start)
  说明: 部门审批完成,在实际业务系统中,流程引擎应该自动跳转到财务审批节点
  注意: 本示例仅展示拒绝后跳转的配置和使用方法,节点跳转逻辑需要在实际业务系统中实现

步骤 6: 设置财务审批人
✓ 财务审批人已设置: finance-001

步骤 7: 财务拒绝审批(触发跳转)
  说明: 财务审批配置为拒绝后跳转到指定节点(部门审批节点)
  注意: 由于部门审批后任务状态已变为 approved,无法直接演示拒绝后跳转
  在实际业务系统中,流程引擎会在部门审批完成后自动跳转到财务审批节点
  此时财务审批拒绝后,会跳转到指定的目标节点(部门审批节点),任务状态变为 approving

  模拟场景: 假设任务当前在财务审批节点,且状态为 approving
  配置说明:
    - 财务审批节点配置了 RejectBehaviorJump
    - 拒绝后跳转目标节点设置为 dept-approval(部门审批节点)
    - 拒绝后会跳转到部门审批节点,而不是回退到上一节点

步骤 8: 拒绝后跳转的完整流程说明
  1. 部门审批通过后,流程自动跳转到财务审批节点
  2. 财务审批拒绝,触发 RejectBehaviorJump 配置
  3. 流程跳转到指定的目标节点(部门审批节点),任务状态变为 approving
  4. 部门根据财务意见修改方案后,重新审批
  5. 部门重新审批通过后,流程再次跳转到财务审批节点
  6. 财务审批通过,流程继续到总经理审批节点
  7. 总经理审批通过,任务状态变为 approved

✓ 拒绝后跳转功能配置和使用方法已展示

=== 审批结果 ===
任务 ID: task-1763520825485765000-1
业务 ID: proposal-001
模板 ID: proposal-approval-template
当前状态: approved
当前节点: start
创建时间: 2025-11-19 10:53:45
提交时间: 2025-11-19 10:53:45
更新时间: 2025-11-19 10:53:45

任务参数:
  proposalNo: PR-2025-001
  proposalName: 新产品开发方案
  proposer: 产品经理-001
  budget: 1e+06
  description: 新产品开发方案审批

审批记录(按时间顺序):
  记录 1:
    节点: 部门审批
    审批人: dept-manager-001
    审批结果: add_approver
    审批意见: 设置部门审批人
    审批时间: 2025-11-19 10:53:45
  记录 2:
    节点: 部门审批
    审批人: dept-manager-001
    审批结果: approve
    审批意见: 部门审批通过,方案可行
    审批时间: 2025-11-19 10:53:45
  记录 3:
    节点: 财务审批
    审批人: finance-001
    审批结果: add_approver
    审批意见: 设置财务审批人
    审批时间: 2025-11-19 10:53:45

状态变更历史:
  变更 1: pending -> submitted (原因: task submitted, 时间: 2025-11-19 10:53:45)
  变更 2: approving -> approved (原因: all approvers approved, 时间: 2025-11-19 10:53:45)

=== 验证结果 ===
✓ 任务已成功通过审批
✓ 拒绝后跳转配置已正确设置:
  - 财务审批节点配置了 RejectBehaviorJump
  - 拒绝后跳转目标节点设置为 dept-approval(部门审批节点)
  - 拒绝后会跳转到指定的目标节点,而不是回退到上一节点
  - 在实际业务系统中,流程引擎会自动处理节点跳转
```

**注意**: 
- 任务 ID 是动态生成的,每次运行都会不同
- 时间戳是实际运行时间,每次运行都会不同
- 任务参数中的字段顺序可能因 JSON 解析而有所不同
- 本示例仅展示拒绝后跳转的配置和使用方法,节点跳转逻辑需要在实际业务系统中实现
- 在实际业务系统中,流程引擎会在审批节点完成后自动跳转到下一个节点,并在拒绝时根据配置执行跳转

## 验证步骤

1. **验证模板创建**:
   - 检查模板是否包含开始节点、部门审批节点、财务审批节点、总经理审批节点、结束节点
   - 检查财务审批节点配置是否正确(拒绝后行为为 RejectBehaviorJump)
   - 检查跳转目标节点是否正确设置 (RejectTargetNode: "dept-approval")
   - 检查节点间的连接关系是否正确

2. **验证任务创建**:
   - 检查任务初始状态是否为 `pending`
   - 检查任务参数是否正确设置(方案信息等)

3. **验证任务提交**:
   - 检查任务状态是否从 `pending` 变为 `submitted`
   - 检查提交时间是否已设置

4. **验证审批人设置**:
   - 检查审批人列表是否正确设置
   - 检查部门、财务、总经理审批人是否正确设置

5. **验证部门审批**:
   - 检查部门审批后,任务状态是否正确
   - 检查审批记录是否正确生成

6. **验证拒绝后跳转配置**:
   - 检查财务审批节点是否配置了 RejectBehaviorJump
   - 检查跳转目标节点是否正确设置为部门审批节点
   - 检查拒绝后跳转配置是否正确

### 验证要点

- ✓ 财务审批节点配置了 RejectBehaviorJump
- ✓ 拒绝后跳转目标节点设置为 dept-approval(部门审批节点)
- ✓ 拒绝后会跳转到指定的目标节点,而不是回退到上一节点
- ✓ 在实际业务系统中,流程引擎会自动处理节点跳转
- ✓ 审批记录正确生成
- ✓ 状态变更历史包含状态转换记录

## 适用场景

这个场景适用于以下实际业务场景:

- **方案审批**: 财务拒绝后跳转到部门重新修改
- **合同审批**: 上级审批拒绝后跳转到指定节点重新处理
- **其他审批流程**: 需要跳转到特定节点重新处理的场景

## 与 RejectBehaviorRollback 的区别

- **RejectBehaviorRollback**: 拒绝后回退到上一节点(自动查找上一节点)
- **RejectBehaviorJump**: 拒绝后跳转到指定节点(需要明确指定目标节点)

**使用建议**:
- 如果需要回退到上一节点,使用 `RejectBehaviorRollback`
- 如果需要跳转到流程中的任意节点,使用 `RejectBehaviorJump`

## 扩展说明

如果需要扩展此场景,可以考虑:

1. **测试拒绝后终止**: 配置 RejectBehaviorTerminate,拒绝后终止流程
2. **测试拒绝后回退**: 配置 RejectBehaviorRollback,拒绝后回退到上一节点
3. **动态审批人**: 结合动态审批人配置,根据方案信息动态确定审批人
4. **条件分支**: 根据方案类型或预算,选择不同的审批路径
5. **审批超时**: 配置审批超时时间,超时后自动处理

## 相关场景

- **场景 01**: 最简单的单人审批流程 - 单个审批人场景
- **场景 02**: 多人会签审批流程 - 所有审批人必须全部同意
- **场景 03**: 条件分支审批流程 - 可以根据条件选择不同的审批路径
- **场景 07**: 拒绝后回退流程 - 拒绝后回退到上一节点

