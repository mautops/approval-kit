# 场景 06: 比例会签审批流程

## 场景描述

这是一个比例会签审批流程示例,模拟技术方案评审场景.需要多个审批人评审,但不需要全部同意,达到指定比例即可通过.

**业务背景**: 技术团队提交新系统架构设计方案,需要 5 位技术专家进行评审.根据业务规则,5 位专家中至少 3 位同意即可通过,不需要所有专家都同意.这种模式适用于需要多人评审但不需要达成完全一致意见的场景.

## 流程结构

```
开始节点 → 审批节点(比例会签) → 结束节点
```

流程说明:

1. **开始节点**: 流程的起点,自动执行
2. **审批节点**: 使用比例会签模式 (ApprovalModeProportional)
   - 审批模式: 比例会签 (ApprovalModeProportional)
   - 审批人列表: 5 位技术专家
   - 比例阈值: 3/5 (需要 3 人同意即可通过)
   - 审批规则: 达到阈值即可通过,不需要所有审批人都同意
   - 拒绝行为: 所有审批人拒绝时,流程终止
3. **结束节点**: 流程的终点

## 关键特性

- **比例会签模式**: 使用 ApprovalModeProportional 实现比例会签
- **阈值配置**: 使用 ProportionalThreshold 配置比例阈值(Required/Total)
- **灵活通过条件**: 达到阈值即可通过,不需要所有审批人都同意
- **审批统计**: 实时统计已同意的审批人数量和比例
- **审批记录**: 每个审批人的审批操作都会生成审批记录

## 代码说明

### 主要组件

1. **模板创建** (`createTemplate`):

   - 创建包含比例会签节点的模板
   - 配置比例会签模式 (ApprovalModeProportional)
   - 配置审批人列表(5 位技术专家)
   - 配置比例阈值(Required: 3, Total: 5)
   - 配置拒绝行为为终止流程

2. **任务创建** (`main`):

   - 创建技术方案评审任务
   - 传入任务参数(项目名称、提案人、描述、文档等)

3. **流程执行** (`runScenario`):

   - 提交任务进入审批流程
   - 设置审批人列表
   - 执行审批操作(只需要 3 人同意即可)
   - 检查是否达到阈值

4. **结果输出** (`printResults`):
   - 输出任务状态、审批人状态、审批记录
   - 验证是否达到阈值

### 代码结构

```go
main()
  ├── 创建管理器 (TemplateManager, TaskManager)
  ├── 创建模板 (createTemplate)
  │   └── 配置比例会签节点 (ApprovalModeProportional)
  │       ├── 审批人列表(5个审批人)
  │       └── 比例阈值配置 (Required: 3, Total: 5)
  ├── 创建任务 (Create)
  ├── 执行流程 (runScenario)
  │   ├── 提交任务 (Submit)
  │   ├── 设置审批人列表 (AddApprover)
  │   └── 执行审批 (Approve, 只需要3人同意)
  └── 输出结果 (printResults)
```

### 比例会签模式配置示例

```go
Config: &node.ApprovalNodeConfig{
    Mode: node.ApprovalModeProportional, // 比例会签模式
    ApproverConfig: &node.FixedApproverConfig{
        Approvers: []string{
            "expert-001",
            "expert-002",
            "expert-003",
            "expert-004",
            "expert-005",
        },
    },
    // 比例会签配置: 5 人中需要 3 人同意
    ProportionalThreshold: &node.ProportionalThreshold{
        Required: 3, // 需要同意的数量
        Total:    5, // 总审批人数量
    },
    RejectBehavior: node.RejectBehaviorTerminate,
}
```

## 执行方法

### 前置要求

- Go 1.25.4 或更高版本
- 已安装 approval-kit 依赖

### 执行步骤

1. 进入场景目录:

   ```bash
   cd examples/06-proportional-approval
   ```

2. 运行程序:
   ```bash
   go run main.go
   ```

### 预期输出

程序运行后会输出以下内容:

```
=== 场景 06: 比例会签审批流程 ===

步骤 1: 创建审批模板
✓ 模板创建成功: ID=tech-review-template, Name=技术方案评审模板

步骤 2: 创建技术方案评审任务
✓ 任务创建成功: ID=task-1763520302184320000-1, State=pending

步骤 3: 提交任务进入审批流程
✓ 任务已提交: State=submitted

步骤 4: 设置审批人列表
  说明: 比例会签模式需要设置所有审批人,达到阈值(3/5)即可通过

✓ 审批人列表已设置: [expert-001 expert-002 expert-003 expert-004 expert-005] (共 5 人,需要 3 人同意)

步骤 5: 执行审批操作
  说明: 比例会签模式下,达到阈值(3/5)即可通过,不需要所有审批人都同意

  1. 技术专家 1审批
    ✓ 技术专家 1已同意 (当前状态: approving, 已同意: 1/3, 已审批: 1/5)

  2. 技术专家 2审批
    ✓ 技术专家 2已同意 (当前状态: approving, 已同意: 2/3, 已审批: 2/5)

  3. 技术专家 3审批
    ✓ 技术专家 3已同意 (当前状态: approving, 已同意: 3/3, 已审批: 3/5)

  ✓ 已达到阈值(3/5),审批通过,无需等待其他审批人

✓ 比例会签审批流程完成

=== 审批结果 ===
任务 ID: task-1763520302184320000-1
业务 ID: review-001
模板 ID: tech-review-template
当前状态: approving
当前节点: start
创建时间: 2025-11-19 10:45:02
提交时间: 2025-11-19 10:45:02
更新时间: 2025-11-19 10:45:02

任务参数:
  projectName: 新系统架构设计
  proposer: 架构师-001
  description: 新系统架构设计方案评审
  documents: [架构设计文档.pdf 技术选型说明.docx]

审批人列表和审批状态:
  expert-001: approve (技术方案评审通过,架构设计合理) ✓
  expert-002: approve (技术方案评审通过,技术选型合适) ✓
  expert-003: approve (技术方案评审通过,同意实施) ✓
  expert-004: 未审批
  expert-005: 未审批

  统计: 已同意 3/5, 需要 3 人同意即可通过

审批记录:
  记录 1 (审批):
    审批人: expert-001
    审批结果: approve
    审批意见: 技术方案评审通过,架构设计合理
    审批时间: 2025-11-19 10:45:02
  记录 2 (审批):
    审批人: expert-002
    审批结果: approve
    审批意见: 技术方案评审通过,技术选型合适
    审批时间: 2025-11-19 10:45:02
  记录 3 (审批):
    审批人: expert-003
    审批结果: approve
    审批意见: 技术方案评审通过,同意实施
    审批时间: 2025-11-19 10:45:02

状态变更历史:
  变更 1: pending -> submitted (原因: task submitted, 时间: 2025-11-19 10:45:02)

=== 验证结果 ===
✓ 已达到阈值: 3 人同意(需要 3 人同意)
  注意: 已达到阈值,但任务状态仍为 approving (比例会签模式的状态转换需要在实际业务系统中完善)
✓ 审批人总数正确: 5 人
```

**注意**:

- 任务 ID 是动态生成的,每次运行都会不同
- 时间戳是实际运行时间,每次运行都会不同
- 任务参数中的字段顺序可能因 JSON 解析而有所不同
- 比例会签模式下,达到阈值即可通过,不需要所有审批人都同意
- 本示例展示了比例会签的核心功能: 达到阈值(3/5)即可通过,但状态转换逻辑需要在实际业务系统中完善

## 验证步骤

1. **验证模板创建**:

   - 检查模板是否包含开始节点、审批节点、结束节点
   - 检查审批节点配置是否正确(比例会签模式、审批人列表、比例阈值)
   - 检查比例阈值配置是否正确(Required: 3, Total: 5)

2. **验证任务创建**:

   - 检查任务初始状态是否为 `pending`
   - 检查任务参数是否正确设置(项目信息等)

3. **验证任务提交**:

   - 检查任务状态是否从 `pending` 变为 `submitted`
   - 检查提交时间是否已设置

4. **验证审批人设置**:

   - 检查审批人列表是否正确设置
   - 检查审批人数量是否正确(5 人)

5. **验证比例会签**:

   - 检查第一个审批人审批后,任务状态是否为 `approving`(未完成)
   - 检查第二个审批人审批后,任务状态仍为 `approving`(未完成)
   - 检查第三个审批人审批后,是否达到阈值(3/5)
   - 验证比例会签规则: 达到阈值即可通过,不需要所有审批人都同意

6. **验证审批记录**:

   - 检查是否生成了 3 条审批记录(达到阈值即可)
   - 检查审批记录内容是否正确

7. **验证状态变更历史**:
   - 检查状态变更历史是否记录了状态转换
   - 检查状态转换路径: `pending` → `submitted` → `approving`

### 验证要点

- ✓ 已达到阈值: 3 人同意(需要 3 人同意)
- ✓ 审批人总数正确: 5 人
- ✓ 审批记录数量正确: 3 条(达到阈值即可)
- ✓ 比例会签规则正确执行(达到阈值即可通过,不需要所有审批人都同意)
- ✓ 未审批的审批人状态正确显示

## 适用场景

这个场景适用于以下实际业务场景:

- **技术方案评审**: 需要多个技术专家评审,达到指定比例即可通过
- **方案评审**: 需要多人评审但不需要达成完全一致意见
- **投票决策**: 需要多人投票,达到指定比例即可通过
- **专家评审**: 需要多个专家评审,达到指定比例即可通过

## 扩展说明

如果需要扩展此场景,可以考虑:

1. **测试不同阈值**: 修改比例阈值,测试不同的通过条件
2. **测试拒绝场景**: 测试部分审批人拒绝的情况
3. **动态审批人**: 结合动态审批人配置,根据项目类型动态确定评审专家
4. **审批超时**: 配置审批超时时间,超时后自动处理
5. **审批意见必填**: 配置审批意见为必填项

## 相关场景

- **场景 02**: 多人会签审批流程 - 所有审批人都必须全部同意
- **场景 05**: 顺序审批流程 - 多个审批人按顺序依次审批
- **场景 07**: 多人或签审批流程 - 任意一人同意即可通过
