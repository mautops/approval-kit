# 场景 05: 顺序审批流程

## 场景描述

这是一个顺序审批流程示例,模拟员工转正审批场景.需要按顺序经过多个审批人审批,前一个审批人同意后,下一个审批人才能审批.

**业务背景**: 员工提交转正申请,系统需要按顺序经过直属主管、部门经理、HR、总经理审批.每个审批人都必须在前一个审批人同意后才能进行审批,体现了层级审批的特点.

## 流程结构

```
开始节点 → 审批节点(顺序审批模式) → 结束节点
```

流程说明:
1. **开始节点**: 流程的起点,自动执行
2. **审批节点**: 使用顺序审批模式 (ApprovalModeSequential)
   - 审批模式: 顺序审批 (ApprovalModeSequential)
   - 审批人列表: 直属主管 → 部门经理 → HR → 总经理
   - 审批规则: 前一个审批人同意后,下一个审批人才能审批
   - 拒绝行为: 任一审批人拒绝,流程终止
3. **结束节点**: 流程的终点

## 关键特性

- **顺序审批模式**: 使用 ApprovalModeSequential 实现多个审批人按顺序审批
- **顺序控制**: 前一个审批人同意后,下一个审批人才能审批
- **多级审批链**: 支持多个审批人按顺序依次审批
- **拒绝处理**: 任一审批人拒绝,流程终止
- **审批记录**: 每个审批人的审批操作都会生成审批记录

## 代码说明

### 主要组件

1. **模板创建** (`createTemplate`):
   - 创建包含顺序审批节点的模板
   - 配置顺序审批模式 (ApprovalModeSequential)
   - 配置审批人列表(直属主管、部门经理、HR、总经理)
   - 配置拒绝行为为终止流程

2. **任务创建** (`main`):
   - 创建员工转正任务
   - 传入任务参数(员工信息、部门、职位、试用期、绩效等)

3. **流程执行** (`runScenario`):
   - 提交任务进入审批流程
   - 设置审批人列表
   - 按顺序执行审批操作
   - 每个审批人必须在前一个审批人同意后才能审批

4. **结果输出** (`printResults`):
   - 输出任务状态、审批记录
   - 验证审批顺序是否正确

### 代码结构

```go
main()
  ├── 创建管理器 (TemplateManager, TaskManager)
  ├── 创建模板 (createTemplate)
  │   └── 配置顺序审批节点 (ApprovalModeSequential)
  │       ├── 审批人列表(4个审批人)
  │       └── 拒绝行为配置
  ├── 创建任务 (Create)
  ├── 执行流程 (runScenario)
  │   ├── 提交任务 (Submit)
  │   ├── 设置审批人列表 (AddApprover)
  │   └── 按顺序执行审批 (Approve)
  └── 输出结果 (printResults)
```

### 顺序审批模式配置示例

```go
Config: &node.ApprovalNodeConfig{
    Mode: node.ApprovalModeSequential, // 顺序审批模式
    ApproverConfig: &node.FixedApproverConfig{
        Approvers: []string{
            "direct-manager-001", // 直属主管
            "dept-manager-001",   // 部门经理
            "hr-001",             // HR
            "ceo-001",            // 总经理
        },
    },
    RejectBehavior: node.RejectBehaviorTerminate, // 任一审批人拒绝,流程终止
}
```

## 执行方法

### 前置要求

- Go 1.25.4 或更高版本
- 已安装 approval-kit 依赖

### 执行步骤

1. 进入场景目录:
   ```bash
   cd examples/05-sequential-approval
   ```

2. 运行程序:
   ```bash
   go run main.go
   ```

### 预期输出

程序运行后会输出以下内容:

```
=== 场景 05: 顺序审批流程 ===

步骤 1: 创建审批模板
✓ 模板创建成功: ID=promotion-approval-template, Name=员工转正审批模板

步骤 2: 创建员工转正任务
✓ 任务创建成功: ID=task-1763519744945840000-1, State=pending

步骤 3: 提交任务进入审批流程
✓ 任务已提交: State=submitted

步骤 4: 设置审批人列表
  说明: 顺序审批模式需要设置所有审批人,按顺序依次审批

✓ 审批人列表已设置: [direct-manager-001 dept-manager-001 hr-001 ceo-001]

步骤 5: 按顺序执行审批操作
  说明: 顺序审批模式下,前一个审批人同意后,下一个审批人才能审批

  1. 直属主管审批
    ✓ 直属主管已同意 (当前状态: approving, 已审批: 1/4)

  2. 部门经理审批
    ✓ 部门经理已同意 (当前状态: approving, 已审批: 2/4)

  3. HR审批
    ✓ HR已同意 (当前状态: approving, 已审批: 3/4)

  4. 总经理审批
    ✓ 总经理已同意 (当前状态: approved, 已审批: 4/4)

✓ 所有审批人已按顺序完成审批,审批流程完成

=== 审批结果 ===
任务 ID: task-1763519744945840000-1
业务 ID: promotion-001
模板 ID: promotion-approval-template
当前状态: approved
当前节点: start
创建时间: 2025-11-19 10:35:44
提交时间: 2025-11-19 10:35:44
更新时间: 2025-11-19 10:35:44

任务参数:
  employeeId: emp-001
  employeeName: 张三
  department: 技术部
  position: 高级工程师
  probationPeriod: 6
  performance: 优秀

审批记录(按审批顺序):
  记录 1:
    审批人: direct-manager-001 (直属主管)
    审批结果: approve
    审批意见: 直属主管审批通过,员工表现优秀
    审批时间: 2025-11-19 10:35:44
  记录 2:
    审批人: dept-manager-001 (部门经理)
    审批结果: approve
    审批意见: 部门经理审批通过,同意转正
    审批时间: 2025-11-19 10:35:44
  记录 3:
    审批人: hr-001 (HR)
    审批结果: approve
    审批意见: HR审批通过,符合转正条件
    审批时间: 2025-11-19 10:35:44
  记录 4:
    审批人: ceo-001 (总经理)
    审批结果: approve
    审批意见: 总经理审批通过,同意转正
    审批时间: 2025-11-19 10:35:44

状态变更历史:
  变更 1: pending -> submitted (原因: task submitted, 时间: 2025-11-19 10:35:44)
  变更 2: approving -> approved (原因: all approvers approved, 时间: 2025-11-19 10:35:44)

=== 验证结果 ===
✓ 任务已成功通过审批
✓ 已按顺序完成 4 个审批人的审批
```

**注意**: 
- 任务 ID 是动态生成的,每次运行都会不同
- 时间戳是实际运行时间,每次运行都会不同
- 任务参数中的字段顺序可能因 JSON 解析而有所不同
- 顺序审批模式下,前一个审批人同意后,下一个审批人才能审批

## 验证步骤

1. **验证模板创建**:
   - 检查模板是否包含开始节点、审批节点、结束节点
   - 检查审批节点配置是否正确(顺序审批模式、审批人列表)
   - 检查拒绝行为配置是否正确

2. **验证任务创建**:
   - 检查任务初始状态是否为 `pending`
   - 检查任务参数是否正确设置(员工信息等)

3. **验证任务提交**:
   - 检查任务状态是否从 `pending` 变为 `submitted`
   - 检查提交时间是否已设置

4. **验证审批人设置**:
   - 检查审批人列表是否正确设置
   - 检查审批人顺序是否正确

5. **验证顺序审批**:
   - 检查第一个审批人审批后,任务状态是否为 `approving`(未完成)
   - 检查第二个审批人审批后,任务状态仍为 `approving`(未完成)
   - 检查最后一个审批人审批后,任务状态是否为 `approved`(完成)
   - 验证顺序审批规则: 前一个审批人同意后,下一个审批人才能审批

6. **验证审批记录**:
   - 检查是否生成了 4 条审批记录
   - 检查审批记录顺序是否正确
   - 检查审批记录内容是否正确

7. **验证状态变更历史**:
   - 检查状态变更历史是否记录了状态转换
   - 检查状态转换路径: `pending` → `submitted` → `approving` → `approved`

### 验证要点

- ✓ 任务最终状态为 `approved`
- ✓ 已按顺序完成 4 个审批人的审批
- ✓ 审批记录顺序正确(直属主管 → 部门经理 → HR → 总经理)
- ✓ 每个审批人的审批记录都已生成
- ✓ 状态变更历史包含状态转换记录
- ✓ 顺序审批规则正确执行(前一个审批人同意后,下一个审批人才能审批)

## 适用场景

这个场景适用于以下实际业务场景:

- **员工转正**: 需要按顺序经过直属主管、部门经理、HR、总经理审批
- **员工晋升**: 需要按层级顺序审批
- **员工离职**: 需要按顺序经过多个审批人审批
- **薪资调整**: 需要按层级顺序审批
- **其他 HR 流程**: 需要按层级顺序审批的场景

## 扩展说明

如果需要扩展此场景,可以考虑:

1. **测试拒绝场景**: 在某个审批人拒绝时,验证流程是否正确终止
2. **动态审批人**: 结合动态审批人配置,根据员工信息动态确定审批人
3. **条件分支**: 根据员工级别或部门,选择不同的审批路径
4. **审批超时**: 配置审批超时时间,超时后自动处理
5. **审批意见必填**: 配置审批意见为必填项

## 相关场景

- **场景 01**: 最简单的单人审批流程 - 单个审批人场景
- **场景 02**: 多人会签审批流程 - 所有审批人必须全部同意
- **场景 04**: 动态审批人获取场景 - 可以结合动态审批人实现顺序审批

