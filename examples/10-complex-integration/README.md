# 场景 10: 复杂综合审批流程

## 场景描述

这是一个复杂综合审批流程示例,综合展示了多种审批模式和功能,包括条件分支、动态审批人、多种审批模式、超时处理、拒绝后跳转、事件通知等.

**业务背景**: 大型项目立项审批需要根据项目类型选择不同的审批路径,使用不同的审批模式:
- **研发项目**: 技术负责人(动态获取) → CTO(顺序审批)
- **市场项目**: 市场总监(单人审批) → 财务(会签)
- **其他项目**: 部门经理(或签) → 总经理(比例会签)

这种模式适用于复杂的企业级审批流程,需要多种审批模式组合使用的场景.

## 流程结构

```
开始节点
  ↓
条件节点1(项目类型判断)
  ├─→ [研发项目] → 技术负责人审批(动态获取) → CTO审批(顺序审批) → 结束
  └─→ [非研发项目] → 条件节点2(市场项目判断)
      ├─→ [市场项目] → 市场总监审批(单人审批) → 财务审批(会签) → 结束
      └─→ [其他项目] → 部门经理审批(或签) → 总经理审批(比例会签) → 结束
```

流程说明:
1. **开始节点**: 流程的起点,自动执行
2. **条件节点1**: 根据项目类型判断是否为研发项目
   - 条件类型: 枚举判断 (enum)
   - 字段: projectType
   - 操作符: in
   - 值: ["研发项目"]
   - True: 跳转到技术负责人审批节点
   - False: 进入条件节点2
3. **条件节点2**: 根据项目类型判断是否为市场项目
   - 条件类型: 枚举判断 (enum)
   - 字段: projectType
   - 操作符: in
   - 值: ["市场项目"]
   - True: 跳转到市场总监审批节点
   - False: 跳转到部门经理审批节点
4. **研发项目路径**:
   - **技术负责人审批**: 动态获取审批人,单人审批模式,超时24小时,拒绝后回退
   - **CTO审批**: 顺序审批模式,超时48小时
5. **市场项目路径**:
   - **市场总监审批**: 单人审批模式,超时24小时
   - **财务审批**: 会签模式,需要所有财务审批人全部同意,超时24小时
6. **其他项目路径**:
   - **部门经理审批**: 或签模式,任意一人同意即可,超时24小时
   - **总经理审批**: 比例会签模式,5人中需要3人同意,超时48小时
7. **结束节点**: 流程的终点

## 关键特性

- **条件分支**: 使用枚举条件节点根据项目类型选择不同的审批路径
- **动态审批人**: 技术负责人根据项目领域动态获取
- **多种审批模式**: 综合使用单人审批、会签、或签、顺序审批、比例会签等多种模式
- **超时处理**: 关键节点配置超时时间
- **拒绝后跳转**: 支持拒绝后回退修改
- **事件通知**: 所有关键节点配置 Webhook 通知

## 代码说明

### 主要组件

1. **Mock HTTP 客户端** (`createMockHTTPClient`):
   - 实现 `node.HTTPClient` 接口
   - 模拟 API 响应,根据项目类型返回不同的技术负责人
   - 用于演示,不进行真实的网络请求

2. **模板创建** (`createTemplate`):
   - 创建包含两个条件节点、多个审批节点的模板
   - 配置条件节点根据项目类型判断走不同路径
   - 配置技术负责人审批使用动态审批人
   - 配置不同审批节点使用不同的审批模式
   - 配置超时处理、拒绝后跳转、Webhook 通知

3. **场景执行** (`runScenario`):
   - 创建不同项目类型的任务
   - 提交任务进入审批流程
   - 说明不同项目类型的审批路径和关键特性

4. **结果输出** (`printResults`):
   - 输出任务状态、审批记录
   - 验证复杂综合审批流程配置

### 代码结构

```go
main()
  ├── 创建 Mock HTTP 客户端 (createMockHTTPClient)
  ├── 创建管理器 (TemplateManager, TaskManager)
  ├── 创建模板 (createTemplate)
  │   ├── 条件节点1(研发项目判断)
  │   ├── 条件节点2(市场项目判断)
  │   ├── 技术负责人审批(动态获取)
  │   ├── CTO审批(顺序审批)
  │   ├── 市场总监审批(单人审批)
  │   ├── 财务审批(会签)
  │   ├── 部门经理审批(或签)
  │   └── 总经理审批(比例会签)
  └── 运行多个场景 (runScenario)
      ├── 研发项目场景
      ├── 市场项目场景
      └── 其他项目场景
```

### 条件节点配置示例

```go
// 条件节点1: 判断是否为研发项目
Condition: &node.Condition{
    Type: "enum",
    Config: &node.EnumConditionConfig{
        Field:    "projectType",
        Operator: "in",
        Values:   []string{"研发项目"},
        Source:   "task_params",
    },
},
TrueNodeID:  "tech-lead-approval", // 研发项目: 技术负责人审批
FalseNodeID: "condition-node-2",  // 非研发项目: 进入条件节点2
```

### 动态审批人配置示例

```go
ApproverConfig: &node.DynamicApproverConfig{
    API: &node.HTTPAPIConfig{
        URL:    "http://api.example.com/approvers",
        Method: "POST",
        ParamMapping: &node.ParamMapping{
            Source: "task_params",
            Path:   "projectType",
            Target: "projectType",
        },
        ResponseMapping: &node.ResponseMapping{
            Path:   "approvers",
            Format: "json",
        },
    },
    Timing:     node.ApproverTimingOnActivate,
    HTTPClient: httpClient,
},
```

### 多种审批模式配置示例

**顺序审批**:
```go
Config: &node.ApprovalNodeConfig{
    Mode: node.ApprovalModeSequential,
    ApproverConfig: &node.FixedApproverConfig{
        Approvers: []string{"cto-001"},
    },
    Timeout: &timeout48h,
}
```

**会签审批**:
```go
Config: &node.ApprovalNodeConfig{
    Mode: node.ApprovalModeUnanimous,
    ApproverConfig: &node.FixedApproverConfig{
        Approvers: []string{"finance-001", "finance-002", "finance-003"},
    },
    Timeout: &timeout24h,
}
```

**或签审批**:
```go
Config: &node.ApprovalNodeConfig{
    Mode: node.ApprovalModeOr,
    ApproverConfig: &node.FixedApproverConfig{
        Approvers: []string{"dept-manager-001", "dept-manager-002"},
    },
    Timeout: &timeout24h,
}
```

**比例会签**:
```go
Config: &node.ApprovalNodeConfig{
    Mode: node.ApprovalModeProportional,
    ApproverConfig: &node.FixedApproverConfig{
        Approvers: []string{"gm-001", "gm-002", "gm-003", "gm-004", "gm-005"},
    },
    ProportionalThreshold: &node.ProportionalThreshold{
        Required: 3, // 5 人中需要 3 人同意
        Total:    5,
    },
    Timeout: &timeout48h,
}
```

### 超时处理和拒绝后跳转配置示例

```go
Config: &node.ApprovalNodeConfig{
    Timeout:        &timeout24h,                    // 超时配置: 24小时
    RejectBehavior: node.RejectBehaviorRollback,   // 拒绝后回退
}
```

### Webhook 事件通知配置示例

```go
Config: &template.TemplateConfig{
    Webhooks: []*template.WebhookConfig{
        {
            URL:     "http://webhook.example.com/events",
            Method:  "POST",
            Headers: map[string]string{"Authorization": "Bearer token-123"},
        },
    },
}
```

## 执行方法

### 前置要求

- Go 1.25.4 或更高版本
- 已安装 approval-kit 依赖

### 执行步骤

1. 进入场景目录:
   ```bash
   cd examples/10-complex-integration
   ```

2. 运行程序:
   ```bash
   go run main.go
   ```

### 预期输出

程序运行后会输出以下内容:

```
=== 场景 10: 复杂综合审批流程 ===

步骤 1: 创建审批模板
✓ 模板创建成功: ID=complex-approval-template, Name=复杂综合审批模板

--- 研发项目场景 ---
✓ 任务创建成功: ID=task-1763524493145916000-1, 项目类型=研发项目
✓ 任务已提交

=== 审批流程说明 ===
项目类型: 研发项目
预期路径: 技术负责人(动态获取) → CTO(顺序审批)

研发项目审批路径:
  1. 条件节点1判断: 项目类型 == 研发项目 → True
  2. 技术负责人审批(动态获取): 通过 HTTP API 获取技术负责人
  3. CTO审批(顺序审批): 技术负责人同意后,CTO按顺序审批
  4. 流程结束

关键特性:
  - 动态审批人: 技术负责人根据项目领域动态获取
  - 顺序审批: CTO审批必须等技术负责人同意后
  - 超时处理: 技术负责人审批24小时,CTO审批48小时
  - 拒绝后回退: 技术负责人拒绝后回退到上一节点

注意: 本示例主要展示复杂综合审批流程的配置方式.
在实际业务系统中,工作流引擎会根据条件自动选择审批路径.
并根据审批模式自动处理审批流程.

=== 审批结果 ===
任务 ID: task-1763524493145916000-1
业务 ID: project-研发项目-001
模板 ID: complex-approval-template
当前状态: submitted
当前节点: start

任务参数:
  description: 研发项目项目立项审批
  projectName: 研发项目项目
  projectNo: PRJ-2025-研发项目
  projectType: 研发项目
  requester: 申请人-001
  amount: 2e+06

审批记录:
  无审批记录

=== 验证结果 ===
✓ 复杂综合审批流程配置已正确设置:
  - 条件节点1(研发项目判断)已配置
  - 条件节点2(市场项目判断)已配置
  - 技术负责人审批(动态获取)已配置
  - CTO审批(顺序审批)已配置
  - 市场总监审批(单人审批)已配置
  - 财务审批(会签)已配置
  - 部门经理审批(或签)已配置
  - 总经理审批(比例会签)已配置
  - 超时处理配置已设置
  - 拒绝后跳转配置已设置
  - Webhook事件通知配置已设置

  说明: 本场景综合展示了多种审批模式和功能
  在实际业务系统中,流程引擎会根据条件自动选择审批路径
  并根据审批模式自动处理审批流程

--- 市场项目场景 ---
✓ 任务创建成功: ID=task-1763524493146010000-2, 项目类型=市场项目
✓ 任务已提交

=== 审批流程说明 ===
项目类型: 市场项目
预期路径: 市场总监(单人审批) → 财务(会签)

市场项目审批路径:
  1. 条件节点1判断: 项目类型 == 研发项目 → False
  2. 条件节点2判断: 项目类型 == 市场项目 → True
  3. 市场总监审批(单人审批): 市场总监审批
  4. 财务审批(会签): 需要所有财务审批人全部同意
  5. 流程结束

关键特性:
  - 单人审批: 市场总监单人审批
  - 会签模式: 财务审批需要多人全部同意
  - 超时处理: 市场总监审批24小时,财务审批24小时

--- 其他项目场景 ---
✓ 任务创建成功: ID=task-1763524493146102000-3, 项目类型=其他项目
✓ 任务已提交

=== 审批流程说明 ===
项目类型: 其他项目
预期路径: 部门经理(或签) → 总经理(比例会签)

其他项目审批路径:
  1. 条件节点1判断: 项目类型 == 研发项目 → False
  2. 条件节点2判断: 项目类型 == 市场项目 → False
  3. 部门经理审批(或签): 任意一个部门经理同意即可
  4. 总经理审批(比例会签): 5人中需要3人同意
  5. 流程结束

关键特性:
  - 或签模式: 部门经理审批任意一人同意即可
  - 比例会签: 总经理审批达到比例(3/5)即可
  - 超时处理: 部门经理审批24小时,总经理审批48小时
```

**注意**: 
- 任务 ID 是动态生成的,每次运行都会不同
- 时间戳是实际运行时间,每次运行都会不同
- 本示例主要展示复杂综合审批流程的配置方式
- 在实际业务系统中,工作流引擎会根据条件自动选择审批路径

## 验证步骤

1. **验证模板创建**:
   - 检查模板是否包含两个条件节点、多个审批节点、结束节点
   - 检查条件节点1是否配置了枚举条件(研发项目判断)
   - 检查条件节点2是否配置了枚举条件(市场项目判断)
   - 检查技术负责人审批是否配置了动态审批人
   - 检查不同审批节点是否使用了不同的审批模式
   - 检查超时处理配置是否已设置
   - 检查拒绝后跳转配置是否已设置
   - 检查 Webhook 事件通知配置是否已设置

2. **验证任务创建**:
   - 检查任务初始状态是否为 `pending`
   - 检查任务参数是否正确设置(项目类型等)

3. **验证条件分支配置**:
   - 检查条件节点1是否配置了正确的条件(项目类型枚举判断)
   - 检查条件节点2是否配置了正确的条件(项目类型枚举判断)
   - 检查条件节点的跳转目标节点是否正确设置

4. **验证多种审批模式配置**:
   - 检查技术负责人审批是否配置了动态审批人
   - 检查 CTO审批是否配置了顺序审批模式
   - 检查市场总监审批是否配置了单人审批模式
   - 检查财务审批是否配置了会签模式
   - 检查部门经理审批是否配置了或签模式
   - 检查总经理审批是否配置了比例会签模式

### 验证要点

- ✓ 条件节点1(研发项目判断)已正确配置
- ✓ 条件节点2(市场项目判断)已正确配置
- ✓ 技术负责人审批(动态获取)已正确配置
- ✓ CTO审批(顺序审批)已正确配置
- ✓ 市场总监审批(单人审批)已正确配置
- ✓ 财务审批(会签)已正确配置
- ✓ 部门经理审批(或签)已正确配置
- ✓ 总经理审批(比例会签)已正确配置
- ✓ 超时处理配置已设置
- ✓ 拒绝后跳转配置已设置
- ✓ Webhook 事件通知配置已设置

## 适用场景

这个场景适用于以下实际业务场景:

- **大型项目立项**: 需要根据项目类型选择不同审批路径
- **复杂审批流程**: 需要多种审批模式组合使用的场景
- **企业级审批**: 需要灵活配置审批流程的企业级应用
- **多部门协同**: 需要多个部门协同审批的场景

## 流程说明

### 条件分支

根据任务参数中的 `projectType` 字段判断:
- **条件节点1**: 判断是否为研发项目
  - 如果 `projectType in ["研发项目"]`: 走研发项目路径
  - 否则: 进入条件节点2
- **条件节点2**: 判断是否为市场项目
  - 如果 `projectType in ["市场项目"]`: 走市场项目路径
  - 否则: 走其他项目路径

### 审批路径

**路径1: 研发项目路径**
1. 条件节点1判断项目类型为研发项目,跳转到技术负责人审批节点
2. 技术负责人审批节点通过 HTTP API 动态获取审批人,单人审批模式
3. 技术负责人审批完成后,跳转到 CTO审批节点
4. CTO审批节点按顺序审批(顺序审批模式)
5. CTO审批完成后,流程结束

**路径2: 市场项目路径**
1. 条件节点1判断项目类型不是研发项目,进入条件节点2
2. 条件节点2判断项目类型为市场项目,跳转到市场总监审批节点
3. 市场总监审批节点单人审批模式
4. 市场总监审批完成后,跳转到财务审批节点
5. 财务审批节点会签模式,需要所有财务审批人全部同意
6. 财务审批完成后,流程结束

**路径3: 其他项目路径**
1. 条件节点1判断项目类型不是研发项目,进入条件节点2
2. 条件节点2判断项目类型不是市场项目,跳转到部门经理审批节点
3. 部门经理审批节点或签模式,任意一人同意即可
4. 部门经理审批完成后,跳转到总经理审批节点
5. 总经理审批节点比例会签模式,5人中需要3人同意
6. 总经理审批完成后,流程结束

## 扩展说明

如果需要扩展此场景,可以考虑:

1. **添加更多条件分支**: 根据项目金额、部门等条件选择不同路径
2. **添加更多审批模式**: 结合其他审批模式,如单人审批、会签等
3. **添加更多动态审批人**: 为更多节点配置动态审批人
4. **添加更多超时处理**: 为更多节点配置超时时间
5. **添加更多拒绝后处理**: 配置更多拒绝后跳转场景
6. **添加更多事件通知**: 为更多节点配置 Webhook 通知

## 相关场景

- **场景 03**: 条件分支审批流程 - 可以根据条件选择不同的审批路径
- **场景 04**: 动态审批人获取 - 通过 HTTP API 动态获取审批人
- **场景 05**: 顺序审批流程 - 多个审批人按顺序依次审批
- **场景 06**: 比例会签审批流程 - 达到指定比例即可通过
- **场景 09**: 超时处理场景 - 节点超时配置和处理
- **场景 13**: 事件通知集成场景 - Webhook 事件通知
- **场景 16**: 或签模式独立场景 - 任意一人同意即可通过
- **场景 18**: 枚举判断条件场景 - 使用枚举条件进行判断
