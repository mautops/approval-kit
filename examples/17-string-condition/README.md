# 场景 17: 字符串匹配条件场景

## 场景描述

这是一个字符串匹配条件场景示例,演示合同审批流程,根据合同类型(字符串匹配)选择不同的审批路径.

**业务背景**: 合同审批需要根据合同类型选择不同的审批路径.例如,包含"采购"的合同需要采购部门审批,以"服务"开头的合同需要法务部门审批,其他类型走标准审批流程.这种模式适用于需要根据文本内容进行条件判断的场景.

## 流程结构

```
开始节点
  ↓
条件节点(字符串匹配)
  ├─→ [合同类型包含"采购" OR 以"服务"开头] → 采购审批 → 结束
  └─→ [其他情况]                            → 标准审批 → 结束
```

流程说明:
1. **开始节点**: 流程的起点,自动执行
2. **条件节点**: 字符串匹配条件判断节点
   - 条件类型: 组合条件 (composite)
   - 操作符: OR (任意一个条件满足即可)
   - 子条件1: 合同类型包含"采购" (contains)
   - 子条件2: 合同类型以"服务"开头 (starts_with)
   - True: 跳转到采购审批节点
   - False: 跳转到标准审批节点
3. **采购审批节点**: 条件满足时使用
   - 审批模式: 单人审批 (ApprovalModeSingle)
   - 审批人: 采购经理
4. **标准审批节点**: 条件不满足时使用
   - 审批模式: 单人审批 (ApprovalModeSingle)
   - 审批人: 经理
5. **结束节点**: 流程的终点

## 关键特性

- **字符串匹配条件**: 使用 StringConditionConfig 实现字符串匹配
- **多种操作符**: 支持 equals、contains、starts_with、ends_with 等操作符
- **条件组合**: 支持多个字符串条件组合(AND/OR)
- **灵活判断**: 支持复杂的字符串判断逻辑

## 代码说明

### 主要组件

1. **模板创建** (`createTemplate`):
   - 创建包含条件节点、采购审批节点、标准审批节点的模板
   - 配置条件节点使用组合条件(OR 逻辑)
   - 配置字符串匹配条件(contains、starts_with)

2. **字符串匹配演示** (`demonstrateStringConditions`):
   - 演示不同字符串匹配的场景
   - 展示条件判断逻辑和预期路径

3. **结果输出**:
   - 输出不同场景的任务参数和条件判断结果
   - 说明字符串匹配条件的配置和使用方法

### 代码结构

```go
main()
  ├── 创建管理器 (TemplateManager, TaskManager)
  ├── 创建模板 (createTemplate)
  │   └── 配置条件节点 (组合条件: OR 逻辑 + 字符串匹配)
  └── 演示字符串匹配 (demonstrateStringConditions)
      ├── 场景1: 合同类型包含"采购"
      ├── 场景2: 合同类型以"服务"开头
      └── 场景3: 其他合同类型
```

### 字符串匹配条件配置示例

```go
Condition: &node.Condition{
    Type: "string",
    Config: &node.StringConditionConfig{
        Field:    "contractType",
        Operator: "contains", // 包含
        Value:    "采购",
        Source:   "task_params",
    },
}
```

### 组合条件配置示例

```go
Condition: &node.Condition{
    Type: "composite",
    Config: &node.CompositeConditionConfig{
        Operator: "or", // OR 逻辑: 任意一个条件满足即可
        Conditions: []*node.Condition{
            {
                Type: "string",
                Config: &node.StringConditionConfig{
                    Field:    "contractType",
                    Operator: "contains",
                    Value:    "采购",
                    Source:   "task_params",
                },
            },
            {
                Type: "string",
                Config: &node.StringConditionConfig{
                    Field:    "contractType",
                    Operator: "starts_with",
                    Value:    "服务",
                    Source:   "task_params",
                },
            },
        },
    },
}
```

## 执行方法

### 前置要求

- Go 1.25.4 或更高版本
- 已安装 approval-kit 依赖

### 执行步骤

1. 进入场景目录:
   ```bash
   cd examples/17-string-condition
   ```

2. 运行程序:
   ```bash
   go run main.go
   ```

### 预期输出

程序运行后会输出以下内容:

```
=== 场景 17: 字符串匹配条件场景 ===

步骤 1: 创建审批模板
✓ 模板创建成功: ID=string-condition-template, Name=合同审批模板

=== 场景 1: 合同类型包含"采购" ===

✓ 任务创建成功: ID=task-1763522153377500000-1
  任务参数:
    contractNo: CT-2025-001
    contractType: 设备采购合同
    contractor: 供应商-001
    amount: 100000
    description: 设备采购合同审批
  条件判断: 合同类型包含"采购" OR 合同类型以"服务"开头
  实际结果: 合同类型="设备采购合同",包含"采购",条件满足
  预期路径: 采购审批路径

=== 场景 2: 合同类型以"服务"开头 ===

✓ 任务创建成功: ID=task-1763522153377722000-2
  任务参数:
    amount: 50000
    description: 服务外包合同审批
    contractNo: CT-2025-002
    contractType: 服务外包合同
    contractor: 服务商-001
  条件判断: 合同类型包含"采购" OR 合同类型以"服务"开头
  实际结果: 合同类型="服务外包合同",以"服务"开头,条件满足
  预期路径: 采购审批路径

=== 场景 3: 其他合同类型 ===

✓ 任务创建成功: ID=task-1763522153377736000-3
  任务参数:
    contractNo: CT-2025-003
    contractType: 租赁合同
    contractor: 出租方-001
    amount: 30000
    description: 租赁合同审批
  条件判断: 合同类型包含"采购" OR 合同类型以"服务"开头
  实际结果: 合同类型="租赁合同",不包含"采购"且不以"服务"开头,条件不满足
  预期路径: 标准审批路径

=== 字符串匹配条件说明 ===
  字符串匹配条件配置:
    - 操作符: contains (包含)
    - 操作符: starts_with (以...开始)
    - 操作符: ends_with (以...结束)
    - 操作符: eq (等于)

  条件组合:
    - 条件1: 合同类型包含"采购"
    - 条件2: 合同类型以"服务"开头
    - 组合逻辑: OR (任意一个条件满足即可)

  审批路径:
    - True (条件满足): 采购审批路径
    - False (条件不满足): 标准审批路径

  注意: 本示例仅展示字符串匹配条件的配置方法
  实际执行需要在实际业务系统中实现条件评估和流程跳转
```

**注意**: 
- 任务 ID 是动态生成的,每次运行都会不同
- 时间戳是实际运行时间,每次运行都会不同
- 任务参数中的字段顺序可能因 JSON 解析而有所不同
- 本示例仅展示字符串匹配条件的配置方法,实际执行需要在实际业务系统中实现条件评估和流程跳转

## 验证步骤

1. **验证模板创建**:
   - 检查模板是否包含开始节点、条件节点、采购审批节点、标准审批节点、结束节点
   - 检查条件节点是否配置了字符串匹配条件
   - 检查字符串匹配条件的操作符是否正确(contains、starts_with)

2. **验证字符串匹配条件**:
   - 检查字符串匹配条件是否包含正确的字段名(contractType)
   - 检查操作符是否正确(contains、starts_with)
   - 检查匹配值是否正确("采购"、"服务")
   - 检查数据源是否正确(task_params)

3. **验证不同场景**:
   - 场景1: 合同类型包含"采购" → 应该走采购审批路径
   - 场景2: 合同类型以"服务"开头 → 应该走采购审批路径
   - 场景3: 其他合同类型 → 应该走标准审批路径

### 验证要点

- ✓ 字符串匹配条件节点已正确配置
- ✓ OR 逻辑正确实现(任意一个条件满足即可)
- ✓ contains 操作符正确配置(合同类型包含"采购")
- ✓ starts_with 操作符正确配置(合同类型以"服务"开头)
- ✓ 不同场景的条件判断结果正确

## 字符串匹配操作符说明

系统支持以下字符串匹配操作符:

- **eq (等于)**: 字符串完全匹配
  - 示例: `contractType eq "采购合同"`
- **contains (包含)**: 字符串包含指定子串
  - 示例: `contractType contains "采购"`
- **starts_with (以...开始)**: 字符串以指定前缀开始
  - 示例: `contractType starts_with "服务"`
- **ends_with (以...结束)**: 字符串以指定后缀结束
  - 示例: `contractType ends_with "合同"`

## 适用场景

这个场景适用于以下实际业务场景:

- **合同审批**: 根据合同类型选择不同的审批路径
- **项目审批**: 根据项目名称或类型选择不同的审批路径
- **部门审批**: 根据部门名称选择不同的审批路径
- **其他文本匹配场景**: 需要根据文本内容进行条件判断的场景

## 扩展说明

如果需要扩展此场景,可以考虑:

1. **测试更多操作符**: 测试 equals、ends_with 等操作符
2. **测试大小写敏感**: 测试字符串匹配是否区分大小写
3. **测试组合条件**: 配置 AND 逻辑的组合条件,测试条件判断
4. **测试嵌套组合**: 配置嵌套的组合条件,测试复杂业务逻辑
5. **测试节点输出数据**: 使用节点输出数据作为条件数据源

## 相关场景

- **场景 03**: 条件分支审批流程 - 单个条件判断
- **场景 12**: 多条件组合判断场景 - 可以结合字符串匹配实现更复杂的条件判断

