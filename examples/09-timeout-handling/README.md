# 场景 09: 超时处理场景

## 场景描述

这是一个超时处理场景示例,模拟紧急审批流程.如果审批人在指定时间内未审批,系统可以自动处理或发送通知.

**业务背景**: 紧急采购申请需要在24小时内完成审批.如果审批人在24小时内未审批,系统应该自动处理或发送通知,确保紧急业务能够及时处理.这种模式适用于有时间要求的审批流程.

## 流程结构

```
开始节点 → 审批节点(配置超时) → 结束节点
```

流程说明:
1. **开始节点**: 流程的起点,自动执行
2. **审批节点**: 紧急审批节点,配置了超时时间
   - 审批模式: 单人审批 (ApprovalModeSingle)
   - 审批人: 审批人
   - **超时配置**: 24小时超时时间
3. **结束节点**: 流程的终点

## 关键特性

- **超时配置**: 使用 Timeout 配置节点超时时间
- **超时检测**: 通过 CheckTimeout 方法检测任务是否超时
- **超时处理**: 通过 HandleTimeout 方法处理超时任务
- **超时事件**: 超时后生成超时事件,可以触发通知或自动处理

## 代码说明

### 主要组件

1. **模板创建** (`createTemplate`):
   - 创建包含紧急审批节点的模板
   - 配置审批模式为单人审批 (ApprovalModeSingle)
   - 配置超时时间为24小时 (Timeout: 24 * time.Hour)

2. **任务创建** (`main`):
   - 创建紧急审批任务
   - 传入任务参数(申请编号、申请类型、申请人、金额、紧急程度、描述等)

3. **流程执行** (`runScenario`):
   - 提交任务进入审批流程
   - 设置审批人
   - 说明超时检测和处理流程

4. **结果输出** (`printResults`):
   - 输出任务状态、审批记录
   - 验证超时配置

### 代码结构

```go
main()
  ├── 创建管理器 (TemplateManager, TaskManager)
  ├── 创建模板 (createTemplate)
  │   └── 配置审批节点 (Timeout: 24小时)
  ├── 创建任务 (Create)
  ├── 执行流程 (runScenario)
  │   ├── 提交任务 (Submit)
  │   ├── 设置审批人 (AddApprover)
  │   └── 说明超时处理流程
  └── 输出结果 (printResults)
```

### 超时配置示例

```go
timeout := 24 * time.Hour // 24小时超时
Config: &node.ApprovalNodeConfig{
    Mode: node.ApprovalModeSingle,
    ApproverConfig: &node.FixedApproverConfig{
        Approvers: []string{"manager-001"},
    },
    Timeout: &timeout, // 配置超时时间
}
```

### 超时检测和处理示例

```go
// 检查是否超时
isTimeout, nodeID := taskMgr.CheckTimeout(tsk)
if isTimeout {
    // 处理超时任务
    err := taskMgr.HandleTimeout(tsk.ID)
    if err != nil {
        // 处理错误
    }
}
```

## 执行方法

### 前置要求

- Go 1.25.4 或更高版本
- 已安装 approval-kit 依赖

### 执行步骤

1. 进入场景目录:
   ```bash
   cd examples/09-timeout-handling
   ```

2. 运行程序:
   ```bash
   go run main.go
   ```

### 预期输出

程序运行后会输出以下内容:

```
=== 场景 09: 超时处理场景 ===

步骤 1: 创建审批模板
✓ 模板创建成功: ID=urgent-approval-template, Name=紧急审批模板

步骤 2: 创建紧急审批任务
✓ 任务创建成功: ID=task-1763521219095356000-1, State=pending

步骤 3: 提交任务进入审批流程
✓ 任务已提交: State=submitted
  提交时间: 2025-11-19 11:00:19

步骤 4: 设置审批人
✓ 审批人已设置: manager-001

步骤 5: 检查超时配置
  说明: 审批节点配置了24小时超时时间
  超时时间: 24小时
  超时处理: 如果审批人在24小时内未审批,任务状态将变为timeout

步骤 6: 模拟超时检测
  说明: 在实际业务系统中,应该有定时任务定期检查超时任务
  本示例展示超时检测和处理的配置方法

  模拟场景: 假设任务已超过超时时间
  说明: 在实际业务系统中,可以通过以下方式处理超时:
    1. 定时任务定期调用 CheckTimeout 检查超时任务
    2. 调用 HandleTimeout 处理超时任务
    3. 超时后可以自动通过、自动拒绝或发送通知

步骤 7: 超时处理流程说明
  1. 任务提交后,开始计时
  2. 定时任务定期检查任务是否超时
  3. 如果超时,调用 HandleTimeout 处理超时任务
  4. 任务状态变为 timeout,生成超时事件
  5. 根据业务规则,可以自动通过、自动拒绝或发送通知

✓ 超时处理功能配置和使用方法已展示

=== 审批结果 ===
任务 ID: task-1763521219095356000-1
业务 ID: urgent-001
模板 ID: urgent-approval-template
当前状态: submitted
当前节点: start
创建时间: 2025-11-19 11:00:19
提交时间: 2025-11-19 11:00:19
已过去时间: 0秒
更新时间: 2025-11-19 11:00:19

任务参数:
  amount: 50000
  urgency: high
  description: 紧急采购申请,需要在24小时内完成审批
  requestNo: REQ-2025-001
  requestType: 紧急采购
  requester: 采购员-001

审批人列表:
  - manager-001

审批记录:
  记录 1:
    节点: 紧急审批
    审批人: manager-001
    操作类型: 加签
    操作说明: 设置审批人
    操作时间: 2025-11-19 11:00:19

状态变更历史:
  变更 1: pending -> submitted (原因: task submitted, 时间: 2025-11-19 11:00:19)

=== 验证结果 ===
✓ 超时配置已正确设置:
  - 审批节点配置了24小时超时时间
  - 超时检测机制已配置
  - 超时处理逻辑已配置

  说明: 在实际业务系统中,可以通过以下方式使用超时功能:
    1. 定时任务定期调用 CheckTimeout 检查超时任务
    2. 调用 HandleTimeout 处理超时任务
    3. 超时后任务状态变为 timeout,生成超时事件
    4. 根据业务规则,可以自动通过、自动拒绝或发送通知
```

**注意**: 
- 任务 ID 是动态生成的,每次运行都会不同
- 时间戳是实际运行时间,每次运行都会不同
- 任务参数中的字段顺序可能因 JSON 解析而有所不同
- 本示例展示超时配置和检测方法,实际超时处理需要在实际业务系统中实现定时任务

## 验证步骤

1. **验证模板创建**:
   - 检查模板是否包含开始节点、审批节点、结束节点
   - 检查审批节点是否配置了超时时间
   - 检查超时时间是否正确(24小时)

2. **验证任务创建**:
   - 检查任务初始状态是否为 `pending`
   - 检查任务参数是否正确设置(紧急申请信息等)

3. **验证任务提交**:
   - 检查任务状态是否从 `pending` 变为 `submitted`
   - 检查提交时间是否已设置

4. **验证审批人设置**:
   - 检查审批人列表是否正确设置
   - 检查审批人是否正确设置

5. **验证超时配置**:
   - 检查审批节点是否配置了超时时间
   - 检查超时时间是否正确(24小时)

### 验证要点

- ✓ 审批节点配置了24小时超时时间
- ✓ 超时检测机制已配置
- ✓ 超时处理逻辑已配置
- ✓ 任务提交时间已正确设置
- ✓ 审批记录正确生成

## 适用场景

这个场景适用于以下实际业务场景:

- **紧急采购**: 需要在指定时间内完成审批的紧急采购申请
- **紧急审批**: 有时间要求的紧急审批流程
- **其他有时间要求的审批**: 需要在指定时间内完成审批的场景

## 超时处理机制说明

### 超时检测

超时检测通过 `CheckTimeout` 方法实现:
- 检查任务当前状态(只有 `submitted` 或 `approving` 状态的任务才需要检查超时)
- 检查当前节点是否配置了超时时间
- 计算从任务提交时间到当前时间的时间间隔
- 如果时间间隔超过配置的超时时间,返回超时

### 超时处理

超时处理通过 `HandleTimeout` 方法实现:
- 检查任务是否超时
- 如果超时,将任务状态转换为 `timeout`
- 生成超时事件,可以触发通知或自动处理

### 实际业务系统中的使用

在实际业务系统中,应该:
1. 创建定时任务,定期检查超时任务
2. 对于超时的任务,调用 `HandleTimeout` 处理
3. 根据业务规则,可以:
   - 自动通过(如果业务允许)
   - 自动拒绝(如果业务要求)
   - 发送通知给相关人员
   - 升级到上级审批人

## 扩展说明

如果需要扩展此场景,可以考虑:

1. **测试实际超时**: 创建任务后等待超时时间,然后检查超时处理
2. **测试超时事件**: 配置事件通知器,验证超时事件是否正确生成
3. **测试超时后自动处理**: 根据业务规则,实现超时后自动通过或拒绝
4. **测试不同超时时间**: 配置不同的超时时间,测试超时检测和处理
5. **动态超时配置**: 根据任务参数动态配置超时时间

## 相关场景

- **场景 01**: 最简单的单人审批流程 - 单个审批人场景
- **场景 08**: 高级操作场景 - 可以结合转交、加签、减签实现超时后的处理

