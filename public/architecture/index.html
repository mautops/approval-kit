<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><title>架构设计 | Approval Kit 文档</title><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="Approval Kit 的系统架构和设计理念"><meta name=generator content="Hugo 0.152.2"><meta name=robots content="index, follow"><meta name=author content="Approval Kit Team"><link rel=stylesheet href=/approval-kit/ananke/css/main.min.efe4d852f731d5d1fbb87718387202a97aafd768cdcdaed0662bbe6982e91824.css><link href=/approval-kit/architecture/index.xml rel=alternate type=application/rss+xml title="Approval Kit 文档"><link href=/approval-kit/architecture/index.xml rel=feed type=application/rss+xml title="Approval Kit 文档"><link rel=canonical href=https://mautops.github.io/approval-kit/architecture/><meta property="og:url" content="https://mautops.github.io/approval-kit/architecture/"><meta property="og:site_name" content="Approval Kit 文档"><meta property="og:title" content="架构设计"><meta property="og:description" content="Approval Kit 的系统架构和设计理念"><meta property="og:locale" content="zh_cn"><meta property="og:type" content="website"><meta itemprop=name content="架构设计"><meta itemprop=description content="Approval Kit 的系统架构和设计理念"><meta itemprop=datePublished content="2025-11-19T00:00:00+00:00"><meta itemprop=dateModified content="2025-11-19T00:00:00+00:00"><meta itemprop=wordCount content="277"><meta name=twitter:card content="summary"><meta name=twitter:title content="架构设计"><meta name=twitter:description content="Approval Kit 的系统架构和设计理念"></head><body class="ma0 avenir bg-near-white production"><header><div class="pb3-m pb6-l bg-black"><nav class="pv3 ph3 ph4-ns" role=navigation><div class="flex-l center items-center justify-between"><a href=/approval-kit/ class="f3 fw2 hover-white white-90 dib no-underline">Approval Kit 文档</a><div class="flex-l items-center"><ul class="pl0 mr3"><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white white-90 no-underline" href=/approval-kit/ title="首页 page">首页</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white white-90 no-underline" href=/approval-kit/getting-started/ title="快速开始 page">快速开始</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white white-90 no-underline" href=/approval-kit/concepts/ title="核心概念 page">核心概念</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white white-90 no-underline" href=/approval-kit/api/ title="API 参考 page">API 参考</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white white-90 no-underline" href=/approval-kit/examples/ title="使用示例 page">使用示例</a></li><li class="list f5 f4-ns fw4 dib pr3"><a class="hover-white white-90 no-underline" href=/approval-kit/architecture/ title="架构设计 page">架构设计</a></li></ul><div class=ananke-socials></div></div></div></nav><div class="tc-l pv3 ph3 ph4-ns"><h1 class="f2 f-subheadline-l fw2 light-silver mb0 lh-title">架构设计</h1><h2 class="fw1 f5 f3-l white-80 measure-wide-l center lh-copy mt3 mb4">Approval Kit 的系统架构和设计理念</h2></div></div></header><main class=pb7 role=main><article class="pa3 pa4-ns nested-copy-line-height"><section class="cf ph3 ph5-l pv3 pv4-l f4 tc-l center measure-wide lh-copy nested-links mid-gray"><h2 id=整体架构>整体架构</h2><p>Approval Kit 采用分层架构设计,核心层专注于状态管理和数据流转,通过接口抽象与上层业务系统解耦.</p><pre tabindex=0><code>┌─────────────────────────────────────────┐
│        业务系统层 (外部实现)              │
│  - 数据持久化                            │
│  - 用户认证授权                          │
│  - API 接口                              │
└─────────────────┬───────────────────────┘
                  │ 接口抽象
┌─────────────────▼───────────────────────┐
│        审批流核心库                        │
│  ┌───────────────────────────────────┐  │
│  │  状态机引擎 (FSM)                  │  │
│  │  - 状态定义                        │  │
│  │  - 状态转换规则                    │  │
│  │  - 状态转换执行                    │  │
│  └───────────────────────────────────┘  │
│  ┌───────────────────────────────────┐  │
│  │  模板管理模块                      │  │
│  │  - 模板定义                        │  │
│  │  - 版本控制                        │  │
│  │  - 模板验证                        │  │
│  └───────────────────────────────────┘  │
│  ┌───────────────────────────────────┐  │
│  │  任务管理模块                      │  │
│  │  - 任务创建                        │  │
│  │  - 任务查询                        │  │
│  │  - 任务操作                        │  │
│  └───────────────────────────────────┘  │
│  ┌───────────────────────────────────┐  │
│  │  节点执行引擎                      │  │
│  │  - 节点激活                        │  │
│  │  - 节点执行                        │  │
│  │  - 上下文管理                      │  │
│  └───────────────────────────────────┘  │
│  ┌───────────────────────────────────┐  │
│  │  事件通知模块                      │  │
│  │  - 事件生成                        │  │
│  │  - 异步推送                        │  │
│  │  - 重试机制                        │  │
│  └───────────────────────────────────┘  │
└─────────────────────────────────────────┘
</code></pre><h2 id=核心设计原则>核心设计原则</h2><h3 id=1-业务无关性>1. 业务无关性</h3><p>本库必须保持业务无关,仅负责维护审批数据和状态流转.禁止包含任何具体业务逻辑、前端界面代码或 API 接口实现.</p><h3 id=2-无数据存储>2. 无数据存储</h3><p>本库不得包含任何数据持久化逻辑.所有数据存储操作必须由上层业务系统负责.</p><h3 id=3-状态管理核心>3. 状态管理核心</h3><p>本库的核心职责是管理审批模板和审批任务的状态流转.必须明确定义审批状态机,确保状态转换的合法性和一致性.</p><h3 id=4-测试优先>4. 测试优先</h3><p>采用测试驱动开发(TDD),严格遵循红-绿-重构循环.测试覆盖率必须达到关键路径 100%,整体覆盖率不低于 80%.</p><h3 id=5-简洁设计>5. 简洁设计</h3><p>遵循 YAGNI 原则,避免过度设计.代码必须简洁明了,优先使用 Go 语言的标准库和惯用法.</p><h2 id=模块划分>模块划分</h2><h3 id=模板管理-template>模板管理 (template)</h3><p>负责审批模板的定义、验证和版本管理.</p><ul><li><strong>Template</strong>: 模板数据结构</li><li><strong>Node</strong>: 节点定义</li><li><strong>Edge</strong>: 节点连接关系</li><li><strong>TemplateManager</strong>: 模板管理接口</li></ul><h3 id=任务管理-task>任务管理 (task)</h3><p>负责审批任务的创建、查询和操作.</p><ul><li><strong>Task</strong>: 任务数据结构</li><li><strong>TaskManager</strong>: 任务管理接口</li><li><strong>Record</strong>: 审批记录</li><li><strong>StateChange</strong>: 状态变更历史</li></ul><h3 id=状态机-statemachine>状态机 (statemachine)</h3><p>负责任务状态流转的管理.</p><ul><li><strong>StateMachine</strong>: 状态机接口</li><li><strong>FSM</strong>: 状态机实现</li><li><strong>Transitions</strong>: 状态转换规则</li></ul><h3 id=节点执行-node>节点执行 (node)</h3><p>负责节点的配置和执行.</p><ul><li><strong>NodeExecutor</strong>: 节点执行器接口</li><li><strong>ApprovalNodeExecutor</strong>: 审批节点执行器</li><li><strong>ConditionNodeExecutor</strong>: 条件节点执行器</li><li><strong>ApproverConfig</strong>: 审批人配置接口</li></ul><h3 id=事件通知-event>事件通知 (event)</h3><p>负责事件生成和推送.</p><ul><li><strong>EventNotifier</strong>: 事件通知器</li><li><strong>EventHandler</strong>: 事件处理器接口</li><li><strong>WebhookHandler</strong>: Webhook 处理器</li></ul><h2 id=并发安全>并发安全</h2><p>使用读写锁(<code>sync.RWMutex</code>)保护任务状态,支持并发读取,串行化写入.</p><p>状态转换使用版本号机制确保原子性,防止并发修改冲突.</p><h2 id=扩展性设计>扩展性设计</h2><p>通过接口抽象支持功能扩展:</p><ul><li><strong>HTTPClient</strong>: HTTP 客户端接口,支持自定义实现</li><li><strong>ConditionEvaluator</strong>: 条件评估接口,支持自定义条件类型</li><li><strong>EventHandler</strong>: 事件处理器接口,支持自定义事件处理</li></ul><h2 id=依赖管理>依赖管理</h2><p>优先使用 Go 标准库,最小化外部依赖.所有依赖必须经过充分论证.</p><p>当前依赖:</p><ul><li>Go 标准库: <code>encoding/json</code>, <code>net/http</code>, <code>sync</code>, <code>time</code>, <code>context</code></li></ul></section><section class="flex-ns mt5 flex-wrap justify-around"></section></article></main><footer class="bg-black bottom-0 w-100 pa3" role=contentinfo><div class="flex justify-between"><a class="f4 fw4 hover-white white-70 dn dib-ns pv2 ph3 no-underline" href=https://mautops.github.io/approval-kit/>&copy; Approval Kit 文档 2025</a><div><div class=ananke-socials></div></div></div></footer></body></html>