# Approval Kit Slidev 文档大纲

## 文档结构概览

本文档将系统、全面、精准地介绍 Approval Kit 审批流核心库,包含以下主要部分:

1. **封面与介绍** (2 页)
2. **项目概述** (2 页)
3. **核心架构** (3 页)
4. **核心功能详解** (12 页)
5. **使用指南** (5 页)
6. **代码示例** (2 页)
7. **最佳实践** (2 页)
8. **总结与资源** (2 页)

**总计约 30 页幻灯片**

---

## 详细大纲

### 第一部分: 封面与介绍 (2 页)

#### 1. 封面页

- 标题: Approval Kit - 审批流核心库
- 副标题: 专注于管理审批模板和审批任务的状态流转
- 版本信息: v1.0.0
- 项目链接: GitHub 仓库地址

#### 2. 目录页

- 使用 `<Toc>` 组件自动生成目录
- 展示文档主要章节
- 项目定位: 业务无关的审批流核心库
- 设计理念: 专注状态流转,不涉及业务逻辑

---

### 第二部分: 项目概述 (2 页)

#### 3. 什么是 Approval Kit?

- 定义: Go 语言编写的审批流核心库
- 核心职责: 管理审批模板和审批任务的状态流转
- 设计原则: 业务无关、无数据存储、状态管理核心
- 核心特性概览:
  - 模板管理: 创建、更新、删除、查询、版本控制
  - 任务管理: 创建、提交、审批、查询
  - 状态机: 状态流转管理
  - 多种审批模式: 单人、会签、或签、比例会签、顺序审批
  - 动态审批人: HTTP API 动态获取
  - 条件分支: 数值、字符串、枚举、组合条件
  - 高级操作: 转交、加签、减签、撤回、取消
  - 事件通知: Webhook 异步推送
  - 并发安全: 读写锁、版本号机制

#### 4. 适用场景与技术栈

- 适用场景:
  - 企业审批流程: 请假、报销、采购、合同等
  - 工作流引擎: 作为工作流引擎的核心组件
  - 审批系统: 构建完整的审批系统
  - 业务流程: 需要状态流转的业务场景
- 技术栈:
  - 语言: Go 1.25.4+
  - 依赖: 最小化外部依赖,优先使用标准库
  - 架构: 分层架构,接口抽象
  - 测试: TDD 开发,高测试覆盖率

---

### 第三部分: 核心架构 (3 页)

#### 5. 整体架构与状态机

- 整体架构图: 使用 Mermaid 流程图展示
  - 分层设计: 业务系统层 → 审批流核心库 → 扩展接口层
  - 核心模块: 状态机引擎、模板管理、任务管理、节点执行引擎、事件通知
- 状态机设计:
  - 状态定义: pending、submitted、approving、approved、rejected、cancelled、timeout
  - 状态转换规则: 使用状态转换图展示
  - 状态机接口: CanTransition、Transition、GetValidTransitions
  - 并发安全: 版本号机制、原子操作

#### 6. 模板与任务管理架构

- 模板管理架构:
  - Template 结构: ID、Name、Description、Version、Nodes、Edges、Config
  - 节点类型: Start、Approval、Condition、End
  - 节点连接: Edge 定义节点间的连接关系
  - 版本控制: 模板版本管理机制
- 任务管理架构:
  - Task 结构: 基本信息、状态信息、运行时数据、审批记录、状态变更历史
  - 并发安全: 读写锁保护
  - 数据流转: 节点输出数据、审批人列表、审批结果

#### 7. 节点执行引擎与事件通知

- 节点执行引擎:
  - NodeExecutor 接口: 统一的节点执行接口
  - 节点类型执行器: StartNodeExecutor、ApprovalNodeExecutor、ConditionNodeExecutor、EndNodeExecutor
  - 节点上下文: NodeContext 提供执行上下文信息
  - 数据传递: 节点输出数据、上下文缓存
- 事件通知机制:
  - 事件类型: 任务创建、提交、节点激活、审批操作、任务完成等
  - 异步推送: goroutine + channel 实现
  - 重试机制: 指数退避策略
  - Webhook 配置: 支持多个 Webhook 地址

---

### 第四部分: 核心功能详解 (12 页)

#### 8. 审批模式概览

- 5 种审批模式对比:
  - 单人审批: 单个审批人进行审批,适用于简单的单级审批
  - 多人会签: 多个审批人需全部同意,适用于需要多个部门共同决策
  - 多人或签: 多个审批人中任意一人同意即可,适用于紧急审批
  - 比例会签: 达到指定比例同意即可,适用于技术评审、方案评审
  - 顺序审批: 按顺序依次审批,适用于多级审批链
- 代码示例: 展示不同审批模式的配置方式

#### 9. 审批人配置

- 固定审批人: FixedApproverConfig,适用于审批人固定的场景
- 动态审批人: DynamicApproverConfig
  - HTTP API 配置: URL、Method、Headers、参数映射、响应解析
  - 获取时机: 任务创建时 / 节点激活时
  - 重试机制: API 调用失败自动重试
- 代码示例: 展示固定和动态审批人配置

#### 10. 条件节点 - 基础条件

- 数值比较: 等于、大于、小于、大于等于、小于等于
- 字符串匹配: 等于、包含、以...开始、以...结束
- 枚举判断: in(在列表中)、not_in(不在列表中)
- 数据源: 任务参数、节点输出
- 代码示例: 展示基础条件配置

#### 11. 条件节点 - 组合条件与数据传递

- 组合条件: AND、OR 逻辑组合,支持复杂的业务规则
- 节点数据传递:
  - 节点输出: 每个节点可以输出 JSON 格式的数据
  - 数据读取: 后续节点可以读取前面节点的输出
  - 上下文缓存: 避免重复查询,提高性能
- 代码示例: 展示组合条件和数据传递

#### 12. 拒绝后处理与高级操作

- 拒绝后处理:
  - 处理方式: 终止、回退到上一节点、跳转到指定节点
  - 配置方式: RejectBehavior
  - 使用场景: 需要支持驳回修改的场景
- 高级操作:
  - 转交审批: 审批人可以将任务转交给其他审批人
  - 加签: 在审批过程中添加额外的审批人
  - 减签: 移除部分审批人(需权限控制)
  - 操作权限: 节点级别控制是否允许这些操作
- 代码示例: 展示拒绝后处理和高级操作配置

#### 13. 超时处理与审批配置

- 超时处理:
  - 超时配置: 节点级别配置超时时间
  - 超时检测: 自动检测超时任务
  - 超时处理: 自动处理或触发超时事件通知
- 审批配置:
  - 审批意见必填: RequireComment 配置
  - 附件要求必填: RequireAttachments 配置
  - 验证机制: 审批操作时自动验证
- 代码示例: 展示超时处理和审批配置

#### 14. 事件通知

- 事件类型: 任务创建、提交、节点激活、审批操作、任务完成等
- Webhook 配置: 支持多个 Webhook 地址、认证配置
- 异步推送: 不阻塞主流程
- 重试机制: 指数退避策略
- 幂等性: 确保事件不重复处理
- 代码示例: 展示事件通知配置

#### 15. 查询功能与版本管理

- 查询功能:
  - 任务查询: 按状态、模板、业务 ID、审批人、时间范围查询
  - 审批记录查询: 通过任务对象查询所有审批记录
  - 状态变更历史: 查询任务的所有状态变更历史
- 模板版本管理:
  - 版本控制: 每次更新创建新版本
  - 历史版本保留: 已创建的任务使用创建时的模板版本
  - 版本查询: 支持查询所有版本
- 代码示例: 展示查询功能和版本管理

---

### 第五部分: 使用指南 (5 页)

#### 16. 快速开始

- 安装: go get 命令
- 基本使用: 创建模板、创建任务、提交、审批
- 最小示例: 展示最简单的使用场景

#### 17. 模板与任务管理

- 模板创建:
  - 模板结构: 节点定义、边定义
  - 节点配置: 不同类型节点的配置方式
- 任务管理:
  - 任务创建: 基于模板创建任务
  - 任务提交: 提交任务进入审批流程
  - 审批操作: 同意、拒绝操作
  - 任务查询: 多维度查询任务

#### 18. 状态流转与节点配置

- 状态流转:
  - 状态转换: 合法的状态转换路径
  - 状态机使用: 如何通过状态机进行状态转换
  - 状态查询: 查询当前状态和有效转换
- 节点配置:
  - 审批节点: 审批模式、审批人配置、其他配置
  - 条件节点: 条件类型、数据源、条件表达式
  - 节点执行: 节点执行流程、数据传递

#### 19. 事件通知与并发安全

- 事件通知:
  - Webhook 配置: 如何配置 Webhook
  - 事件处理: 如何处理接收到的事件
  - 重试机制: 重试策略和错误处理
- 并发安全:
  - 并发访问: 如何安全地并发访问任务
  - 状态一致性: 保证状态转换的一致性
  - 最佳实践: 并发使用建议

#### 20. 错误处理

- 错误类型: 常见的错误类型
- 错误处理: 如何正确处理错误
- 调试技巧: 问题排查方法

---

### 第六部分: 代码示例 (2 页)

#### 21. 示例 01: 最简单的单人审批流程

- 场景描述: 请假申请,只需要直接主管审批
- 流程结构: 开始节点 → 审批节点(单人审批) → 结束节点
- 完整代码: 展示第一个示例的完整代码
- 执行结果: 展示运行结果

#### 22. 其他示例概览

- 示例列表: 列出所有 25 个示例
- 示例分类: 按功能分类展示
- 跳转指引: 指引用户到代码仓库查看其他示例
- 仓库链接: GitHub 仓库地址和示例目录

---

### 第七部分: 最佳实践 (2 页)

#### 23. 设计最佳实践

- 模板设计:
  - 节点设计: 如何设计合理的节点结构
  - 条件分支: 如何设计条件分支逻辑
  - 版本管理: 如何管理模板版本
- 任务管理:
  - 任务创建: 任务创建的最佳实践
  - 状态管理: 状态流转的最佳实践
  - 数据传递: 节点数据传递的最佳实践

#### 24. 性能与安全建议

- 性能优化:
  - 并发优化: 如何优化并发性能
  - 查询优化: 如何优化查询性能
  - 内存优化: 如何优化内存使用
- 安全建议:
  - 并发安全: 并发访问的安全建议
  - 数据安全: 数据保护建议
  - 错误处理: 错误处理建议

---

### 第八部分: 总结与资源 (2 页)

#### 25. 核心能力总结

- 功能总结: 核心功能列表
- 特性总结: 核心特性列表
- 适用场景: 适用场景总结

#### 26. 项目信息与资源

- 项目信息:
  - 项目地址: GitHub 仓库链接
  - 文档链接: 相关文档链接
  - 示例代码: 示例代码目录(25 个使用场景示例)
  - 贡献指南: 如何参与贡献
- 参考资料:
  - 官方文档: 相关文档链接
  - 技术文档: 架构设计文档
  - 社区资源: 社区讨论和帮助
- 结束页: 感谢观看、项目链接

---

## 设计说明

### 视觉设计

- 使用 `seriph` 主题(或其他合适的主题)
- 统一的配色方案
- 清晰的图表和流程图
- 代码高亮使用 Monaco 编辑器风格

### 交互设计

- 使用 `v-click` 实现逐步展示
- 重要内容使用动画强调
- 代码示例使用可交互的代码块
- 流程图使用 Mermaid 动态生成

### 内容组织

- 每个功能点独立一页或几页
- 代码示例与说明结合
- 使用对比展示不同场景
- 重要概念使用图表说明

### 技术实现

- 使用 Slidev 的 MDC 语法
- 代码块使用语法高亮
- 流程图使用 Mermaid
- 架构图使用 Mermaid 或 PlantUML

---

## 注意事项

1. **示例代码**: 只展示第一个示例(01-single-approval)的完整代码,其他示例只列出标题和描述,指引用户到代码仓库查看

2. **代码仓库链接**: 在"其他示例概览"页面提供清晰的仓库链接和示例目录路径

3. **架构图**: 使用 Mermaid 绘制清晰的架构图和流程图

4. **状态转换图**: 使用 Mermaid 状态图展示状态转换规则

5. **代码高亮**: 所有代码示例都要有语法高亮,关键部分使用行高亮

6. **动画效果**: 合理使用动画,避免过度使用影响阅读

7. **响应式设计**: 考虑不同屏幕尺寸的显示效果
