---
title: "架构设计"
description: "Approval Kit 的系统架构和设计理念"
date: 2025-11-19
draft: false
weight: 10
---

## 整体架构

Approval Kit 采用分层架构设计,核心层专注于状态管理和数据流转,通过接口抽象与上层业务系统解耦.

```
┌─────────────────────────────────────────┐
│        业务系统层 (外部实现)              │
│  - 数据持久化                            │
│  - 用户认证授权                          │
│  - API 接口                              │
└─────────────────┬───────────────────────┘
                  │ 接口抽象
┌─────────────────▼───────────────────────┐
│        审批流核心库                        │
│  ┌───────────────────────────────────┐  │
│  │  状态机引擎 (FSM)                  │  │
│  │  - 状态定义                        │  │
│  │  - 状态转换规则                    │  │
│  │  - 状态转换执行                    │  │
│  └───────────────────────────────────┘  │
│  ┌───────────────────────────────────┐  │
│  │  模板管理模块                      │  │
│  │  - 模板定义                        │  │
│  │  - 版本控制                        │  │
│  │  - 模板验证                        │  │
│  └───────────────────────────────────┘  │
│  ┌───────────────────────────────────┐  │
│  │  任务管理模块                      │  │
│  │  - 任务创建                        │  │
│  │  - 任务查询                        │  │
│  │  - 任务操作                        │  │
│  └───────────────────────────────────┘  │
│  ┌───────────────────────────────────┐  │
│  │  节点执行引擎                      │  │
│  │  - 节点激活                        │  │
│  │  - 节点执行                        │  │
│  │  - 上下文管理                      │  │
│  └───────────────────────────────────┘  │
│  ┌───────────────────────────────────┐  │
│  │  事件通知模块                      │  │
│  │  - 事件生成                        │  │
│  │  - 异步推送                        │  │
│  │  - 重试机制                        │  │
│  └───────────────────────────────────┘  │
└─────────────────────────────────────────┘
```

## 核心设计原则

### 1. 业务无关性

本库必须保持业务无关,仅负责维护审批数据和状态流转.禁止包含任何具体业务逻辑、前端界面代码或 API 接口实现.

### 2. 无数据存储

本库不得包含任何数据持久化逻辑.所有数据存储操作必须由上层业务系统负责.

### 3. 状态管理核心

本库的核心职责是管理审批模板和审批任务的状态流转.必须明确定义审批状态机,确保状态转换的合法性和一致性.

### 4. 测试优先

采用测试驱动开发(TDD),严格遵循红-绿-重构循环.测试覆盖率必须达到关键路径 100%,整体覆盖率不低于 80%.

### 5. 简洁设计

遵循 YAGNI 原则,避免过度设计.代码必须简洁明了,优先使用 Go 语言的标准库和惯用法.

## 模块划分

### 模板管理 (template)

负责审批模板的定义、验证和版本管理.

- **Template**: 模板数据结构
- **Node**: 节点定义
- **Edge**: 节点连接关系
- **TemplateManager**: 模板管理接口

### 任务管理 (task)

负责审批任务的创建、查询和操作.

- **Task**: 任务数据结构
- **TaskManager**: 任务管理接口
- **Record**: 审批记录
- **StateChange**: 状态变更历史

### 状态机 (statemachine)

负责任务状态流转的管理.

- **StateMachine**: 状态机接口
- **FSM**: 状态机实现
- **Transitions**: 状态转换规则

### 节点执行 (node)

负责节点的配置和执行.

- **NodeExecutor**: 节点执行器接口
- **ApprovalNodeExecutor**: 审批节点执行器
- **ConditionNodeExecutor**: 条件节点执行器
- **ApproverConfig**: 审批人配置接口

### 事件通知 (event)

负责事件生成和推送.

- **EventNotifier**: 事件通知器
- **EventHandler**: 事件处理器接口
- **WebhookHandler**: Webhook 处理器

## 并发安全

使用读写锁(`sync.RWMutex`)保护任务状态,支持并发读取,串行化写入.

状态转换使用版本号机制确保原子性,防止并发修改冲突.

## 扩展性设计

通过接口抽象支持功能扩展:

- **HTTPClient**: HTTP 客户端接口,支持自定义实现
- **ConditionEvaluator**: 条件评估接口,支持自定义条件类型
- **EventHandler**: 事件处理器接口,支持自定义事件处理

## 依赖管理

优先使用 Go 标准库,最小化外部依赖.所有依赖必须经过充分论证.

当前依赖:
- Go 标准库: `encoding/json`, `net/http`, `sync`, `time`, `context`

