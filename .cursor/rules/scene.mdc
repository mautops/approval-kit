---
alwaysApply: false
---

# 场景开发指导提示词

## 目标

为 Approval Kit 的每个使用场景创建可运行的示例代码,帮助开发者理解如何使用本库构建审批流程.

## 开发原则

1. **代码可运行**: 每个场景的代码必须是完整的、可以直接运行的 Go 程序
2. **代码简洁**: 遵循 YAGNI 原则,只实现场景必需的功能,避免过度设计
3. **文档完整**: README.md 必须包含清晰的说明,包括如何执行和验证
4. **业务无关**: 代码只展示库的使用方法,不包含具体业务逻辑实现
5. **示例清晰**: 代码应该易于理解,包含必要的注释

## 目录结构

每个场景目录应包含以下文件:

```
examples/XX-scene-name/
├── main.go          # 主程序文件,包含完整的可运行代码
└── README.md         # 说明文档,包含场景描述、执行方法、验证步骤
```

## 代码实现规范

### 1. 基本结构

每个 `main.go` 文件应包含以下基本结构:

```go
package main

import (
    "encoding/json"
    "fmt"
    "log"

    "github.com/mautops/approval-kit/internal/node"
    "github.com/mautops/approval-kit/internal/task"
    "github.com/mautops/approval-kit/internal/template"
    "github.com/mautops/approval-kit/internal/types"
)

func main() {
    // 1. 创建管理器
    templateMgr := template.NewTemplateManager()
    taskMgr := task.NewTaskManager(templateMgr, nil)

    // 2. 创建模板
    tpl := createTemplate()
    err := templateMgr.Create(tpl)
    if err != nil {
        log.Fatalf("Failed to create template: %v", err)
    }

    // 3. 创建任务
    params := json.RawMessage(`{}`) // 根据场景设置参数
    tsk, err := taskMgr.Create(tpl.ID, "business-001", params)
    if err != nil {
        log.Fatalf("Failed to create task: %v", err)
    }

    // 4. 执行场景特定的流程
    runScenario(taskMgr, tsk)

    // 5. 输出结果
    printResults(taskMgr, tsk)
}

func createTemplate() *template.Template {
    // 根据场景创建模板
}

func runScenario(taskMgr task.TaskManager, tsk *task.Task) {
    // 实现场景特定的流程
}

func printResults(taskMgr task.TaskManager, tsk *task.Task) {
    // 输出任务状态、审批记录等结果
}
```

### 2. 模板创建规范

创建模板时需要注意:

- **必须包含开始节点**: 每个模板必须有一个 ID 为 "start" 的开始节点
- **必须包含结束节点**: 每个模板必须有一个 ID 为 "end" 的结束节点
- **节点连接**: 使用 Edges 定义节点间的连接关系
- **节点配置**: 审批节点需要配置 ApprovalNodeConfig,包含审批模式和审批人配置
- **条件节点**: 条件节点需要配置 ConditionNodeConfig,包含条件类型和条件配置

示例:

```go
func createTemplate() *template.Template {
    return &template.Template{
        ID:          "tpl-001",
        Name:        "Example Template",
        Description: "Example template description",
        Version:     1,
        CreatedAt:   time.Now(),
        UpdatedAt:   time.Now(),
        Nodes: map[string]*template.Node{
            "start": {
                ID:   "start",
                Name: "Start",
                Type: template.NodeTypeStart,
            },
            "approval-001": {
                ID:   "approval-001",
                Name: "Approval Node",
                Type: template.NodeTypeApproval,
                Config: &node.ApprovalNodeConfig{
                    Mode: node.ApprovalModeSingle,
                    ApproverConfig: &node.FixedApproverConfig{
                        Approvers: []string{"user-001"},
                    },
                },
            },
            "end": {
                ID:   "end",
                Name: "End",
                Type: template.NodeTypeEnd,
            },
        },
        Edges: []*template.Edge{
            {From: "start", To: "approval-001"},
            {From: "approval-001", To: "end"},
        },
    }
}
```

### 3. 任务操作规范

任务操作应遵循以下步骤:

1. **创建任务**: 使用 `taskMgr.Create()` 创建任务
2. **提交任务**: 使用 `taskMgr.Submit()` 提交任务进入审批流程
3. **审批操作**: 使用 `taskMgr.Approve()` 或 `taskMgr.Reject()` 执行审批
4. **查询任务**: 使用 `taskMgr.Get()` 获取任务最新状态
5. **查询记录**: 从任务对象的 `Records` 字段获取审批记录

### 4. 输出规范

代码应输出以下信息:

- 任务创建成功信息
- 任务提交成功信息
- 每次审批操作的结果
- 任务最终状态
- 审批记录列表
- 状态变更历史(如适用)

使用 `fmt.Printf` 输出,格式清晰易读.

## README.md 编写规范

每个场景的 README.md 必须包含以下内容:

### 1. 场景标题和描述

```markdown
# 场景 X: [场景名称]

## 场景描述

[详细描述场景的业务背景和流程]
```

### 2. 流程结构

```markdown
## 流程结构

[使用文本或 ASCII 图描述流程结构]
```

### 3. 关键特性

```markdown
## 关键特性

- [特性 1]
- [特性 2]
- [特性 3]
```

### 4. 代码说明

```markdown
## 代码说明

[说明代码的主要组成部分和实现逻辑]
```

### 5. 执行方法

````markdown
## 执行方法

### 前置要求

- Go 1.25.4 或更高版本
- 已安装 approval-kit 依赖

### 执行步骤

1. 进入场景目录:
   ```bash
   cd examples/XX-scene-name
   ```
````

2. 运行程序:
   ```bash
   go run main.go
   ```

### 预期输出

[描述程序运行后的预期输出内容]

````

### 6. 验证步骤

```markdown
## 验证步骤

1. [验证步骤1]
2. [验证步骤2]
3. [验证步骤3]

### 验证要点

- [要点1]
- [要点2]
- [要点3]
````

### 7. 适用场景

```markdown
## 适用场景

[说明该场景适用于哪些实际业务场景]
```

## 场景特定要求

### 场景 1-5: 基础场景

- 重点展示基本的模板创建和任务操作
- 代码应简洁明了,易于理解
- 输出应清晰展示状态流转过程

### 场景 6-15: 中级场景

- 展示复杂的审批模式和条件判断
- 包含详细的注释说明复杂逻辑
- 输出应展示多步骤的审批过程

### 场景 16-25: 高级场景

- 展示高级特性和复杂组合
- 代码可以更复杂,但必须清晰
- 输出应展示完整的功能演示

## 特殊场景处理

### 动态审批人场景

如果场景涉及动态审批人,需要:

1. 创建 Mock HTTP 客户端实现 `node.HTTPClient` 接口
2. 在代码中演示如何配置动态审批人
3. 说明如何模拟 API 调用

示例:

```go
type mockHTTPClient struct {
    response *http.Response
    err      error
}

func (m *mockHTTPClient) Do(req *http.Request) (*http.Response, error) {
    return m.response, m.err
}

// 在创建模板时使用
approverConfig := &node.DynamicApproverConfig{
    API: &node.HTTPAPIConfig{
        URL:    "http://example.com/api/approvers",
        Method: "POST",
        // ... 其他配置
    },
    Timing:     node.ApproverTimingOnActivate,
    HTTPClient: &mockHTTPClient{...},
}
```

### 事件通知场景

如果场景涉及事件通知,需要:

1. 创建事件处理器实现 `event.EventHandler` 接口
2. 在代码中演示如何注册事件处理器
3. 输出事件通知的内容

### 并发安全场景

如果场景涉及并发,需要:

1. 使用 goroutine 模拟并发操作
2. 演示并发安全机制
3. 输出并发操作的结果

## 代码质量要求

1. **错误处理**: 所有可能失败的操作必须检查错误
2. **代码注释**: 关键步骤必须有注释说明
3. **变量命名**: 使用清晰的变量名,遵循 Go 命名规范
4. **代码格式**: 使用 `gofmt` 格式化代码
5. **导入规范**: 按标准库、第三方库、项目内部库的顺序组织导入

## 禁止事项

1. **禁止编写测试代码**: 场景代码是示例代码,不是测试代码
2. **禁止使用 panic**: 使用错误处理,不要使用 panic
3. **禁止硬编码敏感信息**: 如密码、密钥等
4. **禁止包含业务逻辑**: 只展示库的使用方法
5. **禁止过度设计**: 保持代码简洁,只实现场景必需的功能

## 开发流程

1. **理解场景**: 仔细阅读场景描述,理解需要展示的功能
2. **设计流程**: 设计代码结构和执行流程
3. **编写代码**: 按照规范编写可运行的代码
4. **编写文档**: 编写完整的 README.md
5. **验证运行**: 确保代码可以正常运行并输出预期结果
6. **检查规范**: 检查代码是否符合所有规范要求

## 示例检查清单

在完成场景开发后,检查以下项目:

- [ ] 代码可以正常运行
- [ ] 代码输出清晰易读
- [ ] README.md 包含所有必需章节
- [ ] 执行方法说明清晰
- [ ] 验证步骤完整
- [ ] 代码符合 Go 规范
- [ ] 错误处理完整
- [ ] 注释清晰适当
- [ ] 没有硬编码敏感信息
- [ ] 没有包含业务逻辑

## 注意事项

1. **依赖管理**: 确保代码使用的包都来自 `github.com/mautops/approval-kit`
2. **版本兼容**: 确保代码与当前库版本兼容
3. **内存管理**: 本库使用内存存储,重启后数据会丢失(这是正常的)
4. **并发安全**: 库本身是并发安全的,但示例代码中要注意并发使用方式

## 参考资源

- 项目 Constitution: `.cursor/rules/constitution.mdc`
- 功能需求文档: `.cursor/rules/prd.mdc`
- 测试代码示例: `tests/` 目录
- 场景列表: `examples/readme.md`

## 开发顺序

1. 先开发场景代码
2. 运行场景代码，获取代码输出
3. 开发提示词，把代码输出更新到提示词中
