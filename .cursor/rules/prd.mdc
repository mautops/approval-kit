---
alwaysApply: true
---

# 审批流核心库功能需求

## 项目定位

开发一个审批流核心库,专注于管理审批模板和审批任务的状态流转.该库设计为业务无关组件,仅负责维护审批数据和状态流转,不涉及具体业务逻辑、前端界面和 API 接口.后续的审批系统将基于此库进行架构和扩展.

## 核心功能需求

### 1. 审批模板管理

系统必须支持创建、更新、删除和查询审批模板.审批模板定义完整的审批流程结构,包括模板基本信息(模板 ID、名称、描述、版本号、创建时间、更新时间)、审批节点列表、节点连接关系、全局配置(Webhook 配置、超时配置等).模板以结构化数据形式存储,支持模板版本控制,确保历史审批任务可追溯.

### 2. 审批节点配置

系统必须支持配置多种类型的审批节点,包括开始节点、审批节点、条件节点、结束节点等.每个节点包含节点 ID、节点名称、节点类型、节点顺序等基本信息.

开始节点用于标识审批流程的起点,每个审批模板必须且只能有一个开始节点.开始节点通常自动执行,支持配置流程启动参数(是否允许暂存、是否允许撤回、启动条件检查、启动时的事件通知).

系统必须支持以下审批模式:

- 单人审批: 单个审批人进行审批,审批人同意/拒绝后流程继续
- 多人会签: 多个审批人需全部同意,所有审批人同意后流程继续;任一审批人拒绝时,根据配置决定流程走向(流程终止、跳转到上一节点、跳转到指定节点)
- 多人或签: 多个审批人中任意一人同意即可,第一个审批人同意后流程继续;所有审批人拒绝后,根据配置决定流程走向(流程终止、跳转到上一节点、跳转到指定节点)
- 比例会签: 多个审批人中达到指定比例同意即可(例如 5 人中 3 人同意即可通过)
- 顺序审批: 多个审批人按顺序依次审批,前一个审批人同意后下一个审批人才能审批

系统必须支持两种审批人配置方式:

- 固定审批人: 在模板中预设审批人列表,审批人必须是用户 ID,必须具体到人,不能是角色、部门等标识
- 动态审批人: 通过用户配置的 HTTP API 动态获取审批人列表.支持配置 API 地址、请求方法、请求头等.API 请求参数从流程上下文中获取(任务参数、节点输出数据),支持配置参数映射规则和响应数据解析规则.支持配置获取时机(任务创建时或节点激活时),默认值为节点激活时.API 调用失败时需要有重试机制和错误处理

系统必须支持节点其他配置:

- 超时设置: 支持配置节点审批超时时间,超时后自动处理或通知(默认不配置超时时间)
- 拒绝后跳转: 支持配置拒绝后跳转(跳转到上一节点或指定节点),默认行为是审批被拒绝后任务状态变为已拒绝流程结束
- 操作权限控制: 控制节点允许的运行时操作(转交审批、加签、减签等),不同节点可以配置不同的操作权限
- 审批意见: 是否必填审批意见
- 附件要求: 是否要求上传附件

系统必须支持节点间数据传递:

- 每个节点执行时自动提供上下文信息(任务参数、节点输出数据、当前节点状态)
- 节点可以输出数据供后续节点使用(JSON 格式,保持业务无关)
- 支持通过上下文查询前面节点的输出数据,支持缓存机制避免重复查询

### 3. 条件审批

系统必须支持在审批流程中设置条件节点,根据条件结果决定流程走向.支持多种条件类型(数值比较、字符串匹配、枚举判断、自定义函数、组合条件).条件数据源包括审批任务数据、节点上下文数据、外部数据(由业务系统提供).条件满足时跳转到指定节点,条件不满足时跳转到另一指定节点,支持默认路径配置.

### 4. 审批任务管理

系统必须支持基于模板创建审批任务实例,初始化任务状态、当前节点、审批人列表等.对于配置为"任务创建时"获取的动态审批人节点,在任务创建时立即调用 API 获取审批人列表.支持关联外部业务数据(通过业务 ID),支持传入任务参数用于条件判断和动态审批人获取.

系统必须支持以下审批任务状态:

- 待审批: 任务已创建,等待审批
- 已提交: 任务已提交进入审批流程
- 审批中: 任务正在审批流程中
- 已通过: 任务审批通过
- 已拒绝: 任务审批被拒绝
- 已取消: 任务被取消
- 已超时: 任务审批超时

系统必须支持状态流转,包括定义合法的状态转换路径和条件、记录每次状态变更的时间、操作人、原因等.支持在审批被拒绝后跳转到上一节点或指定节点继续审批流程(根据节点配置).支持在特定条件下回滚状态.

系统必须支持多种任务查询方式:

- 按 ID 查询任务详情
- 按状态查询任务列表
- 按模板查询相关任务
- 按业务数据查询任务(根据关联的业务 ID)
- 按审批人查询待审批任务
- 按时间范围查询(根据创建时间、更新时间等)

系统必须支持以下任务操作:

- 提交审批: 提交任务进入审批流程
- 审批操作: 审批人进行同意/拒绝操作
- 拒绝后处理: 当审批被拒绝时,根据节点配置决定流程走向(如果配置了拒绝后跳转,流程跳转到指定节点继续审批;如果未配置拒绝后跳转,任务状态变为已拒绝流程结束)
- 撤回任务: 在特定条件下允许撤回任务
- 转交审批: 审批人可以将任务转交给其他审批人(需节点配置允许)
- 加签: 在审批过程中添加额外的审批人(需节点配置允许)
- 减签: 移除部分审批人(需节点配置允许且权限控制)

### 5. 审批记录生成

系统必须在每次审批操作时自动生成审批记录数据,作为状态流转的副产品.审批记录包含记录 ID、任务 ID、节点 ID、审批人、审批结果(同意、拒绝、转交等)、审批意见、审批时间、附件信息等.审批记录数据存储在任务对象的内存中,不进行持久化存储.

系统必须提供访问审批记录的接口,支持通过任务对象查询该任务的所有审批记录.审批记录数据以结构化格式提供,便于业务系统获取后进行持久化存储、查询和统计分析.

### 6. 事件通知

系统必须支持在审批模板中配置 Webhook 地址,支持配置多个 Webhook 地址,支持配置认证信息(如 Token、签名等).所有事件推送都会包含当前审批节点信息,由 Webhook API 自主决定关注哪个节点的事件.

系统必须支持以下事件类型:

- 任务创建: 审批任务创建时触发
- 任务提交: 任务提交审批时触发
- 节点激活: 审批节点激活时触发
- 审批操作: 审批人执行审批操作时触发
- 任务通过: 任务审批通过时触发
- 任务拒绝: 任务审批被拒绝时触发
- 任务超时: 任务审批超时时触发
- 任务取消: 任务被取消时触发
- 节点完成: 审批节点完成时触发

事件推送必须包含以下数据:

- 事件类型、事件时间
- 任务信息: 审批任务的基本信息
- 节点信息: 当前审批节点信息(包括节点 ID、节点名称、节点类型等,所有事件都包含)
- 审批信息: 审批操作信息(如适用)
- 业务数据: 关联的业务数据 ID 和关键信息

系统必须采用异步推送方式,不阻塞主流程,保证审批操作的响应性能.推送失败时自动重试,记录推送失败的事件支持手动重试,确保事件推送的幂等性.

## 非功能需求

### 性能要求

系统必须支持高并发的审批任务创建和状态更新,审批操作响应时间应满足业务需求,支持处理大量审批操作,支持高效的数据查询操作.

### 可扩展性

系统必须支持扩展审批模式和审批人获取方式,提供清晰的扩展接口,支持通过配置驱动功能,采用模块化设计便于功能扩展.

### 可靠性

系统必须确保状态流转的正确性和一致性,提供完善的异常处理机制,支持从错误状态恢复,详细记录操作日志便于问题排查.

### 安全性

系统必须支持敏感数据加密处理,通过接口抽象支持权限控制(由上层业务系统实现),支持多租户数据隔离,记录关键操作的审计日志.

### 可维护性

系统必须确保代码质量和规范性,提供完善的开发文档和使用文档,提供充分的测试用例,代码结构清晰便于维护和升级.

### 兼容性

系统必须考虑向后兼容性,保持核心接口的稳定性,支持平滑升级和迁移.
