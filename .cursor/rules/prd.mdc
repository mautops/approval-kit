---
alwaysApply: true
---

# 审批流核心库功能需求

## 项目定位

开发一个审批流核心库,专注于管理审批模板和审批任务的状态流转.该库设计为业务无关组件,仅负责维护审批数据和状态流转,不涉及具体业务逻辑、前端界面和 API 接口.后续的审批系统将基于此库进行架构和扩展.

## 核心功能需求

### 1. 审批模板管理

系统必须支持创建、更新、删除和查询审批模板.审批模板定义完整的审批流程结构,包括模板基本信息(模板 ID、名称、描述、版本号、创建时间、更新时间)、审批节点列表、节点连接关系、全局配置(Webhook 配置、超时配置等).模板以结构化数据形式存储,支持模板版本控制,确保历史审批任务可追溯.

系统必须支持以下模板管理功能:

- **模板导入导出**: 支持模板的 JSON 格式导入导出,便于模板的迁移、备份和分享
- **模板复制/克隆**: 支持基于现有模板创建新模板,快速复用已有模板结构
- **模板版本对比**: 支持对比不同版本的模板差异,识别节点、边、配置等变更
- **模板验证增强**: 支持检测死循环、不可达节点、孤立节点等流程问题,确保模板结构正确

### 2. 审批节点配置

系统必须支持配置多种类型的审批节点,包括开始节点、审批节点、条件节点、结束节点等.每个节点包含节点 ID、节点名称、节点类型、节点顺序等基本信息.

开始节点用于标识审批流程的起点,每个审批模板必须且只能有一个开始节点.开始节点通常自动执行,支持配置流程启动参数(是否允许暂存、是否允许撤回、启动条件检查、启动时的事件通知).

系统必须支持以下审批模式:

- 单人审批: 单个审批人进行审批,审批人同意/拒绝后流程继续
- 多人会签: 多个审批人需全部同意,所有审批人同意后流程继续;任一审批人拒绝时,根据配置决定流程走向(流程终止、跳转到上一节点、跳转到指定节点)
- 多人或签: 多个审批人中任意一人同意即可,第一个审批人同意后流程继续;所有审批人拒绝后,根据配置决定流程走向(流程终止、跳转到上一节点、跳转到指定节点)
- 比例会签: 多个审批人中达到指定比例同意即可(例如 5 人中 3 人同意即可通过)
- 顺序审批: 多个审批人按顺序依次审批,前一个审批人同意后下一个审批人才能审批

系统必须支持两种审批人配置方式:

- 固定审批人: 在模板中预设审批人列表,审批人必须是用户 ID,必须具体到人,不能是角色、部门等标识
- 动态审批人: 通过用户配置的 HTTP API 动态获取审批人列表.支持配置 API 地址、请求方法、请求头等.API 请求参数从流程上下文中获取(任务参数、节点输出数据),支持配置参数映射规则和响应数据解析规则.支持配置获取时机(任务创建时或节点激活时),默认值为节点激活时.API 调用失败时需要有重试机制和错误处理

系统必须支持节点其他配置:

- 超时设置: 支持配置节点审批超时时间,超时后自动处理或通知(默认不配置超时时间)
- 超时默认同意: 支持配置超时后的默认行为,包括超时默认同意、超时默认拒绝、超时通知等选项,提高审批效率,减少流程阻塞
- 拒绝后跳转: 支持配置拒绝后跳转(跳转到上一节点或指定节点),默认行为是审批被拒绝后任务状态变为已拒绝流程结束
- 操作权限控制: 控制节点允许的运行时操作(转交审批、加签、减签等),不同节点可以配置不同的操作权限
- 审批意见: 是否必填审批意见
- 附件要求: 是否要求上传附件
- 审批人代理: 支持配置审批人代理机制,当审批人不可用时,自动由代理审批人处理

系统必须支持节点间数据传递:

- 每个节点执行时自动提供上下文信息(任务参数、节点输出数据、当前节点状态)
- 节点可以输出数据供后续节点使用(JSON 格式,保持业务无关)
- 支持通过上下文查询前面节点的输出数据,支持缓存机制避免重复查询

### 3. 条件审批

系统必须支持在审批流程中设置条件节点,根据条件结果决定流程走向.支持多种条件类型(数值比较、字符串匹配、枚举判断、自定义函数、组合条件).条件数据源包括审批任务数据、节点上下文数据、外部数据(由业务系统提供).条件满足时跳转到指定节点,条件不满足时跳转到另一指定节点,支持默认路径配置.

### 3.1 并行网关和汇聚网关

系统必须支持并行网关和汇聚网关节点类型,实现真正的并行审批路径和路径汇聚:

- **并行网关**: 支持将流程分为多个并行分支,所有分支同时执行,互不干扰
- **汇聚网关**: 支持将多个并行分支汇聚到一个节点,所有分支完成后才继续执行
- **并行审批场景**: 支持多个部门或角色同时进行审批,提高审批效率
- **汇聚策略**: 支持配置汇聚策略,包括全部完成、任意完成、比例完成等

### 3.2 流程分析和验证

系统必须支持审批流程的分析和验证功能,确保流程设计的正确性和完整性:

- **流程验证**: 支持检测死循环、不可达节点、孤立节点、缺少结束节点等流程问题
- **审批链分析**: 支持分析审批路径,包括最长路径、最短路径、所有可能路径等
- **节点可达性分析**: 支持检查节点是否可达,识别无法到达的节点
- **流程完整性检查**: 支持检查流程是否完整,确保所有节点都有明确的流转路径
- **流程模拟**: 支持模拟审批流程执行,验证流程逻辑的正确性,无需创建实际任务
- **审批路径预览**: 支持预览所有可能的审批路径,帮助理解流程结构

### 4. 审批任务管理

系统必须支持基于模板创建审批任务实例,初始化任务状态、当前节点、审批人列表等.对于配置为"任务创建时"获取的动态审批人节点,在任务创建时立即调用 API 获取审批人列表.支持关联外部业务数据(通过业务 ID),支持传入任务参数用于条件判断和动态审批人获取.

系统必须支持以下审批任务状态:

- 待审批: 任务已创建,等待审批
- 已提交: 任务已提交进入审批流程
- 审批中: 任务正在审批流程中
- 已通过: 任务审批通过
- 已拒绝: 任务审批被拒绝
- 已取消: 任务被取消
- 已超时: 任务审批超时
- 已暂停: 任务被暂停,可以稍后恢复(用于需要临时中断审批流程的场景)

系统必须支持状态流转,包括定义合法的状态转换路径和条件、记录每次状态变更的时间、操作人、原因等.支持在审批被拒绝后跳转到上一节点或指定节点继续审批流程(根据节点配置).支持在特定条件下回滚状态.

系统必须支持多种任务查询方式:

- 按 ID 查询任务详情
- 按状态查询任务列表
- 按模板查询相关任务
- 按业务数据查询任务(根据关联的业务 ID)
- 按审批人查询待审批任务
- 按时间范围查询(根据创建时间、更新时间等)
- 组合查询: 支持多条件组合查询,如按状态+模板+时间范围等组合查询
- 审批链预览: 支持在创建任务前预览完整的审批链,包括所有审批节点和审批人信息
- 审批路径分析: 支持分析任务的审批路径,包括已完成的路径、当前路径、可能的后续路径等
- 审批时间预估: 支持基于历史数据预估审批完成时间,帮助用户了解审批进度

系统必须支持以下任务操作,所有操作必须通过 `TaskManager` 接口提供:

- 提交审批: 提交任务进入审批流程 (`Submit` 方法)
- 审批操作: 审批人进行同意/拒绝操作 (`Approve`、`Reject` 方法,支持附件)
- 拒绝后处理: 当审批被拒绝时,根据节点配置决定流程走向(如果配置了拒绝后跳转,流程跳转到指定节点继续审批;如果未配置拒绝后跳转,任务状态变为已拒绝流程结束)
- 撤回任务: 在特定条件下允许撤回任务 (`Withdraw` 方法)
- 转交审批: 审批人可以将任务转交给其他审批人(需节点配置允许) (`Transfer` 方法)
- 加签: 在审批过程中添加额外的审批人(需节点配置允许) (`AddApprover` 方法)
- 减签: 移除部分审批人(需节点配置允许且权限控制) (`RemoveApprover` 方法)
- 暂停任务: 支持暂停审批任务,暂停后任务状态变为已暂停,可以稍后恢复 (`Pause` 方法)
- 恢复任务: 支持恢复已暂停的审批任务,恢复到暂停前的状态继续审批 (`Resume` 方法)
- 回退到指定节点: 支持将任务回退到流程中的任意已完成的节点,用于需要重新审批的场景 (`RollbackToNode` 方法)
- 替换审批人: 支持在审批过程中替换审批人,替换后原审批人的审批记录保留,新审批人继续审批 (`ReplaceApprover` 方法)
- 取消任务: 支持取消任务 (`Cancel` 方法)
- 超时处理: 支持处理任务超时 (`HandleTimeout` 方法)

### 5. 审批记录生成

系统必须在每次审批操作时自动生成审批记录数据,作为状态流转的副产品.审批记录包含记录 ID、任务 ID、节点 ID、审批人、审批结果(同意、拒绝、转交等)、审批意见、审批时间、附件信息等.审批记录数据存储在任务对象的内存中,不进行持久化存储.

系统必须提供访问审批记录的接口,支持通过任务对象查询该任务的所有审批记录.审批记录数据以结构化格式提供,便于业务系统获取后进行持久化存储、查询和统计分析.

系统必须支持审批记录的统计分析功能:

- **审批记录查询**: 支持按节点、审批人、时间范围等条件查询审批记录
- **审批统计分析**: 支持统计审批通过率、平均审批时间、审批人工作量等指标
- **审批趋势分析**: 支持分析审批趋势,识别审批瓶颈和优化点

### 6. 事件通知

系统必须支持在审批模板中配置 Webhook 地址,支持配置多个 Webhook 地址,支持配置认证信息(如 Token、签名等).所有事件推送都会包含当前审批节点信息,由 Webhook API 自主决定关注哪个节点的事件.

系统必须支持以下事件类型:

- 任务创建: 审批任务创建时触发
- 任务提交: 任务提交审批时触发
- 节点激活: 审批节点激活时触发
- 审批操作: 审批人执行审批操作时触发
- 任务通过: 任务审批通过时触发
- 任务拒绝: 任务审批被拒绝时触发
- 任务超时: 任务审批超时时触发
- 任务取消: 任务被取消时触发
- 任务暂停: 任务被暂停时触发
- 任务恢复: 任务被恢复时触发
- 节点完成: 审批节点完成时触发
- 审批提醒: 支持配置审批提醒事件,在审批人待审批时定期发送提醒通知

事件推送必须包含以下数据:

- 事件类型、事件时间
- 任务信息: 审批任务的基本信息
- 节点信息: 当前审批节点信息(包括节点 ID、节点名称、节点类型等,所有事件都包含)
- 审批信息: 审批操作信息(如适用)
- 业务数据: 关联的业务数据 ID 和关键信息

系统必须采用异步推送方式,不阻塞主流程,保证审批操作的响应性能.推送失败时自动重试,记录推送失败的事件支持手动重试,确保事件推送的幂等性.

## 非功能需求

### 性能要求

系统必须支持高并发的审批任务创建和状态更新,审批操作响应时间应满足业务需求,支持处理大量审批操作,支持高效的数据查询操作.

### 可扩展性

系统必须支持扩展审批模式和审批人获取方式,提供清晰的扩展接口,支持通过配置驱动功能,采用模块化设计便于功能扩展.支持通过接口扩展实现自定义审批模式、自定义条件评估器、自定义事件处理器等.

系统必须支持模板和任务的扩展功能:

- **模板扩展字段**: 支持在模板中添加自定义扩展字段,存储业务相关的元数据
- **任务扩展字段**: 支持在任务中添加自定义扩展字段,存储任务相关的业务数据
- **节点扩展配置**: 支持在节点配置中添加自定义扩展配置,支持业务特定的节点行为
- **扩展接口**: 提供清晰的扩展接口,支持业务系统扩展核心库功能

### 可靠性

系统必须确保状态流转的正确性和一致性,提供完善的异常处理机制,支持从错误状态恢复,详细记录操作日志便于问题排查.

### 安全性

系统必须支持敏感数据加密处理,通过接口抽象支持权限控制(由上层业务系统实现),支持多租户数据隔离,记录关键操作的审计日志.

### 可维护性

系统必须确保代码质量和规范性,提供完善的开发文档和使用文档,提供充分的测试用例,代码结构清晰便于维护和升级.

### 兼容性

系统必须考虑向后兼容性,保持核心接口的稳定性,支持平滑升级和迁移.

### 工具和辅助功能

系统必须提供工具和辅助功能,提升开发和使用体验:

- **模板序列化**: 支持模板的序列化和反序列化,便于模板的存储和传输
- **任务快照**: 支持创建任务快照,保存任务在特定时间点的完整状态,便于问题排查和审计
- **流程可视化数据**: 支持生成流程可视化所需的数据结构,便于前端展示审批流程图
- **调试支持**: 支持调试模式,提供详细的执行日志和状态信息,便于问题排查
- **性能分析**: 支持性能分析功能,识别性能瓶颈,优化审批流程执行效率
